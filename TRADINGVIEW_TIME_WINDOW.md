# TradingView 时间窗口显示功能

## ✅ 已完成

图表现在会**自动聚焦到事件发生的时间段**，只显示闪崩前后的K线数据。

## 🎯 功能说明

### 时间窗口计算

当用户点击历史闪崩事件时：

```
事件时间: 2025-10-10 14:00:00
时间范围: 3小时

计算结果:
├─ 事件前: 1.5小时  (12:30 - 14:00)
├─ 事件时: 14:00    ← 闪崩发生
└─ 事件后: 1.5小时  (14:00 - 15:30)

图表显示: 12:30 → 15:30 (3小时窗口)
```

### 可调节窗口大小

| 时间范围 | 事件前 | 事件后 | K线周期 |
|---------|-------|-------|--------|
| 1小时   | 0.5h  | 0.5h  | 15分钟 |
| 3小时   | 1.5h  | 1.5h  | 1小时  |
| 6小时   | 3h    | 3h    | 4小时  |
| 12小时  | 6h    | 6h    | 日线   |
| 24小时  | 12h   | 12h   | 日线   |

## 📊 界面展示

### 事件概览区域
```
┌─────────────────────────────────────────┐
│ BTC/USDT                    -25.22%     │
│ BTC价格在数小时内暴跌25%...              │
│                                         │
│ > Date: 2025-10-10                     │
│ > Time: 14:00                          │ ← 新增：精确时间
│ > Window: 3h                           │
└─────────────────────────────────────────┘
```

### 图表信息
```
> PRICE CHART:           Powered by TradingView

┌─────────────────────────────────────────┐
│                                         │
│    [仅显示事件前后3小时的K线数据]        │
│                                         │
└─────────────────────────────────────────┘

> Asset: BTC/USDT | Event: 2025-10-10 | 
  Showing: 3h window around crash

Timeline: ←1.5h before  ⚠ CRASH  1.5h after→
```

## 🔧 技术实现

### 1. 时间戳计算
```typescript
const eventDate = new Date(selectedEvent.timestamp);
const hoursBeforeEvent = Math.floor(timeRange / 2);
const hoursAfterEvent = timeRange - hoursBeforeEvent;

const fromDate = new Date(eventDate.getTime() - hoursBeforeEvent * 60 * 60 * 1000);
const toDate = new Date(eventDate.getTime() + hoursAfterEvent * 60 * 60 * 1000);

const fromTimestamp = Math.floor(fromDate.getTime() / 1000);
const toTimestamp = Math.floor(toDate.getTime() / 1000);
```

### 2. TradingView API
```typescript
widgetInstanceRef.current = new window.TradingView.widget({
  // ... 其他配置 ...
  onChartReady: function() {
    widgetInstanceRef.current.activeChart().setVisibleRange(
      { from: fromTimestamp, to: toTimestamp },
      { percentRightMargin: 5 }
    );
  }
});
```

### 3. 视觉时间轴
```
Timeline: ←1.5h before  ⚠ CRASH  1.5h after→
         ├──────────┼──────────┤
         事件前      事件时刻    事件后
```

## 📖 使用示例

### 示例1：查看BTC 10月10日闪崩
```
1. 点击左侧 "2025-10-10 BTC/USDT (-25.22%)"
2. 选择时间范围 "3h"
3. 图表显示：
   - 12:30 - 15:30 的K线数据
   - 中心点为 14:00（闪崩时刻）
   - 可以看到闪崩前的价格高点
   - 可以看到闪崩中的快速下跌
   - 可以看到闪崩后的价格反应
```

### 示例2：切换时间窗口
```
选择 "1h":
├─ 图表显示：13:30 - 14:30
└─ 非常聚焦的短期数据

选择 "6h":
├─ 图表显示：11:00 - 17:00
└─ 更广阔的上下文数据

选择 "24h":
├─ 图表显示：前一天 14:00 - 当天 14:00
└─ 完整的一天数据
```

## 🎨 视觉效果

### K线图显示范围
```
完整历史（之前）:
├─────────────────────────────────────┤
2020年 → 事件 → 2025年
用户可以拖动查看任意时期

聚焦窗口（现在）:
    ├───────┤
   事件前 → 事件 → 事件后
自动聚焦到关键时刻
```

### Timeline 标识
```
←1.5h before    ⚠ CRASH    1.5h after→
     ▼             ▼            ▼
   准备期        闪崩时刻      余波期
```

## 💡 设计理念

### 1. **聚焦关键时刻**
- 自动定位到事件发生的时间
- 显示事件前后的上下文
- 避免无关数据干扰

### 2. **对称窗口**
- 事件前后时间基本对称
- 便于对比闪崩前后的市场反应
- 清晰展示价格变化过程

### 3. **可调节性**
- 用户可选择不同时间窗口
- 1小时：极度聚焦
- 24小时：完整上下文

### 4. **视觉清晰**
- Timeline 标识清楚标记时间分布
- 事件时间明确显示
- ⚠ 符号突出闪崩时刻

## 🔍 用户交互

### 仍可使用的功能
- ✅ 缩放：放大查看更细节的K线
- ✅ 拖动：向左右拖动查看窗口外的数据
- ✅ 悬停：查看具体某根K线的详细信息

### 自动功能
- ✅ 自动居中：事件时刻始终在中心区域
- ✅ 自动缩放：根据窗口大小适配K线数量
- ✅ 自动更新：切换时间范围立即更新

## 📊 实际案例

### 2025-10-10 BTC闪崩
```
事件：BTC从$115,000跌至$86,000

3小时窗口显示：
├─ 12:30: BTC = $115,000 (闪崩前高点)
├─ 13:00: 开始小幅波动
├─ 13:30: 出现下跌信号
├─ 14:00: ⚠ 闪崩开始！快速下跌
├─ 14:30: 跌至 $86,000 (最低点)
└─ 15:30: 开始反弹/波动

用户可清楚看到：
✓ 闪崩前的市场状态
✓ 闪崩发生的速度和幅度
✓ 闪崩后的市场反应
```

## 🚀 优势

### 相比显示完整历史：

| 特性 | 完整历史 | 聚焦窗口 |
|------|---------|---------|
| 加载速度 | 慢 | 快 |
| 数据相关性 | 低 | 高 |
| 视觉清晰度 | 差 | 优 |
| 用户理解 | 需手动找 | 立即看到 |
| 分析效率 | 低 | 高 |

---

**✅ 功能完成！** 现在图表会自动聚焦到每个闪崩事件发生的关键时刻！

**刷新页面查看效果**：http://localhost:3000/black-swan









