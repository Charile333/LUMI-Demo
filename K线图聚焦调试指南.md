# 📊 K线图聚焦问题 - 调试指南

## 🔥 最新修复（暴力重试版）

已实施激进的时间范围设置策略，确保K线图能够跳转到事件对应的时间点。

---

## 🧪 测试步骤

### 1. 打开调试控制台
```
按 F12 打开浏览器开发者工具
切换到 "Console" 标签
```

### 2. 访问黑天鹅页面
```
打开: http://localhost:3000/black-swan
或: https://your-domain.com/black-swan
```

### 3. 选择一个历史事件
```
在左侧面板选择任意历史事件，例如：
- LUNA/USDT 2022-05-09（LUNA崩盘）
- BTC/USDT 2020-03-12（312黑色星期四）
- FTT/USDT 2022-11-08（FTX崩盘）
```

### 4. 观察控制台输出

**预期看到的日志：**

```
📊 Chart Setup:
  Symbol: BINANCE:BTCUSDT
  Event Time: 2020-03-12T08:00:00.000Z
  Event Time (Local): 2020/3/12 16:00:00
  ...
  
✅ Chart ready! Now setting time range...
📊 Got active chart

🎯 Force setting time range...
   From: 2020/3/12 14:10:00
   To: 2020/3/12 17:50:00
   Event: 2020/3/12 16:00:00
   Current range: 2025/10/28 12:00:00 to 2025/10/28 18:00:00  ← 当前显示的时间（初始是最新的）
   
✅ [1] Range set successfully!
   ✓ Golden Ratio: Event at 38.2%
   ✓ Interval: 15 | Range: 3h
   ✓ Verified range: 2020/3/12 14:10:00 to 2020/3/12 17:50:00  ← 验证已跳转到正确时间

📊 Data loaded - setting range...
🎯 Force setting time range...
   ...
✅ [2] Range set successfully!
   ...
✅ [3] Range set successfully!
   ...

✅✅✅ Range locked after 3 successful sets!
```

---

## 🔍 判断是否成功

### ✅ 成功的标志

1. **控制台日志**
   ```
   ✅ [1] Range set successfully!
   ✅ [2] Range set successfully!
   ✅ [3] Range set successfully!
   ✅✅✅ Range locked after 3 successful sets!
   ```

2. **K线图视觉**
   - 图表底部显示的日期与事件日期一致
   - 例如选择"2020-03-12"事件，图表底部应显示"2020年3月12日"
   - 鼠标悬停在K线上，弹出的时间应该是2020年3月的

3. **验证日志**
   ```
   ✓ Verified range: 2020/3/12 14:10:00 to 2020/3/12 17:50:00
   ```
   验证的时间范围应该与事件时间接近

### ❌ 失败的标志

1. **控制台错误**
   ```
   ⚠️ setVisibleRange failed: ...
   ❌ Failed to set range after 30 seconds
   💡 Tip: Try selecting a different time range (12h or 24h)
   ```

2. **K线图视觉**
   - 图表底部显示的是当前日期（2025-10-28）而非事件日期
   - 所有事件的K线图看起来都一样

3. **验证日志缺失**
   - 没有看到 `✓ Verified range` 日志
   - 或验证的时间范围与目标不符

---

## 📊 测试不同的时间范围

在选择事件后，点击不同的时间范围按钮：

### 测试 1h
```
1. 选择任意事件
2. 点击 "1h" 按钮
3. 观察控制台：
   - 应该显示 Interval: 5
   - K线图应显示约12根 5分钟K线
```

### 测试 3h
```
1. 选择任意事件
2. 点击 "3h" 按钮
3. 观察控制台：
   - 应该显示 Interval: 15
   - K线图应显示约12根 15分钟K线
```

### 测试 6h
```
1. 选择任意事件
2. 点击 "6h" 按钮
3. 观察控制台：
   - 应该显示 Interval: 30
   - K线图应显示约12根 30分钟K线
```

### 测试 12h 和 24h
```
这两个时间范围通常最稳定，应该肯定能工作
```

---

## 🔧 激进重试策略说明

系统现在使用4种策略同时尝试：

### 策略1: 立即尝试
```
100ms 后立即尝试一次
可能失败（数据未加载），但值得一试
```

### 策略2: 数据加载监听
```
监听 TradingView 的数据加载事件
数据加载完成后立即尝试设置
```

### 策略3: 暴力重试
```
每秒尝试一次，持续20秒
总计20次尝试
确保不会错过任何时机
```

### 策略4: 长期重试
```
每5秒尝试一次
成功3次后自动停止
30秒后强制停止
```

**总尝试次数**：最多约 **30+ 次**  
**总时长**：持续 **30秒**  
**成功率**：预期 **>95%**

---

## 🐛 常见问题排查

### 问题1: 一直显示当前日期

**症状**：
```
所有事件的K线图都显示 2025-10-28
控制台显示：⚠️ setVisibleRange failed
```

**原因**：
- TradingView API 调用失败
- 网络问题导致数据加载慢
- 免费版TradingView有限制

**解决方法**：
```
1. 等待更长时间（最多30秒）
2. 刷新页面重试
3. 尝试选择较近期的事件（2020年后）
4. 尝试较长的时间范围（12h或24h）
```

### 问题2: 控制台没有任何日志

**症状**：
```
选择事件后，控制台一片空白
没有任何 "Chart Setup" 或 "Force setting" 日志
```

**原因**：
- TradingView 脚本加载失败
- 网络连接问题
- 浏览器扩展阻止了脚本

**解决方法**：
```
1. 检查 Network 标签，看是否有请求失败
2. 禁用广告拦截器
3. 尝试无痕模式
4. 清除浏览器缓存
```

### 问题3: Range set successfully 但图表没变化

**症状**：
```
控制台显示：✅ Range set successfully!
但图表依然显示错误的日期
```

**原因**：
- setVisibleRange 返回成功，但实际没生效
- TradingView 的一个已知bug
- 可能需要等待更长时间

**解决方法**：
```
1. 看控制台的 "Verified range" 日志
2. 如果验证失败，等待长期重试（每5秒一次）
3. 手动拖动图表，然后再次点击时间范围按钮
```

### 问题4: 某些事件无法加载

**症状**：
```
特定事件（如2017年前的）无法显示K线
图表一直loading或显示空白
```

**原因**：
- TradingView 没有该时期的数据
- 交易所在那时不存在
- 数据已被删除

**解决方法**：
```
1. 只测试2018年后的事件
2. 使用 BITSTAMP 交易所（自动处理）
3. 接受某些历史事件可能无数据
```

---

## 🎯 最佳测试用例

### 推荐测试这些事件（数据最完整）：

1. **BTC 2020-03-12（312黑色星期四）**
   ```
   - 日期：2020-03-12
   - 数据源：BINANCE
   - 数据质量：优秀
   - 预期结果：完整的崩盘K线
   ```

2. **LUNA 2022-05-09（LUNA死亡螺旋）**
   ```
   - 日期：2022-05-09
   - 数据源：BINANCE
   - 数据质量：优秀
   - 预期结果：惊人的暴跌K线
   ```

3. **BTC 2022-11-09（FTX崩盘）**
   ```
   - 日期：2022-11-09
   - 数据源：BINANCE
   - 数据质量：优秀
   - 预期结果：明显的下跌趋势
   ```

---

## 📝 反馈格式

如果问题依然存在，请提供以下信息：

```
### 环境信息
浏览器：Chrome / Firefox / Safari
版本：______
操作系统：Windows / Mac / Linux

### 复现步骤
1. 选择的事件：LUNA 2022-05-09
2. 选择的时间范围：3h
3. 等待时间：30秒

### 控制台输出
（复制完整的控制台日志）

### 截图
（如果可能，提供截图）

### 观察到的行为
- K线图显示的日期：2025-10-28（错误）
- 控制台显示：⚠️ setVisibleRange failed
- 是否有网络错误：是/否

### 预期行为
- K线图应显示：2022-05-09
```

---

## 💡 技术细节

### 时间范围计算公式

```typescript
// 黄金分割比例
事件前时间 = 调整后时间范围 × 0.382
事件后时间 = 调整后时间范围 × 0.618

// 波动性调整
调整后时间范围 = 基础时间范围 × (1 + min(崩盘幅度/20, 0.5))
```

### 示例计算

```
事件：BTC崩盘 -30%
基础时间范围：3小时

1. 波动性因子 = min(30/20, 0.5) = 0.5
2. 调整后时间范围 = 3 × (1 + 0.5) = 4.5小时
3. 事件前时间 = 4.5 × 0.382 = 1.72小时
4. 事件后时间 = 4.5 × 0.618 = 2.78小时

结果：事件点位于图表的38.2%位置
```

### K线周期选择

```
时间范围 | K线周期 | K线数量 | 效果
---------|---------|---------|------
1h       | 5分钟   | 12根    | 精细
3h       | 15分钟  | 12根    | 标准
6h       | 30分钟  | 12根    | 清晰
12h      | 1小时   | 12根    | 完整
24h      | 1小时   | 24根    | 全景
```

---

## ✅ 成功标准

当你看到这些输出时，说明功能正常：

```
✅ [1] Range set successfully!
✅ [2] Range set successfully!
✅ [3] Range set successfully!
✅✅✅ Range locked after 3 successful sets!
✅ Final status: 3+ successful range sets

并且：
- K线图显示的日期 = 事件日期
- 验证时间范围正确
- K线数量充足（≥12根）
```

---

## 🚀 下一步改进

如果暴力重试依然无法解决问题，可考虑：

1. **方案A: 预加载数据**
   - 在用户选择事件前就开始加载数据
   - 缓存常见事件的数据

2. **方案B: 自定义图表**
   - 不使用TradingView Widget
   - 使用 Lightweight Charts 等更可控的库

3. **方案C: 服务端渲染**
   - 在服务端生成图表图片
   - 前端直接显示图片

4. **方案D: 添加手动刷新按钮**
   - 如果自动跳转失败
   - 用户可以点击按钮手动重试

---

**最后更新**: 2025-10-28  
**版本**: v2.0 (暴力重试版)

