# 历史事件数据源说明

## 📊 数据来源

黑天鹅页面显示的历史闪崩事件来自**两个不同的数据源**：

### 1. 📁 **静态数据**（主要使用）

#### 位置：
- `LUMI/app/api/alerts/real-crash-events/route.ts`（Next.js API路由）
- `LUMI/server.js` 第351-471行（Express服务器）

#### 特点：
- ✅ **硬编码在代码中**，不依赖数据库
- ✅ **10个真实的历史事件**
- ✅ 包含详细的价格和百分比数据
- ✅ 按时间倒序排列

#### 包含的事件：
1. **2025-10-11** - 加密货币闪崩 (-66%)
2. **2022-05-09** - LUNA/UST崩盘 (-99.99%)
3. **2022-11-09** - FTX崩盘 (-17%)
4. **2022-11-08** - FTT代币崩盘 (-80%)
5. **2020-03-12** - COVID黑色星期四 (-50%)
6. **2017-12-17** - 2017-2018熊市 (-84%)
7. **2013-04-10** - Mt. Gox崩盘 (-43%)
8. **2011-06-19** - Mt. Gox闪崩 (-99.9%)

---

### 2. 📦 **数据库数据**（备用）

#### 位置：
- `LUMI/database/alerts.db`（SQLite数据库）
- 包含200+条历史预警记录

#### 特点：
- ✅ 存储在SQLite数据库中
- ✅ 支持实时WebSocket推送
- ✅ 可以通过 `/api/alerts` 端点访问

#### 数据示例：
```json
{
  "id": 199,
  "timestamp": "2025-10-11T02:00:00Z",
  "symbol": "BTCUSDT",
  "message": "闪崩期间触发大规模杠杆清算，162万账户被强制平仓",
  "severity": "critical",
  "details": {
    "liquidation_usd": 19100000000,
    "liquidated_accounts": 1620000,
    "market_impact": "extreme",
    "leverage_cascade": true
  },
  "type": "whale_transfer",
  "created_at": "2025-10-25 18:49:58"
}
```

---

## 🔍 当前使用的数据源

### Next.js API 路由（推荐用于生产）

```typescript
// LUMI/app/api/alerts/real-crash-events/route.ts

import { NextRequest, NextResponse } from 'next/server'

const crashEvents = [
  {
    id: 'crash-1',
    date: '2022-05-12',
    timestamp: '2022-05-12T00:00:00Z',
    asset: 'LUNA/USDT',
    crashPercentage: -99.9,
    duration: '3 days',
    description: 'Terra Luna collapse - algorithmic stablecoin failure',
    details: {
      previous_price: 85.0,
      current_price: 0.0001,
      price_change: -0.999
    }
  },
  // ... 更多事件
]

export async function GET(request: NextRequest) {
  return NextResponse.json({
    success: true,
    data: crashEvents
  })
}
```

### Express 服务器（开发环境）

```javascript
// LUMI/server.js

} else if (req.url === '/api/alerts/real-crash-events') {
  // 返回真实的历史闪崩事件（不依赖数据库）
  const realEvents = [
    {
      id: 'altcoins_2025-10-11',
      date: '2025-10-11',
      asset: 'ALTCOINS',
      crashPercentage: '-66.0',
      // ...
    },
    // ... 更多事件
  ];
  
  res.writeHead(200);
  res.end(JSON.stringify({ success: true, data: realEvents }));
}
```

---

## 📊 数据结构对比

### Next.js API 路由数据结构

```typescript
interface CrashEvent {
  id: string;
  date: string;              // YYYY-MM-DD
  timestamp: string;          // ISO 8601
  asset: string;             // e.g., "LUNA/USDT"
  crashPercentage: number;    // -99.9
  duration: string;          // "3 days"
  description: string;       // 详细描述
  details: {
    previous_price: number;
    current_price: number;
    price_change: number;    // -0.999
  }
}
```

### Express 服务器数据结构

```typescript
interface CrashEvent {
  id: string;
  date: string;
  asset: string;
  crashPercentage: string;    // "-66.0" (字符串)
  duration: string;
  description: string;
  timestamp: string;
  details: {
    previous_price: number;
    current_price: number;
    price_change: number;
  }
}
```

**注意**: Express版本使用**字符串**格式的 `crashPercentage`（如"-66.0"），而Next.js版本使用**数字**（如-66.0）。

---

## 🎯 前端如何获取数据

### 黑天鹅页面

```typescript
// LUMI/app/black-swan/page.tsx

const loadCrashEvents = async () => {
  try {
    // 使用相对路径的 API
    const response = await fetch('/api/alerts/real-crash-events');
    const result = await response.json();
    
    if (result.success && result.data) {
      setCrashEvents(result.data);
      // 自动选择第一个事件
      if (result.data.length > 0 && !selectedEvent) {
        setSelectedEvent(result.data[0]);
      }
    }
  } catch (error) {
    console.error('加载闪崩事件失败:', error);
  }
};
```

---

## 🔄 数据流

```
┌─────────────────────────────────────────────────┐
│  黑天鹅页面 (page.tsx)                           │
│                                                  │
│  useEffect(() => {                              │
│    fetch('/api/alerts/real-crash-events')       │
│  })                                              │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  Next.js API 路由                               │
│  app/api/alerts/real-crash-events/route.ts      │
│                                                  │
│  const crashEvents = [ ... ]                    │
│  return NextResponse.json({ data: crashEvents })│
└─────────────────────────────────────────────────┘

或者（开发环境）

┌─────────────────────────────────────────────────┐
│  Express 服务器                                  │
│  server.js (第351-471行)                        │
│                                                  │
│  else if (req.url === '/api/alerts/real-...') { │
│    const realEvents = [ ... ]                   │
│    res.end(JSON.stringify({ data: realEvents }))│
│  }                                               │
└─────────────────────────────────────────────────┘
```

---

## 📝 如何添加新事件

### 方法1：修改Next.js API路由（推荐）

编辑 `LUMI/app/api/alerts/real-crash-events/route.ts`:

```typescript
const crashEvents = [
  {
    id: 'crash-11',
    date: '2024-12-15',
    timestamp: '2024-12-15T10:00:00Z',
    asset: 'BTC/USDT',
    crashPercentage: -35.5,
    duration: '6 hours',
    description: 'New crash event description',
    details: {
      previous_price: 45000,
      current_price: 29000,
      price_change: -0.355
    }
  },
  // ... 现有事件
]
```

### 方法2：修改Express服务器

编辑 `LUMI/server.js`:

```javascript
const realEvents = [
  {
    id: 'new_event_2024-12-15',
    date: '2024-12-15',
    asset: 'BTC/USDT',
    crashPercentage: '-35.5',
    duration: '6h',
    description: '新的事件描述',
    timestamp: '2024-12-15T10:00:00Z',
    details: {
      previous_price: 45000,
      current_price: 29000,
      price_change: -35.5
    }
  },
  // ... 现有事件
]
```

---

## 🗄️ 数据库结构（用于WebSocket实时推送）

### alerts 表结构

```sql
CREATE TABLE alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  timestamp TEXT NOT NULL,           -- 事件时间 ISO 8601
  symbol TEXT NOT NULL,              -- 交易对 (BTCUSDT, ETHUSDT)
  message TEXT NOT NULL,             -- 预警消息
  severity TEXT,                     -- critical, high, medium
  details TEXT,                      -- JSON格式的详细信息
  type TEXT,                         -- price_jump, whale_transfer, funding_spike
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 查询示例

```sql
-- 获取所有critical级预警
SELECT * FROM alerts 
WHERE severity = 'critical' 
ORDER BY timestamp DESC 
LIMIT 20;

-- 统计按严重程度分类
SELECT severity, COUNT(*) as count 
FROM alerts 
GROUP BY severity;
```

---

## 🎨 前端使用

### 在K线图中显示

```typescript
// 当用户点击事件卡片时
const handleEventClick = (event) => {
  setSelectedEvent(event);
  
  // TradingView图表会自动重新加载
  // 使用事件的时间戳来聚焦K线图
  const eventTimestamp = new Date(event.timestamp).getTime();
  // ...
};
```

### 交易对映射

```typescript
// 从事件asset字段推断交易对
const assetToSymbol = {
  'LUNA/USDT': 'LUNAUSDT',
  'BTC/USDT': 'BTCUSDT',
  'ETH/USDT': 'ETHUSDT',
  'FTT/USDT': 'FTTUSDT',
};

const symbol = assetToSymbol[selectedEvent.asset] || 'BTCUSDT';
```

---

## 📋 总结

| 特性 | Next.js API | Express 服务器 | SQLite 数据库 |
|-----|------------|---------------|--------------|
| **数据结构** | TypeScript 数组 | JavaScript 数组 | SQL 表 |
| **数量** | 10个事件 | 8个事件 | 200+条记录 |
| **实时更新** | ❌ 需要重启 | ❌ 需要重启 | ✅ WebSocket推送 |
| **生产部署** | ✅ 推荐 | ⚠️ 开发用 | ✅ 后端存储 |
| **维护** | 修改代码 | 修改代码 | SQL插入 |
| **数据类型** | `crashPercentage: number` | `crashPercentage: string` | JSON字段 |

---

## 💡 建议

### 当前项目使用

**推荐使用 Next.js API 路由**（`app/api/alerts/real-crash-events/route.ts`），因为：
- ✅ 类型安全（TypeScript）
- ✅ 数据结构清晰一致
- ✅ 适合生产部署
- ✅ 10个精选的真实历史事件

### 如果需要更多事件

可以从数据库 `alerts.db` 中提取：
```bash
# 导出为JSON
sqlite3 database/alerts.db "SELECT * FROM alerts WHERE severity='critical' LIMIT 20;" > events.json
```

然后手动整理后添加到Next.js API路由中。

---

**最后更新**: 2025-10-26  
**数据源**: 静态代码（不依赖数据库）  
**文件位置**: `LUMI/app/api/alerts/real-crash-events/route.ts`



