# 🚀 LUMI 生产环境测试指南

**准备投入测试网测试所有功能！**

---

## ✅ 第一步：清理测试环境（5分钟）

### 1. 清理数据库测试数据

在 **Supabase SQL Editor** 执行：

```sql
-- 清空测试数据（保留表结构和markets生产数据）
TRUNCATE TABLE orderbooks CASCADE;
TRUNCATE TABLE market_states CASCADE;
TRUNCATE TABLE orders CASCADE;

-- 验证清理
SELECT 
  (SELECT count(*) FROM orderbooks) as orderbooks,
  (SELECT count(*) FROM market_states) as market_states,
  (SELECT count(*) FROM orders) as orders,
  (SELECT count(*) FROM markets) as markets;
```

**应该看到**：前3个为0，markets有数据

---

### 2. 删除测试文件（可选）

```powershell
# 删除测试SQL文件
Remove-Item "一键初始化所有测试市场.sql","插入市场ID1测试数据.sql","立即插入市场1数据.sql","强制刷新市场1数据.sql","测试Realtime_数据更新脚本.sql","检查数据是否存在.sql","清理所有测试数据.sql","完全重置-只创建市场1.sql","检查markets主表.sql" -ErrorAction SilentlyContinue

# 删除测试文档
Remove-Item "快速测试Realtime.md","快速修复-市场ID1数据.md","故障排查指南.md","Realtime测试说明.md","REALTIME_测试指南.md","Supabase实时订单簿-快速参考.md","Supabase实时订单簿-测试指南.md" -ErrorAction SilentlyContinue

Write-Host "✅ 测试文件已清理" -ForegroundColor Green
```

---

### 3. 清除浏览器缓存

按 `F12` → Console：
```javascript
localStorage.clear();
sessionStorage.clear();
location.reload();
```

---

## 🎯 第二步：确认集成状态

### ✅ 已集成的官方组件

| 组件 | 地址 | 状态 |
|------|------|------|
| **UMA预言机** | 0x263351499f82C107e540B01F0Ca959843e22464a | ✅ 官方 |
| **CTF Exchange** | 0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40 | ✅ 官方 |
| **Conditional Tokens** | 0xb171BBc6b1476ee1b6aD4Ac2cA7ed4AfFdFa10a2 | ✅ 官方 |
| **RealUmaCTFAdapter** | 0xaBf0e29946C63fa1920E00bEA95dDADeF70FD80C | ✅ 已部署 |
| **Mock USDC** | 0x8d2dae90Dbc51dF7E18C1b857544AC979F87a77a | ✅ 测试用 |

### ✅ 已集成的功能

- ✅ 市场创建（UMA预言机）
- ✅ 订单簿交易（CTF Exchange）
- ✅ 实时订单更新（Supabase Realtime）
- ✅ 市场激活流程
- ✅ 黑天鹅预警系统
- ✅ 多语言支持
- ✅ 钱包连接

---

## 🧪 第三步：完整功能测试清单

### 准备工作

1. **启动开发服务器**
```bash
npm run dev
```

2. **准备钱包**
- 安装 MetaMask
- 切换到 Polygon Amoy 测试网
- 获取测试币：https://faucet.polygon.technology/

3. **连接钱包**
- 访问 http://localhost:3000
- 点击右上角"连接钱包"

---

### 测试 1️⃣：浏览市场功能

**页面**：`http://localhost:3000`

#### 测试项目：
- [ ] 首页市场列表正常显示
- [ ] 市场卡片显示完整（标题、描述、概率）
- [ ] 点击市场卡片能跳转到详情页
- [ ] 分类筛选正常工作
- [ ] 搜索功能正常

**预期**：
- ✅ 显示所有markets表中的市场
- ✅ 界面美观，响应式布局
- ✅ 无控制台错误

---

### 测试 2️⃣：市场详情页

**页面**：`http://localhost:3000/market/[marketId]`

#### 测试项目：
- [ ] 市场详情正确显示
- [ ] 概率显示正确
- [ ] 结束时间显示
- [ ] "我感兴趣"按钮正常
- [ ] K线图显示（如果有历史数据）
- [ ] 相关市场推荐

**预期**：
- ✅ 所有市场信息完整展示
- ✅ 按钮交互正常
- ✅ 实时数据更新

---

### 测试 3️⃣：市场激活流程

**页面**：市场详情页（未激活市场）

#### 测试项目：
- [ ] 点击"我感兴趣"按钮
- [ ] 感兴趣人数增加
- [ ] 达到阈值（10人）后状态变为"激活中"
- [ ] 检查 market_states 表更新
- [ ] 市场激活后显示"交易"按钮

**测试步骤**：
```sql
-- 在Supabase查看状态
SELECT * FROM market_states WHERE market_id = 1;

-- 手动增加感兴趣人数（测试用）
UPDATE market_states 
SET interested_count = 10, status = 'activating'
WHERE market_id = 1;
```

**预期**：
- ✅ 实时状态更新（Realtime）
- ✅ UI显示正确的激活进度
- ✅ 达到阈值后触发区块链激活

---

### 测试 4️⃣：区块链市场创建

**页面**：`http://localhost:3000/blockchain-markets`

#### 测试项目：
- [ ] 从链上读取市场列表
- [ ] 显示已部署的区块链市场
- [ ] 市场信息正确（通过RealUmaCTFAdapter）
- [ ] 合约地址显示正确

**验证合约地址**：
- 应该显示：`0xaBf0e29946C63fa1920E00bEA95dDADeF70FD80C`（适配器）
- CTF Exchange：`0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40`

**预期**：
- ✅ 正确读取链上数据
- ✅ 显示官方组件地址
- ✅ 无RPC错误

---

### 测试 5️⃣：订单簿交易

**页面**：`http://localhost:3000/trade/[marketId]`

#### 测试项目：

**5.1 查看订单簿**
- [ ] 买单列表显示
- [ ] 卖单列表显示
- [ ] 价格正确排序
- [ ] 中间价计算正确

**5.2 创建订单**
- [ ] 连接钱包
- [ ] 授权 Mock USDC
- [ ] 输入价格和数量
- [ ] 提交买单
- [ ] 提交卖单

**5.3 订单匹配**
- [ ] 订单提交到数据库
- [ ] 订单簿实时更新
- [ ] 价格变化反映在UI

**测试SQL**：
```sql
-- 手动插入测试订单
INSERT INTO orders (market_id, user_address, side, price, quantity, status)
VALUES (1, '0xYourAddress', 'buy', 0.55, 100, 'open');

-- 查看订单簿
SELECT * FROM orderbooks WHERE market_id = 1;
```

**预期**：
- ✅ 订单簿实时更新（< 1秒）
- ✅ 价格计算正确
- ✅ 订单状态正确

---

### 测试 6️⃣：Supabase Realtime

#### 测试项目：

**6.1 订单簿实时更新**
```sql
-- 在Supabase SQL Editor执行，观察前端实时更新
UPDATE orderbooks
SET 
  bids = '[{"price": 0.60, "quantity": 200, "total": 120}]'::jsonb,
  asks = '[{"price": 0.61, "quantity": 180, "total": 109.8}]'::jsonb,
  last_price = 0.605
WHERE market_id = 1;
```

- [ ] 前端在 < 1秒 内更新
- [ ] 价格显示正确
- [ ] 无需刷新页面

**6.2 市场状态实时更新**
```sql
-- 更新市场状态
UPDATE market_states
SET 
  interested_count = 15,
  status = 'active',
  message = '🎉 市场已激活！'
WHERE market_id = 1;
```

- [ ] 状态立即更新
- [ ] 消息正确显示
- [ ] 按钮状态变化

**预期**：
- ✅ 实时更新延迟 < 1秒
- ✅ 所有订阅正常
- ✅ 无断线重连

---

### 测试 7️⃣：黑天鹅预警系统

**页面**：`http://localhost:3000/black-swan`

#### 测试项目：
- [ ] 历史事件列表显示
- [ ] K线图显示
- [ ] 预警指标显示
- [ ] 实时数据更新
- [ ] 闪崩检测功能

**预期**：
- ✅ 所有图表正常渲染
- ✅ 数据来源正确
- ✅ 预警逻辑正确

---

### 测试 8️⃣：多语言支持

#### 测试项目：
- [ ] 切换到英文（EN）
- [ ] 切换到中文（ZH）
- [ ] 所有文本正确翻译
- [ ] 语言偏好保存

**测试页面**：
- 首页
- 市场详情页
- 交易页面
- 黑天鹅页面

**预期**：
- ✅ 所有界面完整翻译
- ✅ 切换流畅无闪烁
- ✅ 偏好保存到localStorage

---

### 测试 9️⃣：钱包集成

#### 测试项目：

**9.1 连接钱包**
- [ ] MetaMask连接
- [ ] WalletConnect连接（如果支持）
- [ ] 显示钱包地址
- [ ] 显示余额

**9.2 网络切换**
- [ ] 检测错误网络
- [ ] 提示切换到 Polygon Amoy
- [ ] 自动添加网络配置

**9.3 交易签名**
- [ ] Mock USDC 授权
- [ ] 订单签名
- [ ] 交易确认

**预期**：
- ✅ 钱包连接流畅
- ✅ 网络检测准确
- ✅ 交易签名正常

---

### 测试 🔟：性能测试

#### 测试项目：

**10.1 页面加载速度**
- [ ] 首页 < 2秒
- [ ] 市场详情页 < 2秒
- [ ] 交易页面 < 3秒

**10.2 实时更新性能**
- [ ] 同时打开3个市场详情页
- [ ] 所有页面实时更新正常
- [ ] 无内存泄漏

**10.3 并发测试**
- [ ] 多个用户同时查看订单簿
- [ ] 多个用户同时下单
- [ ] 系统稳定运行

**使用浏览器DevTools检查**：
- Network：查看请求数量和大小
- Performance：查看渲染性能
- Memory：查看内存使用

**预期**：
- ✅ 页面加载 < 3秒
- ✅ 实时更新流畅
- ✅ 无性能瓶颈

---

## 📊 第四步：压力测试

### 1. 创建批量测试数据

```sql
-- 创建5个测试市场的订单簿
DO $$
DECLARE
  market_id INTEGER;
BEGIN
  FOR market_id IN 1..5 LOOP
    INSERT INTO orderbooks (market_id, bids, asks, last_price, volume_24h)
    VALUES (
      market_id,
      '[{"price": 0.55, "quantity": 100}]'::jsonb,
      '[{"price": 0.56, "quantity": 150}]'::jsonb,
      0.555,
      1000
    )
    ON CONFLICT (market_id) DO UPDATE SET
      bids = EXCLUDED.bids,
      asks = EXCLUDED.asks;
      
    INSERT INTO market_states (market_id, status, interested_count, activation_threshold)
    VALUES (market_id, 'active', 5, 10)
    ON CONFLICT (market_id) DO UPDATE SET
      status = EXCLUDED.status;
  END LOOP;
END $$;
```

### 2. 批量更新测试

```sql
-- 快速连续更新，测试Realtime性能
DO $$
DECLARE
  i INTEGER;
BEGIN
  FOR i IN 1..10 LOOP
    UPDATE orderbooks
    SET last_price = 0.50 + (i * 0.01)
    WHERE market_id = 1;
    
    PERFORM pg_sleep(0.5);
  END LOOP;
END $$;
```

### 3. 观察前端反应

- [ ] 所有更新都被捕获
- [ ] UI更新流畅
- [ ] 无掉帧或卡顿

---

## ✅ 第五步：生产就绪检查

### 最终确认清单

#### 数据库
- [ ] ✅ 测试数据已清理
- [ ] ✅ 表结构正确
- [ ] ✅ 索引已创建
- [ ] ✅ Realtime已启用

#### 区块链
- [ ] ✅ 所有合约地址正确
- [ ] ✅ 适配器已部署
- [ ] ✅ 官方组件集成完成

#### 前端
- [ ] ✅ 所有页面正常
- [ ] ✅ 实时功能工作
- [ ] ✅ 钱包连接正常
- [ ] ✅ 多语言完整

#### 性能
- [ ] ✅ 加载速度 < 3秒
- [ ] ✅ Realtime延迟 < 1秒
- [ ] ✅ 无内存泄漏

---

## 🎉 测试完成后

### 如果所有测试通过

**恭喜！您的LUMI平台已经可以投入使用！** 🚀

### 下一步行动：

1. **部署到Vercel生产环境**
```bash
git add .
git commit -m "生产就绪：所有功能测试通过"
git push
```

2. **监控设置**
- Supabase Dashboard → Logs
- Vercel Analytics
- Error tracking

3. **文档整理**
- 更新README.md
- 创建用户指南
- API文档

---

## 🆘 问题排查

### 常见问题

**问题1：Realtime不更新**
```sql
-- 重新启用Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE orderbooks;
ALTER PUBLICATION supabase_realtime ADD TABLE market_states;
```

**问题2：钱包连接失败**
- 检查网络配置
- 清除浏览器缓存
- 重新连接钱包

**问题3：区块链数据读取失败**
- 检查RPC地址
- 确认合约地址正确
- 检查网络状态

---

## 📚 参考文档

- **OFFICIAL_COMPONENTS_SUMMARY.md** - 官方组件总结
- **适配器集成状态总结.md** - 适配器状态
- **Supabase实时订单簿实施指南.md** - Realtime指南
- **README.md** - 项目文档

---

**开始测试吧！祝一切顺利！** 🎊

测试时间：2025-10-30

