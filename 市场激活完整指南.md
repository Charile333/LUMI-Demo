# 🚀 市场激活完整指南

## 🎯 三种激活方式

你创建的市场会保存在**数据库**中（状态：`draft`，区块链状态：`not_created`）。

要让市场能够交易，需要**激活**（上链）。有三种激活方式：

---

## 1️⃣ 方式一：手动激活（最快）⚡

### 适用场景
- 你刚创建了一个重要市场，想立即上线
- 不想等待自动激活
- 演示或测试时使用

### 操作步骤

#### 方法 A：通过 API

```bash
# 假设市场 ID 是 1
curl -X POST http://localhost:3000/api/admin/markets/1/activate
```

**注意**：你需要先登录，有 admin_authenticated cookie。

#### 方法 B：通过脚本（推荐）

```bash
# 运行手动激活脚本
npm run activate-markets
```

这个脚本会：
1. 扫描所有待激活的市场
2. 显示市场列表
3. 逐个激活
4. 显示进度

#### 方法 C：创建市场管理页面（推荐）

让我为你创建一个市场列表页面，可以一键激活。

---

## 2️⃣ 方式二：感兴趣机制激活（自动）🤖

### 工作原理

```
用户 A 浏览市场 → 点击"我感兴趣"
用户 B 浏览市场 → 点击"我感兴趣"
...
用户 E 浏览市场 → 点击"我感兴趣"

感兴趣人数 = 5 人
  ↓
定时任务扫描（每小时）
  ↓
自动激活市场
  ↓
WebSocket 通知所有人
```

### 激活条件

满足**任一条件**即可：
- ✅ 感兴趣用户 >= 5 人
- ✅ 浏览量 >= 100 次
- ✅ 活跃度评分 >= 60 分
- ✅ 优先级 = "hot"（热门）

### 操作方式

**完全自动，无需人工干预！**

1. 创建市场时设置优先级为"热门"
2. 或等待用户标记感兴趣
3. 定时任务会自动扫描并激活

---

## 3️⃣ 方式三：用户交易时激活（即时）⚡

### 工作原理

```
用户访问未激活的市场
  ↓
点击"激活并交易"按钮
  ↓
确认对话框
  ↓
立即调用激活 API
  ↓
等待 30 秒（倒计时显示）
  ↓
激活成功
  ↓
跳转到交易页面
```

### 用户体验

- 用户完全掌控
- 透明的等待时间
- 保证能交易

---

## 🧪 快速测试激活（现在就试）

### 准备工作

**1. 确保平台钱包已配置**

检查 `.env.local`：
```env
PLATFORM_WALLET_PRIVATE_KEY=0x...
```

**2. 确保钱包有余额**

- 需要 POL（Gas 费）
- 需要 Mock USDC（奖励）

---

### 测试步骤

#### Step 1: 创建测试市场

```
1. 访问: http://localhost:3000/admin/create-market
2. 填写:
   标题: 激活测试市场
   描述: 测试市场激活功能
   分类: emerging
   优先级: 🔥 热门（这样更容易被自动激活）
   奖励: 10
3. 提交
```

**记住市场 ID**（比如是 1）

---

#### Step 2: 手动激活（推荐测试）

**方法 1：使用 curl**

打开新终端：
```bash
curl -X POST http://localhost:3000/api/admin/markets/1/activate \
  -H "Cookie: admin_authenticated=true"
```

**方法 2：使用激活脚本**

```bash
npm run activate-markets
```

**预期输出**：
```
🔄 开始扫描待激活市场...
📊 找到 1 个待激活市场

激活市场: 激活测试市场
   活跃度: 15 | 浏览: 0 | 感兴趣: 0

💰 平台账户: 0x1234...
📝 Approving USDC...
✅ USDC approved
📝 Creating market on-chain...
⏳ 交易发送: 0xabcd...
✅ 交易确认，区块: 12345678
📊 Condition ID: 0xea6d...
✅ 市场激活成功！
```

---

#### Step 3: 验证激活成功

**检查数据库**（如果使用 Supabase）：

1. 访问 Supabase Dashboard
2. Table Editor → markets
3. 找到市场 ID 1
4. 查看字段：
   - `blockchain_status` 应该是 `'created'` ✅
   - `condition_id` 应该有值（0x...）✅
   - `activated_at` 应该有时间戳 ✅

**或使用 SQL**：
```sql
SELECT id, title, blockchain_status, condition_id, activated_at
FROM markets
WHERE id = 1;
```

---

## 🎯 激活方式对比

| 方式 | 触发条件 | 激活时机 | 等待时间 | 适用场景 |
|------|---------|---------|---------|---------|
| **手动激活** | 管理员操作 | 立即 | 30秒 | 演示、测试、重要市场 |
| **感兴趣激活** | 5人感兴趣 | 定时任务 | 0-60分钟 | 高人气市场 |
| **交易时激活** | 用户点击 | 立即 | 30秒 | 首个交易者 |

---

## 💰 激活成本

### 每次激活需要：

**Gas 费**：
- Polygon Amoy 测试网：~0.01 POL（约 $0.005）
- Polygon 主网：~0.01 POL（约 $0.005-0.01）

**USDC 奖励**：
- 你设置的金额（默认 10 USDC）
- 用于预言机奖励
- 锁定在合约中

**总成本**：约 $10（每个市场）

**由谁支付**：平台钱包（`PLATFORM_WALLET_PRIVATE_KEY`）

---

## 🔧 常见问题

### Q1: 激活失败，提示"USDC 余额不足"

**解决**：
```bash
# 检查平台钱包余额
# 需要给平台钱包充值 Mock USDC

# 或降低奖励金额（在创建市场时设为 1-5 USDC）
```

### Q2: 激活失败，提示"Gas 不足"

**解决**：
```bash
# 平台钱包需要 POL（用于 Gas）
# 从测试网水龙头获取：
# https://faucet.polygon.technology/
```

### Q3: 定时任务不运行

**解决**：
```bash
# 手动启动定时任务
npm run cron

# 或手动运行一次
npm run activate-markets
```

### Q4: 我想批量激活所有市场

**解决**：
```bash
# 编辑激活脚本，移除 LIMIT
# scripts/activate-markets-cron.ts
# 将 LIMIT 5 改为 LIMIT 100

# 然后运行
npm run activate-markets
```

---

## 🎯 推荐的激活策略

### Demo 演示时

**使用方式一：手动激活** ⭐
- 最快，立即生效
- 完全可控
- 适合演示

```bash
# 创建市场后立即激活
npm run activate-markets
```

### 生产环境

**使用方式二+三：自动激活** ⭐⭐⭐
- 节省成本（只激活活跃市场）
- 无需人工干预
- 用户体验好

```bash
# 启动定时任务，自动扫描和激活
npm run cron
```

---

## 📋 激活检查清单

激活前确认：

- [ ] ✅ `PLATFORM_WALLET_PRIVATE_KEY` 已配置
- [ ] ✅ 平台钱包有 POL（Gas）
- [ ] ✅ 平台钱包有 Mock USDC（奖励）
- [ ] ✅ 市场已创建（status = 'draft'）
- [ ] ✅ 市场未激活（blockchain_status = 'not_created'）

激活后验证：

- [ ] ✅ blockchain_status = 'created'
- [ ] ✅ condition_id 有值
- [ ] ✅ activated_at 有时间戳

---

## 🚀 现在就试试

### 快速测试：

```bash
# 1. 创建市场（管理后台）
http://localhost:3000/admin/create-market

# 2. 手动激活
npm run activate-markets

# 3. 查看结果（Supabase Dashboard 或前端）
```

---

**需要我帮你创建市场管理页面吗？** 

这样你就能在后台界面直接看到所有市场，并一键激活！

---

**创建时间**: 2025-10-24  
**状态**: ✅ 可以激活市场


