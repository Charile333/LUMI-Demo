# 🚀 市场激活完整指南

## 📋 目录

1. [什么是市场激活？](#什么是市场激活)
2. [激活方式](#激活方式)
3. [方式1：自动激活（推荐）](#方式1自动激活推荐)
4. [方式2：手动激活（管理员）](#方式2手动激活管理员)
5. [常见问题](#常见问题)

---

## 什么是市场激活？

市场有三种状态：

| 状态 | 说明 | 用户可以做什么 |
|------|------|---------------|
| **未激活** (`not_created`) | 市场仅存在于数据库中 | ⭐ 标记"我感兴趣" |
| **激活中** (`creating`) | 正在部署到区块链 | 👀 等待（约30秒）|
| **已激活** (`created`) | 已部署到区块链 | 💰 开始交易 |

**激活的作用**：
- ✅ 将市场部署到区块链（不可篡改）
- ✅ 生成 YES/NO 代币
- ✅ 开启订单簿交易
- ✅ 设置预言机奖励

---

## 激活方式

### 🎯 两种激活方式对比

| 方式 | 触发条件 | 优点 | 适用场景 |
|------|---------|------|---------|
| **自动激活** | 5人感兴趣 | 🔥 社区驱动<br>⚡ 自动化 | 日常运营 |
| **手动激活** | 管理员操作 | 🚀 即时激活<br>🎯 精准控制 | 热门话题<br>特殊活动 |

---

## 方式1：自动激活（推荐）

### 📊 激活流程

```
用户1: 点击"我对这个市场感兴趣" (1/5)
  ↓
用户2: 点击"我对这个市场感兴趣" (2/5)
  ↓
用户3: 点击"我对这个市场感兴趣" (3/5)
  ↓
用户4: 点击"我对这个市场感兴趣" (4/5)
  ↓
用户5: 点击"我对这个市场感兴趣" (5/5) ✅
  ↓
🎉 系统自动激活市场！
  ↓
⏱️ 约30秒后，市场可以交易
```

### 🎯 用户操作步骤

#### Step 1: 找到未激活的市场

访问任意市场页面，例如：
- http://localhost:3000/markets/automotive
- http://localhost:3000/markets/tech-ai
- http://localhost:3000/blockchain-markets

#### Step 2: 识别市场状态

查看市场卡片上的状态指示：

```
┌─────────────────────────────────────┐
│ 🚗 特斯拉会在2025年推出新车型吗？   │
│                                     │
│ ⚠️ 市场尚未激活                      │
│ ▓▓▓▓▓░░░░░ 3 人已感兴趣             │
│ 还需 2 人                            │
│                                     │
│ [⭐ 我对这个市场感兴趣]              │
│ [📊 了解更多]                        │
└─────────────────────────────────────┘
```

#### Step 3: 点击"我感兴趣"按钮

1. **连接钱包**（如果未连接）
   - 系统会提示你连接 MetaMask
   - 选择你的账户并连接

2. **点击按钮**
   ```
   [⭐ 我对这个市场感兴趣]
   ```

3. **确认操作**
   - 浏览器会显示签名请求
   - 点击"签名"确认

#### Step 4: 等待激活

当达到5人感兴趣时：

```
┌─────────────────────────────────────┐
│ 🚗 特斯拉会在2025年推出新车型吗？   │
│                                     │
│ 🚀 正在激活市场...                   │
│ ▓▓▓▓▓▓▓▓▓▓ 预计剩余时间: 25 秒      │
│                                     │
│ 💡 激活后你将收到通知                │
└─────────────────────────────────────┘
```

#### Step 5: 激活完成

```
┌─────────────────────────────────────┐
│ 🚗 特斯拉会在2025年推出新车型吗？   │
│                                     │
│ ✅ 市场已激活                        │
│ 可以开始交易了！                     │
│                                     │
│ YES 概率: 65.5%  |  NO 概率: 34.5% │
│ 买价: $0.65     |  卖价: $0.66    │
│                                     │
│ [💰 立即交易]                        │
└─────────────────────────────────────┘
```

### 🔔 实时通知

系统会通过 WebSocket 实时推送：

1. **有人感兴趣时**：
   ```
   🔥 还需 2 人，市场即将激活！
   ```

2. **激活中**：
   ```
   🚀 市场正在激活中...预计剩余时间: 25 秒
   ```

3. **激活成功**：
   ```
   ✅ 市场已激活！现在可以交易了
   ```

### 💡 激活机制详解

#### 阈值设置
```typescript
const ACTIVATION_THRESHOLD = 5; // 5人感兴趣即激活
```

#### 检查逻辑
```typescript
// 每次有人标记感兴趣时
if (interestedUsersCount >= 5) {
  // 触发自动激活
  await activateMarket(marketId);
}
```

#### 防重复投票
- ✅ 每个钱包地址只能为同一市场标记一次
- ✅ 数据库记录用户地址和时间戳
- ✅ 前端显示已投票状态

---

## 方式2：手动激活（管理员）

### 🔐 管理员权限

只有管理员可以手动激活市场。

### 📍 访问管理后台

#### 方式 A: 通过测试页面

1. 访问测试市场页面：
   ```
   http://localhost:3000/admin/test-market
   ```

2. 你会看到：
   ```
   ┌─────────────────────────────────────┐
   │ 🏗️ 创建测试市场                      │
   │                                     │
   │ 市场标题: ____________________      │
   │ 市场描述: ____________________      │
   │ 奖励金额: [10] USDC                 │
   │                                     │
   │ [🚀 创建市场]                        │
   └─────────────────────────────────────┘
   ```

3. 填写信息并点击"创建市场"

#### 方式 B: 通过 Hardhat 脚本

```bash
# 在项目根目录执行
npx hardhat run scripts/create-market.js --network amoy
```

### 🛠️ 手动激活步骤

#### Step 1: 准备信息

需要准备：
- ✅ 市场标题（必填）
- ✅ 市场描述（必填）
- ✅ 奖励金额（默认10 USDC）
- ✅ MetaMask 连接到 Polygon Amoy 测试网

#### Step 2: 批准 USDC

```typescript
// 1. 批准合约使用 USDC
const usdc = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
await usdc.approve(ADAPTER_ADDRESS, ethers.utils.parseUnits('10', 6));

// 2. 等待确认
console.log('✅ USDC 批准成功');
```

#### Step 3: 调用创建市场

```typescript
// 调用 TestUmaCTFAdapter.initialize()
const adapter = new ethers.Contract(ADAPTER_ADDRESS, ADAPTER_ABI, signer);

const tx = await adapter.initialize(
  questionId,          // 问题 ID（自动生成）
  title,               // "特斯拉会在2025年推出新车型吗？"
  description,         // "预测特斯拉新车型发布"
  2,                   // 结果数量（YES/NO）
  USDC_ADDRESS,        // Mock USDC 地址
  ethers.utils.parseUnits('10', 6), // 10 USDC
  0                    // 挑战期（未使用）
);

// 等待交易确认
await tx.wait();
console.log('✅ 市场已创建！Condition ID:', conditionId);
```

#### Step 4: 更新数据库

```typescript
// 更新数据库中的市场状态
await db.query(
  `UPDATE markets 
   SET blockchain_status = 'created',
       condition_id = $1
   WHERE id = $2`,
  [conditionId, marketId]
);
```

### 🔗 合约地址（Polygon Amoy 测试网）

```typescript
// 必需的合约地址
const CONTRACTS = {
  testAdapter: '0x5D440c98B55000087a8b0C164f1690551d18CfcC',
  conditionalTokens: '0xeB4F3700FE422c1618B449763d423687D5ad0950',
  mockUSDC: '0x8d2dae90Dbc51dF7E18C1b857544AC979F87a77a',
  oracle: '0x378fA22104E4c735680772Bf18C5195778a55b33'
};
```

### 📊 Gas 费用

手动激活市场需要：
- **Gas**: ~200,000 - 300,000 gas
- **估算费用**: 0.001 - 0.002 MATIC（测试网免费）

### 🎯 何时使用手动激活？

推荐在以下情况手动激活：

1. **热门话题** - 不想等待自动激活
2. **营销活动** - 需要即时上线
3. **测试市场** - 开发和测试用途
4. **紧急事件** - 突发新闻需要快速响应

---

## 常见问题

### Q1: 为什么我看不到"我感兴趣"按钮？

**原因**：
- ✅ 市场已经激活（`blockchain_status === 'created'`）
- ❌ 只有未激活的市场才显示此按钮

**解决方案**：
- 查看其他未激活的市场
- 或者在管理后台创建新的测试市场

### Q2: 点击"我感兴趣"后没反应？

**可能原因**：
1. **钱包未连接**
   - 检查 MetaMask 是否已连接
   - 刷新页面重试

2. **已经投票过**
   - 每个地址只能投一次
   - 按钮会显示"✓ 已标记感兴趣"

3. **网络错误**
   - 检查浏览器控制台
   - 查看 API 是否正常

### Q3: 自动激活需要多长时间？

**时间线**：
```
用户5标记感兴趣
  ↓
触发激活 (1分钟内)
  ↓
区块链交易确认 (约30秒)
  ↓
更新数据库状态 (实时)
  ↓
WebSocket 通知用户 (实时)
```

**总计**: 约 **1-2 分钟**

### Q4: 激活后可以取消吗？

**答案**: ❌ 不可以

**原因**：
- 市场已部署到区块链（不可变）
- 用户可能已经下单交易
- 确保市场的公平性和透明度

**建议**：
- 激活前仔细确认市场信息
- 使用测试网进行测试

### Q5: 可以修改激活阈值吗？

**答案**: ✅ 可以

**修改方法**：

```typescript
// components/MarketActivationStatus.tsx
const ACTIVATION_THRESHOLD = 5; // 改为你想要的数字
```

**建议值**：
- **高流量平台**: 10-20 人
- **中等平台**: 5-10 人
- **小型社区**: 3-5 人
- **测试环境**: 1-2 人

### Q6: 如何查看所有未激活的市场？

**方法1**: 在前端筛选
```typescript
// 访问市场页面，筛选未激活的
const unactivatedMarkets = markets.filter(
  m => m.blockchain_status === 'not_created'
);
```

**方法2**: 数据库查询
```sql
SELECT * FROM markets 
WHERE blockchain_status = 'not_created'
ORDER BY interested_users DESC;
```

**方法3**: API 端点
```bash
GET /api/markets?status=not_created
```

### Q7: 如何测试自动激活功能？

**测试步骤**：

1. **降低阈值**（临时）
   ```typescript
   const ACTIVATION_THRESHOLD = 2; // 测试用
   ```

2. **创建测试市场**
   ```bash
   # 访问
   http://localhost:3000/admin/test-market
   ```

3. **使用多个账户投票**
   - 切换 MetaMask 账户
   - 每个账户投一次票

4. **观察激活流程**
   - 查看进度条更新
   - 观察状态变化
   - 检查 WebSocket 通知

5. **恢复阈值**
   ```typescript
   const ACTIVATION_THRESHOLD = 5; // 恢复正式值
   ```

---

## 🎯 快速参考卡

### 自动激活速查

```
未激活市场
  ↓
点击"我对这个市场感兴趣"
  ↓
连接钱包 → 确认签名
  ↓
等待 5 人感兴趣
  ↓
自动激活（1-2分钟）
  ↓
开始交易！
```

### 手动激活速查

```
访问管理后台
  ↓
填写市场信息
  ↓
批准 USDC
  ↓
创建市场
  ↓
等待区块链确认（30秒）
  ↓
市场已激活！
```

---

## 📚 相关文档

- **合约架构**: `MARKET_CREATION_EXPLAINED.md`
- **组件文档**: `components/MarketCard.tsx`
- **API 文档**: `app/api/markets/[marketId]/interested/route.ts`
- **WebSocket**: `server-with-websocket.js`

---

## 🎉 总结

两种激活方式各有优势：

| 方式 | 优点 | 缺点 |
|------|------|------|
| **自动激活** | 🔥 社区驱动<br>⚡ 无需Gas<br>📊 验证需求 | ⏱️ 需要等待 |
| **手动激活** | 🚀 即时生效<br>🎯 精准控制 | 💰 需要Gas<br>🔐 需要权限 |

**推荐**：
- 日常运营使用**自动激活**
- 紧急/热门话题使用**手动激活**

---

**最后更新**: 2025-10-30  
**状态**: ✅ 已完成

