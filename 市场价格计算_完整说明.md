# ğŸ’° å¸‚åœºæ¦‚ç‡ä»·æ ¼ - å®Œæ•´è¯´æ˜

> ä»·æ ¼ä»å“ªæ¥ï¼Ÿå¦‚ä½•è®¡ç®—ï¼Ÿå¦‚ä½•å®æ—¶æ›´æ–°ï¼Ÿ

---

## ğŸ¯ æ ¸å¿ƒç­”æ¡ˆ

### âŒ ä»·æ ¼**ä¸ä»åŒºå—é“¾**è¯»å–ï¼

```
ä»·æ ¼æ¥æºï¼š
  âŒ ä¸ä» Conditional Tokens
  âŒ ä¸ä» CTF Exchange  
  âŒ ä¸ä» UMA Oracle
  
  âœ… ä» Supabase è®¢å•ç°¿è®¡ç®—
```

---

## ğŸ“Š ä»·æ ¼è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼ï¼ˆæ°¸æ’ä¸å˜ï¼‰

```javascript
// 1. ä»è®¢å•ç°¿è·å–æœ€ä½³ä»·æ ¼
const bestBid = è®¢å•ç°¿ä¸­æœ€é«˜ä¹°ä»·;  // æ¯”å¦‚ $0.58
const bestAsk = è®¢å•ç°¿ä¸­æœ€ä½å–ä»·;  // æ¯”å¦‚ $0.62

// 2. è®¡ç®—ä¸­é—´ä»·ï¼ˆæ˜¾ç¤ºä»·æ ¼ï¼‰
const midPrice = (bestBid + bestAsk) / 2;  // $0.60

// 3. è½¬æ¢ä¸ºæ¦‚ç‡
const probability = midPrice * 100;  // 60%

// 4. NO çš„æ¦‚ç‡
const noProbability = 100 - probability;  // 40%
```

---

## ğŸ”„ å®Œæ•´çš„æ•°æ®æµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·ä¸‹å•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¢å•å­˜å…¥ Supabase    â”‚
â”‚    orders è¡¨            â”‚  âš¡ 50ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ›´æ–°è®¢å•ç°¿           â”‚
â”‚    è®¡ç®—æœ€ä½³ä¹°/å–ä»·      â”‚  âš¡ 10ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. WebSocket æ¨é€       â”‚
â”‚    å®æ—¶ä»·æ ¼æ›´æ–°         â”‚  âš¡ 1ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯æ¥æ”¶             â”‚
â”‚    é‡æ–°è®¡ç®—æ¦‚ç‡         â”‚  âš¡ 1ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. é¡µé¢æ˜¾ç¤ºæ–°ä»·æ ¼       â”‚
â”‚    ç”¨æˆ·çœ‹åˆ°æ›´æ–°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å»¶è¿Ÿ: < 100ms âš¡
```

---

## ğŸ’» å®é™…ä»£ç å®ç°

### 1. è®¡ç®—ä»·æ ¼ï¼ˆHookï¼‰

```typescript
// hooks/useMarketPrice.ts
export function useMarketPrice(marketId: number) {
  const [price, setPrice] = useState({
    yes: 0.5,
    no: 0.5,
    probability: 50,
    bestBid: 0.49,
    bestAsk: 0.51
  });

  const fetchPrice = async () => {
    // âœ… ä» API è·å–è®¢å•ç°¿ï¼ˆSupabaseï¼‰
    const response = await fetch(`/api/orders/book?marketId=${marketId}`);
    const data = await response.json();
    
    if (data.success && data.orderBook) {
      // æå–æœ€ä½³ä¹°å–ä»·
      let bestBid = data.orderBook.bids?.[0]?.price 
        ? parseFloat(data.orderBook.bids[0].price) 
        : 0;
      
      let bestAsk = data.orderBook.asks?.[0]?.price 
        ? parseFloat(data.orderBook.asks[0].price) 
        : 0;
      
      // å¤„ç†ç‰¹æ®Šæƒ…å†µ
      if (bestBid === 0 && bestAsk > 0) {
        // åªæœ‰å–å•ï¼Œä¼°ç®—ä¹°ä»·
        bestBid = Math.max(0.01, bestAsk - 0.05);
      } else if (bestAsk === 0 && bestBid > 0) {
        // åªæœ‰ä¹°å•ï¼Œä¼°ç®—å–ä»·
        bestAsk = Math.min(0.99, bestBid + 0.05);
      } else if (bestBid === 0 && bestAsk === 0) {
        // è®¢å•ç°¿ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
        bestBid = 0.49;
        bestAsk = 0.51;
      }
      
      // âœ… æ ¸å¿ƒè®¡ç®—ï¼šä¸­é—´ä»·
      const midPrice = (bestBid + bestAsk) / 2;
      
      setPrice({
        yes: midPrice,
        no: 1 - midPrice,
        probability: midPrice * 100,
        bestBid,
        bestAsk
      });
    }
  };

  useEffect(() => {
    fetchPrice();
    // æ¯15ç§’åˆ·æ–°ä¸€æ¬¡
    const interval = setInterval(fetchPrice, 15000);
    return () => clearInterval(interval);
  }, [marketId]);

  return price;
}
```

---

### 2. å®æ—¶æ›´æ–°ï¼ˆWebSocketï¼‰

```typescript
// hooks/useWebSocket.ts
export function useOrderBookWebSocket(marketId: number) {
  const [orderBook, setOrderBook] = useState(null);
  
  useEffect(() => {
    // âœ… è¿æ¥ WebSocket
    const ws = new WebSocket(`ws://localhost:3000/ws/orderbook`);
    
    ws.onopen = () => {
      // è®¢é˜…ç‰¹å®šå¸‚åœº
      ws.send(JSON.stringify({
        type: 'subscribe',
        marketId: marketId
      }));
    };
    
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      
      if (message.type === 'orderbook_update') {
        // âœ… å®æ—¶æ›´æ–°è®¢å•ç°¿æ•°æ®
        setOrderBook(message.data);
      }
    };
    
    return () => ws.close();
  }, [marketId]);
  
  return orderBook;
}
```

---

### 3. é¡µé¢ä½¿ç”¨

```typescript
// app/markets/[category]/page.tsx
export default function MarketCategoryPage() {
  // âœ… ä» Supabase åŠ è½½å¸‚åœºåˆ—è¡¨ï¼ˆå¿«é€Ÿï¼‰
  const { markets, loading } = useMarketsByCategory(category);
  
  // âœ… WebSocket å®æ—¶ä»·æ ¼ï¼ˆå¯é€‰ï¼‰
  const marketIds = markets.map(m => m.id);
  const { pricesMap } = useMarketListWebSocket(marketIds);
  
  return (
    <div>
      {markets.map(market => (
        <MarketCard 
          key={market.id}
          market={market}
          price={pricesMap[market.id] || market.probability}
        />
      ))}
    </div>
  );
}
```

---

## ğŸ“‹ æ•°æ®å­˜å‚¨ç»“æ„

### Supabase è¡¨ç»“æ„

#### 1. orders è¡¨ï¼ˆè®¢å•ï¼‰

```sql
CREATE TABLE orders (
  id BIGSERIAL PRIMARY KEY,
  market_id INTEGER NOT NULL,
  user_address TEXT NOT NULL,
  side TEXT NOT NULL,           -- 'buy' æˆ– 'sell'
  price DECIMAL(10, 6) NOT NULL, -- è®¢å•ä»·æ ¼ (0.01 åˆ° 0.99)
  amount DECIMAL(18, 6) NOT NULL,
  status TEXT NOT NULL,          -- 'pending', 'filled', 'cancelled'
  signature TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO orders VALUES
  (1, 123, '0xabc...', 'buy',  0.58, 100, 'pending', '0x...', NOW()),
  (2, 123, '0xdef...', 'buy',  0.57, 150, 'pending', '0x...', NOW()),
  (3, 123, '0xghi...', 'sell', 0.62, 80,  'pending', '0x...', NOW()),
  (4, 123, '0xjkl...', 'sell', 0.63, 120, 'pending', '0x...', NOW());
```

#### 2. è®¡ç®—ä»·æ ¼çš„ SQL

```sql
-- è·å–å¸‚åœºçš„æœ€ä½³ä¹°å–ä»·
SELECT 
  -- æœ€é«˜ä¹°ä»·
  (SELECT price FROM orders 
   WHERE market_id = 123 
     AND side = 'buy' 
     AND status = 'pending'
   ORDER BY price DESC 
   LIMIT 1) as best_bid,
  
  -- æœ€ä½å–ä»·
  (SELECT price FROM orders 
   WHERE market_id = 123 
     AND side = 'sell' 
     AND status = 'pending'
   ORDER BY price ASC 
   LIMIT 1) as best_ask;

-- ç»“æœ:
-- best_bid: 0.58
-- best_ask: 0.62
-- 
-- ä¸­é—´ä»· = (0.58 + 0.62) / 2 = 0.60
-- æ¦‚ç‡ = 60%
```

---

## ğŸ¯ ä¸‰å¤§ç»„ä»¶ä¸ä»·æ ¼çš„å…³ç³»

### âŒ ä¸ä»åŒºå—é“¾è¯»å–ä»·æ ¼

```
Conditional Tokens:
  â””â”€ ç®¡ç†å¸‚åœºçŠ¶æ€ï¼ˆåˆ›å»ºã€ç»“ç®—ï¼‰
  â””â”€ âŒ ä¸å­˜å‚¨ä»·æ ¼æ•°æ®
  â””â”€ âŒ ä¸æä¾›ä»·æ ¼ API

CTF Exchange:
  â””â”€ æ‰§è¡Œé“¾ä¸Šç»“ç®—
  â””â”€ âŒ ä¸å­˜å‚¨è®¢å•ç°¿
  â””â”€ âŒ ä¸æä¾›ä»·æ ¼ API

UMA Oracle:
  â””â”€ æä¾›å¸‚åœºç»“æœï¼ˆYES/NOï¼‰
  â””â”€ âŒ ä¸æä¾›ä»·æ ¼æ•°æ®
  â””â”€ âŒ åªåœ¨ç»“ç®—æ—¶ä½¿ç”¨
```

### âœ… ä»·æ ¼å®Œå…¨ç”±è®¢å•ç°¿å†³å®š

```
è®¢å•ç°¿ï¼ˆSupabaseï¼‰
  â†“
æœ€ä½³ä¹°ä»· + æœ€ä½å–ä»·
  â†“
ä¸­é—´ä»·ï¼ˆæ˜¾ç¤ºä»·æ ¼ï¼‰
  â†“
æ¦‚ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
```

---

## ğŸ“Š å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: æ­£å¸¸å¸‚åœº

```
å¸‚åœº: "æ¯”ç‰¹å¸ä¼šè¶…è¿‡10ä¸‡ç¾å…ƒå—ï¼Ÿ"

è®¢å•ç°¿:
  å–å•ï¼ˆç”¨æˆ·æƒ³å– YESï¼‰:
    $0.62 - 100 ä»½é¢
    $0.63 - 200 ä»½é¢
    $0.65 - 50 ä»½é¢
  
  ä¹°å•ï¼ˆç”¨æˆ·æƒ³ä¹° YESï¼‰:
    $0.58 - 150 ä»½é¢
    $0.57 - 180 ä»½é¢
    $0.55 - 100 ä»½é¢

è®¡ç®—:
  æœ€é«˜ä¹°ä»· = $0.58
  æœ€ä½å–ä»· = $0.62
  ä¸­é—´ä»· = ($0.58 + $0.62) / 2 = $0.60
  
æ˜¾ç¤º:
  YES: 60% ğŸ“ˆ
  NO: 40% ğŸ“‰
```

---

### æ¡ˆä¾‹ 2: æ–°å¸‚åœºï¼ˆè®¢å•å°‘ï¼‰

```
å¸‚åœº: "æŸæ–°å¸ä¼šä¸Šæ¶¨å—ï¼Ÿ"

è®¢å•ç°¿:
  å–å•: $0.80 - 10 ä»½é¢
  ä¹°å•: $0.30 - 5 ä»½é¢

è®¡ç®—:
  æœ€é«˜ä¹°ä»· = $0.30
  æœ€ä½å–ä»· = $0.80
  ä¸­é—´ä»· = ($0.30 + $0.80) / 2 = $0.55
  ä»·å·® = $0.50 (å¾ˆå¤§ï¼)
  
æ˜¾ç¤º:
  YES: 55% âš ï¸
  NO: 45%
  
âš ï¸ å¤§ä»·å·®è¡¨ç¤ºæµåŠ¨æ€§ä½ï¼Œä»·æ ¼ä¸ç¨³å®š
```

---

### æ¡ˆä¾‹ 3: å•è¾¹å¸‚åœº

```
å¸‚åœº: "æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ"

è®¢å•ç°¿:
  å–å•: æ— 
  ä¹°å•: $0.75 - 200 ä»½é¢

å¤„ç†:
  æœ€é«˜ä¹°ä»· = $0.75
  æœ€ä½å–ä»· = 0 (æ— å–å•)
  
  // ä¼°ç®—å–ä»·
  ä¼°ç®—å–ä»· = min(0.99, 0.75 + 0.05) = $0.80
  
  ä¸­é—´ä»· = ($0.75 + $0.80) / 2 = $0.775
  
æ˜¾ç¤º:
  YES: 77.5% ğŸ“ˆ
  NO: 22.5%
```

---

## âš¡ æ€§èƒ½å¯¹æ¯”

### æ–¹å¼ 1: ä»åŒºå—é“¾è¯»å–ï¼ˆâŒ æ…¢ï¼‰

```typescript
// âŒ ä¸è¦è¿™æ ·åš
const getPrice = async (marketId) => {
  // è°ƒç”¨åŒºå—é“¾
  const ctf = new ethers.Contract(CTF_ADDRESS, ABI, provider);
  const market = await ctf.getMarket(marketId);  // 1-3ç§’
  
  // è¿˜è¦è®¡ç®—è®¢å•ç°¿...
  const exchange = new ethers.Contract(EXCHANGE_ADDRESS, ABI, provider);
  const orderBook = await exchange.getOrderBook(marketId);  // 1-3ç§’
  
  return calculatePrice(orderBook);  // æ€»å…± 2-6ç§’
};
```

**é€Ÿåº¦**: ğŸŒ 2-6ç§’/å¸‚åœº

---

### æ–¹å¼ 2: ä» Supabase è¯»å–ï¼ˆâœ… å¿«ï¼‰

```typescript
// âœ… æ­£ç¡®æ–¹å¼
const getPrice = async (marketId) => {
  // æŸ¥è¯¢æ•°æ®åº“
  const { data } = await supabase
    .from('orders')
    .select('price, side')
    .eq('market_id', marketId)
    .eq('status', 'pending')
    .order('price', { ascending: false })
    .limit(1);
  
  return calculatePrice(data);  // < 100ms
};
```

**é€Ÿåº¦**: âš¡ < 100ms/å¸‚åœº

**æ€§èƒ½æå‡**: **30å€ä»¥ä¸Š**ï¼

---

## ğŸ”„ å®æ—¶æ›´æ–°æœºåˆ¶

### é€‰é¡¹ 1: WebSocketï¼ˆæ¨èï¼‰

```typescript
// âœ… å®æ—¶æ€§æœ€å¥½
const { priceData, connected } = useWebSocket(marketId);

// ç‰¹ç‚¹:
// - å»¶è¿Ÿ: < 100ms
// - è‡ªåŠ¨æ¨é€
// - æœåŠ¡å™¨å¼€é”€å°
```

---

### é€‰é¡¹ 2: è½®è¯¢

```typescript
// âœ… ç®€å•ä½†å ç”¨èµ„æº
useEffect(() => {
  const fetchPrice = async () => {
    const price = await getPrice(marketId);
    setPrice(price);
  };
  
  fetchPrice();
  const interval = setInterval(fetchPrice, 15000); // æ¯15ç§’
  return () => clearInterval(interval);
}, [marketId]);

// ç‰¹ç‚¹:
// - å»¶è¿Ÿ: 0-15ç§’
// - å®ç°ç®€å•
// - æœåŠ¡å™¨å¼€é”€å¤§
```

---

### é€‰é¡¹ 3: Supabase Realtimeï¼ˆæ¨èï¼‰

```typescript
// âœ… æœ€ä½³æ–¹æ¡ˆ
const supabase = createClient(...);

const channel = supabase
  .channel(`orderbook:${marketId}`)
  .on(
    'postgres_changes',
    {
      event: '*',
      schema: 'public',
      table: 'orders',
      filter: `market_id=eq.${marketId}`
    },
    (payload) => {
      // è®¢å•å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘
      recalculatePrice(marketId);
    }
  )
  .subscribe();

// ç‰¹ç‚¹:
// - å»¶è¿Ÿ: < 500ms
// - è‡ªåŠ¨æ¨é€
// - åŸç”Ÿæ”¯æŒ
// - ä¸éœ€è¦é¢å¤–çš„ WebSocket æœåŠ¡å™¨
```

---

## âœ… æœ€ä½³å®è·µ

### 1. å¸‚åœºåˆ—è¡¨é¡µé¢

```typescript
// âœ… æ˜¾ç¤ºç¼“å­˜ä»·æ ¼ï¼Œä¸å®æ—¶æ›´æ–°
const { markets } = useMarketsByCategory(category);

return (
  <div>
    {markets.map(market => (
      <MarketCard 
        key={market.id}
        market={market}
        // ä½¿ç”¨æ•°æ®åº“ä¸­çš„ä»·æ ¼ï¼ˆå¿«é€Ÿï¼‰
        probability={market.probability}
      />
    ))}
  </div>
);
```

**ç‰¹ç‚¹**:
- âš¡ åŠ è½½å¿«
- ğŸ“Š æ˜¾ç¤ºæœ€è¿‘çš„ä»·æ ¼
- ğŸ”„ ä¸éœ€è¦å®æ—¶æ›´æ–°ï¼ˆåˆ—è¡¨é¡µé¢ï¼‰

---

### 2. å¸‚åœºè¯¦æƒ…é¡µé¢

```typescript
// âœ… å®æ—¶æ›´æ–°ä»·æ ¼
const { price } = useMarketPrice(marketId);
const { orderBook } = useWebSocket(marketId);

useEffect(() => {
  if (orderBook) {
    // æ ¹æ®å®æ—¶è®¢å•ç°¿é‡æ–°è®¡ç®—
    const midPrice = (orderBook.bestBid + orderBook.bestAsk) / 2;
    updatePrice(midPrice);
  }
}, [orderBook]);

return (
  <div>
    <h1>YES: {(price.yes * 100).toFixed(1)}%</h1>
    <h1>NO: {(price.no * 100).toFixed(1)}%</h1>
  </div>
);
```

**ç‰¹ç‚¹**:
- âš¡ å®æ—¶æ›´æ–°
- ğŸ“ˆ å‡†ç¡®åæ˜ å¸‚åœº
- ğŸ¯ ç”¨æˆ·çœ‹åˆ°æœ€æ–°ä»·æ ¼

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ä»·æ ¼æ¥æº**
   - âœ… Supabase è®¢å•ç°¿
   - âŒ ä¸ä»åŒºå—é“¾

2. **è®¡ç®—å…¬å¼**
   ```javascript
   midPrice = (bestBid + bestAsk) / 2
   probability = midPrice * 100
   ```

3. **æ›´æ–°æœºåˆ¶**
   - âœ… WebSocket å®æ—¶æ¨é€
   - âœ… Supabase Realtime
   - âš ï¸ å®šæ—¶è½®è¯¢ï¼ˆå¤‡ç”¨ï¼‰

4. **æ€§èƒ½**
   - æ•°æ®åº“: < 100ms âš¡
   - åŒºå—é“¾: 2-6ç§’ ğŸŒ
   - æå‡: **30å€ä»¥ä¸Š**

---

### è®°ä½

**ä»·æ ¼ = è®¢å•ç°¿æ•°æ® â‰  åŒºå—é“¾æ•°æ®**

ä¸‰å¤§ç»„ä»¶çš„ä½œç”¨ï¼š
- Conditional Tokens: åˆ›å»ºå’Œç»“ç®—å¸‚åœº
- CTF Exchange: æ‰§è¡Œé“¾ä¸Šäº¤æ˜“
- UMA Oracle: è·å–çœŸå®ä¸–ç•Œç»“æœ

ä»·æ ¼çš„ä½œç”¨ï¼š
- åæ˜ å¸‚åœºå¯¹äº‹ä»¶çš„é¢„æœŸ
- ç”±ç”¨æˆ·çš„ä¹°å–è®¢å•å†³å®š
- å­˜å‚¨åœ¨ Supabaseï¼Œå®æ—¶è®¡ç®—

---

**ç›¸å…³æ–‡æ¡£**:
- `LUMI_PRICING_MECHANISM.md` - ä»·æ ¼æœºåˆ¶è¯¦è§£
- `å¿«é€Ÿå‚è€ƒ_ç»„ä»¶ä½¿ç”¨æ—¶æœº.md` - ç»„ä»¶ä½¿ç”¨æ—¶æœº
- `LUMI_ç»„ä»¶ä½¿ç”¨æ¶æ„å›¾.md` - å®Œæ•´æ¶æ„



