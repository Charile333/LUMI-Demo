# 📦 LUMI 独立数据库 - 迁移指南

## ✅ 为什么要独立数据库？

### 之前（依赖外部）
```
LUMI/
  └── server.js → 依赖 → duolume-master/utils/database/app.db
                          ↑
                    需要外部项目
```

**问题**：
- ❌ LUMI不能独立运行
- ❌ 部署需要两个项目
- ❌ 路径复杂易错
- ❌ 数据管理分散

### 现在（独立自包含）
```
LUMI/
  ├── database/
  │   └── alerts.db  ← 独立数据库
  └── server.js → 直接使用本地数据库
```

**优势**：
- ✅ LUMI完全独立
- ✅ 一个项目搞定
- ✅ 部署简单
- ✅ 数据集中管理

---

## 🚀 快速迁移（3步）

### 步骤1：初始化新数据库
```bash
cd LUMI/scripts
node setup-database.js
```

### 步骤2：迁移旧数据（可选）
```bash
node migrate-data.js
```

### 步骤3：导入历史事件（可选）
```bash
node import-historical-crashes.js
```

### 一键完成（Windows）
```bash
cd LUMI\scripts
初始化数据库.bat
```

---

## 📂 新的目录结构

```
LUMI/
├── database/               ← 新增：独立数据库目录
│   └── alerts.db          ← LUMI专用数据库
├── scripts/
│   ├── setup-database.js       ← 初始化数据库
│   ├── migrate-data.js         ← 迁移旧数据
│   ├── import-historical-crashes.js  ← 导入历史事件
│   └── 初始化数据库.bat
├── server.js              ← 已更新：使用新数据库路径
└── ...
```

---

## 🔧 详细步骤

### 1. 初始化新数据库

创建LUMI独立数据库，包括表结构和索引：

```bash
cd LUMI/scripts
node setup-database.js
```

**输出示例**：
```
✅ Created database directory: LUMI/database
✅ Database connection established
✅ Table "alerts" created/verified
✅ Created 4 indexes for better performance

📊 Table structure:
   • id           : INTEGER
   • timestamp    : TEXT
   • symbol       : TEXT
   • message      : TEXT
   • severity     : TEXT
   • details      : TEXT
   • type         : TEXT
   • created_at   : DATETIME

📈 Current records: 0

✅ Database setup complete!
```

### 2. 迁移现有数据（可选）

如果你有旧数据库中的数据，可以迁移过来：

```bash
cd LUMI/scripts
node migrate-data.js
```

**功能**：
- 从 `duolume-master/utils/database/app.db` 读取所有数据
- 复制到 `LUMI/database/alerts.db`
- 保留所有警报记录
- 旧数据库不会被删除（作为备份）

**输出示例**：
```
📍 Source: duolume-master/utils/database/app.db
📍 Target: LUMI/database/alerts.db

✅ Connected to source database
📊 Found 156 records to migrate

🔄 Migrating data...

✅ Migration complete!
   • Successfully migrated: 156 records
```

### 3. 导入历史闪崩事件（可选）

导入21个真实的历史闪崩事件：

```bash
cd LUMI/scripts
node import-historical-crashes.js
```

**包含事件**：
- 2020黑色星期四 (-50.2%)
- 2022 FTX崩盘 (-23.5%)
- 2021中国禁令 (-30.2%)
- 等等...

---

## ✅ 验证迁移

### 检查数据库文件
```bash
# Windows
dir LUMI\database\alerts.db

# Linux/Mac
ls -lh LUMI/database/alerts.db
```

### 查询记录数
```bash
cd LUMI
sqlite3 database/alerts.db "SELECT COUNT(*) FROM alerts;"
```

### 查看最近的警报
```bash
sqlite3 database/alerts.db "SELECT datetime(timestamp, 'localtime'), symbol, severity FROM alerts ORDER BY timestamp DESC LIMIT 5;"
```

---

## 🎯 预警系统对接

### 选项1：保持现有预警系统（推荐）

预警系统继续写入旧数据库，LUMI定期同步：

```javascript
// 可以创建一个同步脚本（未来功能）
// 每分钟从旧数据库同步新警报到LUMI数据库
```

### 选项2：修改预警系统写入新数据库

修改 `duolume-master` 的数据库路径，直接写入LUMI数据库：

```python
# duolume-master/utils/db_manager.py
DB_PATH = '../LUMI/database/alerts.db'
```

### 选项3：仅用历史数据 + 手动导入

- LUMI使用独立数据库
- 定期运行导入脚本更新数据
- 适合演示和教学场景

---

## 🔄 更新后的配置

### server.js（已自动更新）
```javascript
// 之前
const dbFile = path.join(__dirname, '..', 'duolume-master', 'utils', 'database', 'app.db');

// 现在
const dbFile = path.join(__dirname, 'database', 'alerts.db');
```

### import-historical-crashes.js（已自动更新）
```javascript
// 之前
const dbPath = path.join(__dirname, '../../duolume-master/utils/database/app.db');

// 现在
const dbPath = path.join(__dirname, '..', 'database', 'alerts.db');
```

---

## 🎮 启动LUMI

### 1. 确保数据库已初始化
```bash
cd LUMI/scripts
node setup-database.js
```

### 2. 启动服务器
```bash
cd LUMI
npm run dev
```

### 3. 访问应用
- http://localhost:3000/black-swan
- http://localhost:3000/black-swan-terminal

---

## 📊 数据管理

### 备份数据库
```bash
# Windows
copy LUMI\database\alerts.db LUMI\database\alerts.db.backup

# Linux/Mac
cp LUMI/database/alerts.db LUMI/database/alerts.db.backup
```

### 清空数据
```bash
cd LUMI
sqlite3 database/alerts.db "DELETE FROM alerts;"
```

### 重新导入
```bash
cd LUMI/scripts
node import-historical-crashes.js
```

---

## 🚢 部署优势

### 之前
```bash
# 需要部署两个项目
deploy/
├── duolume-master/  (需要)
│   └── utils/database/app.db
└── LUMI/            (依赖上面)
```

### 现在
```bash
# 只需部署LUMI
deploy/
└── LUMI/            (完全独立)
    └── database/alerts.db
```

**部署更简单**：
- ✅ 单一项目
- ✅ 无外部依赖
- ✅ 易于容器化
- ✅ 易于版本控制

---

## ⚠️ 注意事项

### 旧数据库不会被删除
- 迁移后，旧数据库仍然存在
- 可以作为备份保留
- 如果确认无误，可以手动删除

### 预警系统配置
- 如果需要实时数据，需要配置预警系统
- 可以选择让预警系统写入新数据库
- 或者定期同步数据

---

## 🎉 完成！

现在LUMI拥有：
- ✅ 独立的数据库
- ✅ 完整的历史事件
- ✅ 独立运行能力
- ✅ 简化的部署流程

**LUMI现在是一个完全独立的应用！** 🚀

---

## 📞 故障排查

### 问题1：找不到旧数据库
**解决**：跳过迁移步骤，直接初始化新数据库

### 问题2：数据没有显示
**解决**：
1. 检查数据库是否有数据：`sqlite3 database/alerts.db "SELECT COUNT(*) FROM alerts;"`
2. 重启LUMI服务器
3. 检查浏览器控制台错误

### 问题3：权限问题
**解决**：确保LUMI/database目录有写权限

---

**现在就开始迁移到独立数据库吧！** 💪









