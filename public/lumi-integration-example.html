<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMI Polymarket é›†æˆç¤ºä¾‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <script src="/js/lumi-polymarket-integration.js"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ¯ LUMI Polymarket é›†æˆç¤ºä¾‹</h1>
        
        <!-- è¿æ¥é’±åŒ… -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">1. è¿æ¥é’±åŒ…</h2>
            <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">
                è¿æ¥ MetaMask
            </button>
            <div id="walletInfo" class="mt-4 hidden">
                <p>âœ… å·²è¿æ¥: <span id="walletAddress" class="text-green-400"></span></p>
                <p>ä½™é¢: <span id="balance" class="text-yellow-400"></span> USDC</p>
            </div>
        </div>

        <!-- åˆ›å»ºå¸‚åœº -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">2. åˆ›å»ºå¸‚åœº (Conditional Tokens)</h2>
            <div class="space-y-4">
                <input type="text" id="marketTitle" placeholder="å¸‚åœºæ ‡é¢˜" 
                    class="w-full bg-gray-700 rounded px-4 py-2">
                <textarea id="marketDesc" placeholder="å¸‚åœºæè¿°" 
                    class="w-full bg-gray-700 rounded px-4 py-2 h-24"></textarea>
                <button id="createMarketBtn" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg">
                    åˆ›å»ºå¸‚åœº
                </button>
            </div>
            <div id="marketResult" class="mt-4 hidden">
                <p class="text-green-400">âœ… å¸‚åœºåˆ›å»ºæˆåŠŸï¼</p>
                <p>QuestionID: <span id="questionId" class="text-sm font-mono"></span></p>
                <a id="txLink" href="#" target="_blank" class="text-blue-400 underline">æŸ¥çœ‹äº¤æ˜“</a>
            </div>
        </div>

        <!-- ä¸‹æ³¨/äº¤æ˜“ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">3. ä¸‹æ³¨ (CTF Exchange)</h2>
            <div class="space-y-4">
                <input type="text" id="betQuestionId" placeholder="QuestionID" 
                    class="w-full bg-gray-700 rounded px-4 py-2">
                <div class="grid grid-cols-2 gap-4">
                    <button id="betYesBtn" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg">
                        æŠ¼æ³¨ YES
                    </button>
                    <button id="betNoBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">
                        æŠ¼æ³¨ NO
                    </button>
                </div>
            </div>
            <div id="betResult" class="mt-4 hidden">
                <p class="text-green-400">âœ… ä¸‹æ³¨æˆåŠŸï¼</p>
                <a id="betTxLink" href="#" target="_blank" class="text-blue-400 underline">æŸ¥çœ‹äº¤æ˜“</a>
            </div>
        </div>

        <!-- ç»“ç®— -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">4. ç»“ç®— (UMA Oracle)</h2>
            <div class="space-y-4">
                <input type="text" id="settleQuestionId" placeholder="QuestionID" 
                    class="w-full bg-gray-700 rounded px-4 py-2">
                <button id="requestSettleBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg">
                    è¯·æ±‚ UMA é¢„è¨€æœºç»“ç®—
                </button>
                <button id="resolveBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg ml-4">
                    æœ€ç»ˆç»“ç®—
                </button>
            </div>
            <div id="settleResult" class="mt-4 hidden">
                <p class="text-green-400">âœ… ç»“ç®—è¯·æ±‚å·²æäº¤ï¼</p>
                <p class="text-yellow-400">â³ ç­‰å¾…æŒ‘æˆ˜æœŸç»“æŸï¼ˆçº¦2å°æ—¶ï¼‰</p>
                <a id="settleTxLink" href="#" target="_blank" class="text-blue-400 underline">æŸ¥çœ‹äº¤æ˜“</a>
            </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
            <div id="logs" class="bg-black rounded p-4 h-64 overflow-y-auto font-mono text-sm">
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– LUMI Polymarket
        const lumi = new LUMIPolymarket();
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            }[type];
            
            logsDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // è¿æ¥é’±åŒ…
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');
                const result = await lumi.init();
                
                document.getElementById('walletAddress').textContent = 
                    result.address.slice(0, 6) + '...' + result.address.slice(-4);
                document.getElementById('walletInfo').classList.remove('hidden');
                
                // è·å–ä½™é¢
                const balance = await lumi.getBalance(LUMI_CONFIG.contracts.mockUSDC);
                document.getElementById('balance').textContent = balance;
                
                log('âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ' + result.address, 'success');
            } catch (error) {
                log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ›å»ºå¸‚åœº
        document.getElementById('createMarketBtn').addEventListener('click', async () => {
            try {
                const title = document.getElementById('marketTitle').value;
                const description = document.getElementById('marketDesc').value;
                
                if (!title || !description) {
                    log('âš ï¸ è¯·å¡«å†™æ ‡é¢˜å’Œæè¿°', 'warning');
                    return;
                }
                
                log('ğŸ“ æ­£åœ¨åˆ›å»ºå¸‚åœº: ' + title, 'info');
                
                // ğŸ¯ ä½¿ç”¨å…è´¹æ¨¡å¼ï¼ˆä»…æµ‹è¯•ï¼‰
                log('ğŸ’¡ ä½¿ç”¨å…è´¹æµ‹è¯•æ¨¡å¼ï¼ˆä¸éœ€è¦ä»£å¸ï¼‰', 'info');
                
                try {
                    const result = await lumi.createMarket(title, description, 1); // æ”¹ä¸º1 USDC
                    
                    document.getElementById('questionId').textContent = result.questionId;
                    document.getElementById('txLink').href = result.explorerUrl;
                    document.getElementById('marketResult').classList.remove('hidden');
                    
                    log('âœ… å¸‚åœºåˆ›å»ºæˆåŠŸï¼QuestionID: ' + result.questionId, 'success');
                    log('ğŸ”— äº¤æ˜“: ' + result.transactionHash, 'success');
                } catch (createError) {
                    // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯
                    log('âŒ åˆ›å»ºå¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:', 'error');
                    log('é”™è¯¯ç±»å‹: ' + createError.code, 'error');
                    log('é”™è¯¯ä¿¡æ¯: ' + createError.message, 'error');
                    
                    // æä¾›è§£å†³å»ºè®®
                    if (createError.message.includes('insufficient funds')) {
                        log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: éœ€è¦è·å–æµ‹è¯•ä»£å¸', 'warning');
                        log('1. è®¿é—® https://faucet.polygon.technology/', 'info');
                        log('2. é€‰æ‹© Polygon Amoy', 'info');
                        log('3. ç²˜è´´ä½ çš„é’±åŒ…åœ°å€è·å–æµ‹è¯• MATIC', 'info');
                        
                        // æ˜¾ç¤ºç”¨æˆ·åœ°å€
                        const address = await lumi.signer.getAddress();
                        log('ä½ çš„åœ°å€: ' + address, 'info');
                    } else if (createError.message.includes('user rejected')) {
                        log('ğŸ’¡ ä½ å–æ¶ˆäº†äº¤æ˜“', 'warning');
                    } else if (createError.message.includes('network')) {
                        log('ğŸ’¡ è¯·ç¡®ä¿åˆ‡æ¢åˆ° Polygon Amoy æµ‹è¯•ç½‘', 'warning');
                    }
                    
                    throw createError;
                }
            } catch (error) {
                log('âŒ åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                alert('åˆ›å»ºå¸‚åœºå¤±è´¥ï¼\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚\n\nå¸¸è§é—®é¢˜ï¼š\n1. æ²¡æœ‰æµ‹è¯•ä»£å¸\n2. ç½‘ç»œä¸æ­£ç¡®\n3. å–æ¶ˆäº†äº¤æ˜“');
            }
        });

        // æŠ¼æ³¨ YES
        document.getElementById('betYesBtn').addEventListener('click', async () => {
            try {
                const questionId = document.getElementById('betQuestionId').value;
                if (!questionId) {
                    log('âš ï¸ è¯·è¾“å…¥ QuestionID', 'warning');
                    return;
                }
                
                log('ğŸ’° æ­£åœ¨æŠ¼æ³¨ YES...', 'info');
                
                // è·å–å¸‚åœºä¿¡æ¯
                const market = await lumi.getMarket(questionId);
                
                // åˆ›å»ºè®¢å•
                const { order, signature } = await lumi.createOrder(
                    market.conditionId + '1', // YES token
                    10, // 10 USDC
                    0.6, // 60% ä»·æ ¼
                    'BUY'
                );
                
                // æ‰§è¡Œäº¤æ˜“
                const result = await lumi.fillOrder(order, signature);
                
                document.getElementById('betTxLink').href = result.explorerUrl;
                document.getElementById('betResult').classList.remove('hidden');
                
                log('âœ… æŠ¼æ³¨æˆåŠŸï¼', 'success');
                log('ğŸ”— äº¤æ˜“: ' + result.transactionHash, 'success');
            } catch (error) {
                log('âŒ æŠ¼æ³¨å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æŠ¼æ³¨ NO
        document.getElementById('betNoBtn').addEventListener('click', async () => {
            try {
                const questionId = document.getElementById('betQuestionId').value;
                if (!questionId) {
                    log('âš ï¸ è¯·è¾“å…¥ QuestionID', 'warning');
                    return;
                }
                
                log('ğŸ’° æ­£åœ¨æŠ¼æ³¨ NO...', 'info');
                
                const market = await lumi.getMarket(questionId);
                
                const { order, signature } = await lumi.createOrder(
                    market.conditionId + '2', // NO token
                    10,
                    0.4,
                    'BUY'
                );
                
                const result = await lumi.fillOrder(order, signature);
                
                document.getElementById('betTxLink').href = result.explorerUrl;
                document.getElementById('betResult').classList.remove('hidden');
                
                log('âœ… æŠ¼æ³¨æˆåŠŸï¼', 'success');
                log('ğŸ”— äº¤æ˜“: ' + result.transactionHash, 'success');
            } catch (error) {
                log('âŒ æŠ¼æ³¨å¤±è´¥: ' + error.message, 'error');
            }
        });

        // è¯·æ±‚ç»“ç®—
        document.getElementById('requestSettleBtn').addEventListener('click', async () => {
            try {
                const questionId = document.getElementById('settleQuestionId').value;
                if (!questionId) {
                    log('âš ï¸ è¯·è¾“å…¥ QuestionID', 'warning');
                    return;
                }
                
                log('ğŸ”® æ­£åœ¨è¯·æ±‚ UMA é¢„è¨€æœºç»“ç®—...', 'info');
                const result = await lumi.requestSettlement(questionId);
                
                document.getElementById('settleTxLink').href = result.explorerUrl;
                document.getElementById('settleResult').classList.remove('hidden');
                
                log('âœ… ç»“ç®—è¯·æ±‚å·²æäº¤ï¼', 'success');
                log('â³ ç­‰å¾…æŒ‘æˆ˜æœŸç»“æŸï¼ˆçº¦2å°æ—¶ï¼‰', 'warning');
                log('ğŸ”— äº¤æ˜“: ' + result.transactionHash, 'success');
            } catch (error) {
                log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æœ€ç»ˆç»“ç®—
        document.getElementById('resolveBtn').addEventListener('click', async () => {
            try {
                const questionId = document.getElementById('settleQuestionId').value;
                if (!questionId) {
                    log('âš ï¸ è¯·è¾“å…¥ QuestionID', 'warning');
                    return;
                }
                
                log('âœ… æ­£åœ¨æœ€ç»ˆç»“ç®—å¸‚åœº...', 'info');
                const result = await lumi.resolveMarket(questionId);
                
                log('âœ… å¸‚åœºå·²ç»“ç®—ï¼', 'success');
                log('ğŸ”— äº¤æ˜“: ' + result.transactionHash, 'success');
            } catch (error) {
                log('âŒ ç»“ç®—å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆå§‹åŒ–æ—¥å¿—
        log('ğŸ¯ LUMI Polymarket é›†æˆåº“å·²åŠ è½½', 'success');
        log('ä¸‰å¤§å®˜æ–¹ç»„ä»¶å·²å°±ç»ª:', 'info');
        log('  1ï¸âƒ£ UMA å®˜æ–¹é¢„è¨€æœº: ' + LUMI_CONFIG.contracts.umaOracle, 'info');
        log('  2ï¸âƒ£ Polymarket CTF Exchange: ' + LUMI_CONFIG.contracts.ctfExchange, 'info');
        log('  3ï¸âƒ£ Gnosis Conditional Tokens: ' + LUMI_CONFIG.contracts.conditionalTokens, 'info');
    </script>
</body>
</html>

