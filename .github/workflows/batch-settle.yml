name: Batch Settle Trades

on:
  schedule:
    # æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
    # æ³¨æ„ï¼šGitHub Actions ä½¿ç”¨ UTC æ—¶é—´
    - cron: '*/5 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  settle-trades:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Batch Settle API
        run: |
          echo "ğŸ”„ è§¦å‘æ‰¹é‡ç»“ç®— API..."
          echo "æ—¶é—´: $(date)"
          
          # æ£€æŸ¥ CRON_SECRET æ˜¯å¦é…ç½®
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ é”™è¯¯: CRON_SECRET æœªé…ç½®"
            echo "è¯·åˆ° GitHub Settings > Secrets and variables > Actions ä¸­æ·»åŠ  CRON_SECRET"
            exit 1
          fi
          
          # è°ƒç”¨ Vercel API
          # âš ï¸ é‡è¦ï¼šè¯·å°† YOUR_VERCEL_APP_URL æ›¿æ¢ä¸ºä½ çš„å®é™… Vercel åŸŸå
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            https://YOUR_VERCEL_APP_URL.vercel.app/api/cron/settle-trades)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          echo "å“åº”å†…å®¹:"
          echo "$body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æ‰¹é‡ç»“ç®—è§¦å‘æˆåŠŸ"
          else
            echo "âŒ æ‰¹é‡ç»“ç®—è§¦å‘å¤±è´¥ (HTTP $http_code)"
            # ä¸é€€å‡ºï¼Œé¿å…é˜»æ­¢åç»­æ‰§è¡Œ
            # exit 1
          fi

