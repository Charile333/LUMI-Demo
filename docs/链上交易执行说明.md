# 🔗 链上交易执行说明

## ✅ 已实现功能

### 1. 完整的链上执行 API

`/api/orders/execute-onchain` 现已完整实现：

- ✅ 调用 CTF Exchange 合约
- ✅ 执行订单填充
- ✅ 处理交易签名
- ✅ 等待交易确认
- ✅ 更新订单状态

### 2. 两种执行模式

#### 模式 A: 平台中继（推荐用于测试）

使用平台钱包执行交易：
- 需要配置 `PLATFORM_WALLET_PRIVATE_KEY`
- 平台代付 Gas 费
- 用户无需手动签名

#### 模式 B: 前端执行（生产环境推荐）

返回交易数据，由用户在前端执行：
- 用户自己支付 Gas 费
- 更去中心化
- 更安全

## 🔧 配置要求

### 环境变量

在 `.env.local` 中配置：

```env
# CTF Exchange 合约地址（Polygon Amoy）
NEXT_PUBLIC_CTF_EXCHANGE_ADDRESS=0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40

# RPC URL
NEXT_PUBLIC_RPC_URL=https://rpc-amoy.polygon.technology

# 平台钱包私钥（可选，用于中继模式）
PLATFORM_WALLET_PRIVATE_KEY=your_private_key_here
```

### 平台钱包要求

如果使用中继模式，平台钱包需要：
- ✅ 有足够的 MATIC（Gas 费）
- ✅ 有足够的 USDC 授权给 CTF Exchange
- ✅ 私钥安全存储

## 📋 完整交易流程

### 流程图

```
1. 用户 A 下单（买入）
   ↓
2. 链下撮合匹配到用户 B（卖出）
   ↓
3. API 返回 onChainExecution 数据
   ↓
4. 前端显示"执行链上交易"按钮
   ↓
5. 用户点击按钮
   ↓
6. 调用 /api/orders/execute-onchain
   ↓
7. 两种情况：
   
   A. 有平台钱包
      - 平台钱包执行交易
      - 返回交易哈希
      - 更新订单状态
      
   B. 无平台钱包
      - 返回交易数据
      - 前端调用钱包
      - 用户签名并提交
   ↓
8. 交易上链确认
   ↓
9. ✅ 完成
```

## 🎯 API 使用示例

### 请求

```bash
curl -X POST http://localhost:3000/api/orders/execute-onchain \
  -H "Content-Type: application/json" \
  -d '{
    "ctfOrder": {
      "salt": "123456789",
      "maker": "0x...",
      "signer": "0x...",
      "taker": "0x0000000000000000000000000000000000000000",
      "tokenId": "12345",
      "makerAmount": "1000000000000000000",
      "takerAmount": "500000",
      "expiration": "1735689600",
      "nonce": "1",
      "feeRateBps": "0",
      "side": 0,
      "signatureType": 0
    },
    "makerSignature": "0x...",
    "fillAmount": "1000000000000000000",
    "takerAddress": "0x...",
    "makerOrderId": 1,
    "takerOrderId": 2
  }'
```

### 响应（成功）

```json
{
  "success": true,
  "message": "链上交易执行成功",
  "transactionHash": "0x1234...abcd",
  "blockNumber": 12345678,
  "gasUsed": "234567",
  "explorerUrl": "https://amoy.polygonscan.com/tx/0x1234...abcd"
}
```

### 响应（需要前端执行）

```json
{
  "success": true,
  "requiresFrontendExecution": true,
  "message": "请在前端使用您的钱包执行此交易",
  "transactionData": {
    "to": "0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40",
    "data": "0x...",
    "value": "0"
  },
  "explorerUrl": "https://amoy.polygonscan.com/address/0x..."
}
```

## ⚠️ 注意事项

### 1. Gas 费

- 每笔交易需要 MATIC 作为 Gas 费
- 预估 Gas：~200,000-500,000
- 建议钱包至少有 0.1 MATIC

### 2. 授权

用户需要先授权 USDC 给 CTF Exchange：

```javascript
// 授权 USDC
await usdcContract.approve(
  CTF_EXCHANGE_ADDRESS,
  ethers.constants.MaxUint256
);
```

### 3. 网络

- 必须连接到 Polygon Amoy 测试网
- Chain ID: 80002

### 4. 订单匹配

- 只有成功匹配的订单才能执行链上交易
- 价格必须匹配
- 金额必须匹配

## 🔍 故障排查

### 错误：Gas 费不足

**解决**：
```
访问 Polygon Faucet 获取测试 MATIC
https://faucet.polygon.technology/
```

### 错误：交易可能会失败

**原因**：
1. USDC 余额不足
2. 未授权 CTF Exchange
3. 订单已过期或已填充

**解决**：
1. 检查 USDC 余额
2. 执行授权交易
3. 检查订单状态

### 错误：未配置平台钱包

**解决**：
1. 配置 `PLATFORM_WALLET_PRIVATE_KEY`
2. 或使用前端执行模式

## 📊 测试步骤

### 1. 配置环境

```env
NEXT_PUBLIC_CTF_EXCHANGE_ADDRESS=0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40
NEXT_PUBLIC_RPC_URL=https://rpc-amoy.polygon.technology
PLATFORM_WALLET_PRIVATE_KEY=your_private_key
```

### 2. 准备测试账户

- 账户 A：买方（需要 USDC）
- 账户 B：卖方（需要 Outcome Tokens）
- 平台钱包：中继（需要 MATIC）

### 3. 执行测试

1. 账户 A 下买单
2. 账户 B 下卖单
3. 系统自动撮合
4. 点击"执行链上交易"
5. 等待交易确认

### 4. 验证结果

- 查看交易哈希
- 检查 Polygonscan
- 确认代币余额变化

## 🔗 相关文档

- [链上交易方案对比](./链上交易方案对比.md)
- [激活市场指南](./激活市场指南.md)
- [测试步骤](./测试步骤.md)

## 💡 后续优化

### 短期

- [ ] 添加交易失败重试机制
- [ ] 优化 Gas 费估算
- [ ] 添加交易状态查询

### 长期

- [ ] 支持批量执行
- [ ] 添加交易队列
- [ ] 集成 Gelato 自动执行
- [ ] 支持 EIP-1559

## ✅ 总结

链上执行 API 已完整实现，支持：

- ✅ 平台中继模式
- ✅ 前端执行模式
- ✅ 交易确认
- ✅ 状态更新
- ✅ 错误处理

**现在可以进行完整的链上交易测试了！**

