# 统一钱包连接组件方案

## 当前问题分析

### 为什么没有统一使用 `WalletConnect`？

**主要原因**：

1. **历史遗留代码**
   - 项目在不同时期开发，使用了不同的钱包连接方式
   - `ConnectWallet` 组件是早期开发的，只支持 MetaMask
   - `WalletConnect` 是后来引入的，基于 RainbowKit

2. **UI 需求不同**
   - 有些地方只需要简单的提示文字（如 `OrderForm` 显示"请先连接钱包"）
   - 有些地方需要完整的连接按钮（如导航栏）
   - 有些地方需要自定义样式（如 `MyOrders` 的按钮）

3. **开发时没有统一规范**
   - 不同开发者使用了不同的实现方式
   - 没有制定统一的组件使用标准

### 当前使用情况

| 位置 | 当前实现 | 应该使用 |
|------|----------|----------|
| **导航栏** | `WalletConnect` ✅ | `WalletConnect` ✅ |
| **CompactTradeModal** | `WalletConnect` ✅ | `WalletConnect` ✅ |
| **OrderForm** | 文字提示 + `useWallet()` ⚠️ | 可以保持，或使用 `WalletConnect` |
| **MyOrders** | 自定义按钮 ⚠️ | 应该使用 `WalletConnect` 或 `useWallet()` |
| **trade 页面** | `ConnectWallet` ❌ | 应该使用 `WalletConnect` |
| **QuickTradeModal** | `useWallet()` + 文字提示 ⚠️ | 可以保持，或使用 `WalletConnect` |

---

## 统一方案

### 方案 1：完全统一使用 `WalletConnect` 组件（推荐）

**优点**：
- ✅ UI 完全统一
- ✅ 支持多种钱包
- ✅ 自动处理网络切换
- ✅ 用户体验一致

**缺点**：
- ⚠️ 某些场景下可能 UI 过大（如 `OrderForm` 只需要简单提示）

**适用场景**：
- 需要完整连接功能的页面/组件
- 用户主动操作的地方（如导航栏、弹窗）

### 方案 2：混合使用（当前方案优化）

**原则**：
- **需要完整连接功能** → 使用 `WalletConnect` 组件
- **只需要状态检查** → 使用 `useWallet()` hook + 自定义 UI

**优点**：
- ✅ 灵活性高
- ✅ 可以根据场景选择合适的方式
- ✅ 保持代码简洁

**缺点**：
- ⚠️ 需要维护两套逻辑
- ⚠️ 需要确保所有地方都使用 `useWallet()` hook

---

## 推荐统一方案

### 1. 统一使用 `useWallet()` Hook

**所有组件都应该使用 `useWallet()` hook 来获取钱包状态**，而不是自己管理连接。

**修改示例**：

```typescript
// ❌ 错误：自己管理连接
const [account, setAccount] = useState<string | null>(null);
useEffect(() => {
  const accounts = await window.ethereum.request({ 
    method: 'eth_requestAccounts' 
  });
  setAccount(accounts[0]);
}, []);

// ✅ 正确：使用统一的 hook
import { useWallet } from '@/app/provider-wagmi';
const { address, isConnected, connectWallet } = useWallet();
```

### 2. 根据场景选择 UI 组件

**场景 A：需要完整连接功能**
- 使用 `WalletConnect` 组件
- 位置：导航栏、弹窗、独立页面

**场景 B：只需要状态提示**
- 使用 `useWallet()` hook + 自定义 UI
- 位置：表单内部、列表项

### 3. 创建统一的连接按钮组件

创建一个轻量级的连接按钮组件，内部使用 `useWallet()` hook：

```typescript
// components/wallet/ConnectButton.tsx
import { useWallet } from '@/app/provider-wagmi';

export function ConnectButton({ 
  variant = 'default',
  size = 'md' 
}: { 
  variant?: 'default' | 'compact';
  size?: 'sm' | 'md' | 'lg';
}) {
  const { address, isConnected, connectWallet } = useWallet();
  
  if (isConnected) {
    return (
      <div className="text-sm text-gray-300">
        已连接: {address?.substring(0, 6)}...{address?.substring(38)}
      </div>
    );
  }
  
  return (
    <button
      onClick={connectWallet}
      className={`bg-amber-400 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors ${
        size === 'sm' ? 'px-4 py-1.5 text-sm' :
        size === 'md' ? 'px-6 py-2.5' :
        'px-8 py-3 text-lg'
      }`}
    >
      连接钱包
    </button>
  );
}
```

---

## 具体修改建议

### 1. 修改 `MyOrders` 组件

**当前**：自己管理连接，自定义按钮

**修改为**：使用 `useWallet()` hook + `WalletConnect` 或 `ConnectButton`

```typescript
// components/trading/MyOrders.tsx
import { useWallet } from '@/app/provider-wagmi';
import WalletConnect from '@/components/WalletConnect';

export default function MyOrders({ marketId }: MyOrdersProps) {
  const { address: account, isConnected } = useWallet();
  
  if (!account) {
    return (
      <div className="text-center py-8">
        <div className="text-gray-400 mb-4">
          请先连接钱包查看订单
        </div>
        <WalletConnect />  {/* 使用统一的组件 */}
      </div>
    );
  }
  
  // ... 其他代码
}
```

### 2. 修改 `trade` 页面

**当前**：使用 `ConnectWallet` 组件

**修改为**：使用 `WalletConnect` 组件

```typescript
// app/trade/[marketId]/page.tsx
// ❌ 修改前
import { ConnectWallet } from '@/components/wallet/ConnectWallet';
<ConnectWallet />

// ✅ 修改后
import WalletConnect from '@/components/WalletConnect';
<WalletConnect />
```

### 3. 保持 `OrderForm` 的当前实现

**当前**：使用 `useWallet()` hook + 文字提示

**建议**：保持当前实现，因为只需要简单的状态提示，不需要完整的连接按钮。

---

## 实施步骤

### 阶段 1：统一 Hook 使用（高优先级）

1. ✅ 确保所有组件都使用 `useWallet()` hook
2. ✅ 移除所有自己管理连接的代码
3. ✅ 修复 `MyOrders` 组件

### 阶段 2：统一 UI 组件（中优先级）

1. 将 `trade` 页面的 `ConnectWallet` 替换为 `WalletConnect`
2. 将 `MyOrders` 的连接按钮替换为 `WalletConnect` 或 `ConnectButton`
3. 创建统一的 `ConnectButton` 组件（可选）

### 阶段 3：清理旧代码（低优先级）

1. 删除 `ConnectWallet` 组件（如果不再使用）
2. 删除 `app/provider.tsx`（如果不再使用）
3. 更新文档

---

## 统一后的架构

```
全局 Provider (app/provider-wagmi.tsx)
    ↓
useWallet() Hook (所有组件使用)
    ↓
    ├─ WalletConnect 组件 (完整功能)
    │   └─ 导航栏、弹窗、独立页面
    │
    ├─ ConnectButton 组件 (轻量级)
    │   └─ 表单、列表项
    │
    └─ 自定义 UI (使用 hook)
        └─ 简单提示、状态显示
```

---

## 总结

**为什么没有统一**：
1. 历史遗留代码
2. UI 需求不同
3. 没有统一规范

**如何统一**：
1. ✅ 所有组件使用 `useWallet()` hook
2. ✅ 根据场景选择合适的 UI 组件
3. ✅ 移除自己管理连接的代码

**好处**：
- ✅ 避免连接冲突
- ✅ UI 统一
- ✅ 代码维护更容易
- ✅ 用户体验更好

