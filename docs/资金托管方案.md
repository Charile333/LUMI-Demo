# 💰 LUMI 资金托管方案

## 🎯 需求说明

用户买入 YES/NO 时，资金先存放在合约中，等结果出来后自动分发奖励。

---

## 📋 方案对比

| 方案 | 优点 | 缺点 | 适用场景 | 实现难度 |
|------|------|------|----------|----------|
| **方案1：独立托管池合约** | 灵活、可升级、易审计 | 需要额外部署 | 大规模、需要独立管理 | ⭐⭐⭐ |
| **方案2：集成到CTFExchange** | 一体化、减少Gas | 合约复杂、升级困难 | 中小规模、一体化需求 | ⭐⭐ |
| **方案3：利用CTF框架** | 标准化、无需额外合约 | 依赖CTF机制 | 完全去中心化 | ⭐⭐⭐⭐ |
| **方案4：混合方案** | 灵活、兼容现有架构 | 需要链下配合 | 渐进式升级 | ⭐⭐ |

---

## 🚀 方案1：利用CTF框架（推荐，参考Polymarket）⭐

### ⚠️ 重要说明

**主流平台（Polymarket、Omen）实际上不需要额外的托管合约！**

他们使用 **CTF (Conditional Tokens Framework)** 框架本身来处理资金托管。

### 架构设计

```
用户买入 YES/NO
    ↓
资金转换为 CTF Position Tokens
    ↓
Position Tokens 存储在用户钱包中（不是合约中）
    ↓
市场解析后，Position Tokens 可兑换为 USDC
    ↓
用户调用 redeemPositions() 获得奖励
```

### 核心机制

1. **买入时**：
   - 用户支付 USDC
   - 获得对应数量的 Position Tokens（YES 或 NO）
   - Position Tokens 存储在**用户自己的钱包**中

2. **持有期间**：
   - Position Tokens 在用户钱包中
   - 用户可以随时交易这些 Tokens（在订单簿上）
   - **资金不在合约中托管，而是在用户钱包中**

3. **市场解析后**：
   - 市场解析，设置 payout ratios
   - Position Tokens 变成可兑换状态
   - 用户调用 `redeemPositions()` 获得 USDC 奖励

### 实现要点

- ✅ **无需额外托管合约**：使用现有的 CTF 框架
- ✅ **用户完全控制**：资金在用户钱包中
- ✅ **可交易**：Position Tokens 可以在订单簿上交易
- ✅ **标准化**：使用成熟的 CTF 框架
- ⚠️ **需要用户主动 redeem**：市场解析后需要用户调用函数

### 技术实现

```solidity
// 使用现有的 CTF 框架
// 1. 用户买入时
ctf.safeTransferFrom(seller, user, tokenId, amount, "");

// 2. Position Tokens 在用户钱包中
// 3. 市场解析后
ctf.reportPayouts(conditionId, payouts);

// 4. 用户提取奖励
ctf.redeemPositions(
    collateral,
    conditionId,
    positionIds,
    amounts
);
```

### 代码位置

- 合约：使用现有 `ConditionalTokens.sol`（无需新合约）
- 集成代码：`lib/ctf/redeem.ts`
- 前端：自动提示用户 redeem

### 参考

详见：[主流平台资金托管方式对比.md](./主流平台资金托管方式对比.md)

---

## 🔧 方案3：集成到CTFExchange

### 架构设计

```
CTFExchange 合约
    ├─ 订单撮合（现有）
    ├─ 资金托管（新增）
    └─ 奖励分发（新增）
```

### 核心功能

1. **托管买入**：`depositAndBuy()` - 存入资金并买入
2. **托管卖出**：`depositAndSell()` - 存入资金并卖出
3. **结算分发**：`settleMarket()` - 市场解析后分发
4. **查询余额**：`getEscrowBalance()` - 查询托管余额

### 实现要点

- ✅ 在现有合约中添加托管映射
- ✅ 修改 `fillOrder` 支持托管模式
- ✅ 添加结算函数
- ⚠️ 需要升级现有合约

### 代码位置

- 合约：`contracts/CTFExchange.sol`（修改）
- 集成代码：`lib/ctf-exchange/escrow.ts`

---

## 🔧 方案2：独立托管池合约（如果需要完全托管）

### ⚠️ 注意

**这不是主流平台的做法！** 主流平台（Polymarket、Omen）都使用方案1（CTF框架）。

只有在特殊需求下才需要这个方案，比如：
- 需要资金完全托管在合约中
- 需要自动分发奖励（无需用户操作）
- 需要类似 Augur 的完全托管模式

### 架构设计

```
用户买入 YES/NO
    ↓
资金存入 EscrowPool 合约
    ↓
等待市场结果
    ↓
市场解析后自动分发奖励
```

### 核心功能

1. **存款（Deposit）**：用户买入时，资金存入托管池
2. **锁定（Lock）**：市场关闭后锁定资金
3. **结算（Settle）**：结果出来后，按比例分发
4. **提取（Withdraw）**：用户提取奖励

### 实现要点

- ✅ 每个市场独立的资金池
- ✅ 支持 YES/NO 两种结果
- ✅ 自动计算奖励比例
- ✅ 支持批量结算
- ✅ 紧急提取功能（管理员）

### 代码位置

- 合约：`contracts/EscrowPool.sol`（需要新建）
- 部署脚本：`scripts/deploy-escrow-pool.js`
- 集成代码：`lib/escrow/service.ts`

---

## 🔄 方案4：混合方案（渐进式）

### 架构设计

```
链下撮合（现有）
    ↓
链上托管（新增）
    ├─ 批量存入托管池
    └─ 定期结算分发
```

### 核心功能

1. **链下撮合**：保持现有快速撮合
2. **批量托管**：定期将链下订单批量存入托管池
3. **自动结算**：市场解析后自动分发
4. **链上记录**：所有资金流动上链可查

### 实现要点

- ✅ 兼容现有架构
- ✅ 渐进式升级
- ✅ 链下快速 + 链上安全
- ⚠️ 需要定时任务配合

### 代码位置

- 合约：`contracts/EscrowPool.sol`
- 定时任务：`scripts/batch-escrow.ts`
- 集成代码：`lib/escrow/hybrid.ts`

---

## 💡 推荐方案

### ⭐ 推荐：方案1 - 利用CTF框架（参考Polymarket）

**理由**：
- ✅ **与主流平台一致**：Polymarket（最成功）使用这种方式
- ✅ **无需额外合约**：使用现有的 CTF 框架
- ✅ **用户完全控制**：资金在用户钱包中
- ✅ **标准化**：使用成熟的 CTF 框架
- ✅ **可交易**：Position Tokens 可以在订单簿上交易

**实现**：
- ✅ 使用现有的 `ConditionalTokens.sol`
- ✅ 市场解析后，前端自动提示用户 redeem
- ✅ 可以批量 redeem 多个市场的奖励

### 备选：方案2 - 独立托管池合约

**适用场景**：
- ⚠️ 需要资金完全托管在合约中
- ⚠️ 需要自动分发奖励（无需用户操作）
- ⚠️ 需要类似 Augur 的完全托管模式

**注意**：这不是主流平台的做法，会增加开发复杂度。

---

## 📊 各方案详细实现

详见：
- [方案1实现](./资金托管方案1-独立托管池.md)
- [方案2实现](./资金托管方案2-集成CTFExchange.md)
- [方案3实现](./资金托管方案3-CTF框架.md)
- [方案4实现](./资金托管方案4-混合方案.md)

