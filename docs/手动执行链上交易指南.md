# 🔗 手动执行链上交易指南

## 📋 当前状态

目前只有 **`QuickTradeModal`** 组件支持手动执行链上交易。  
`CompactTradeModal` 暂不支持，需要添加。

---

## 🎯 手动执行步骤（QuickTradeModal）

### 前置条件

1. ✅ **市场已上链**
   - 市场必须有 `condition_id`
   - 在管理页面点击"激活上链"后会有 `condition_id`

2. ✅ **钱包已连接**
   - 确保已连接钱包（MetaMask/OKX/Coinbase 等）
   - 钱包网络必须是 Polygon Amoy（Chain ID: 80002）

3. ✅ **钱包有余额**
   - 至少 0.01 MATIC（Gas 费）
   - 足够的 USDC（用于交易）

### 执行流程

#### 步骤 1: 创建订单并撮合

1. 点击市场卡片的 **YES** 或 **NO** 按钮
2. 在弹窗中：
   - 选择 **买入/卖出**
   - 选择 **YES/NO**
   - 输入 **数量**（例如 $10）
3. 点击 **"买入/卖出"** 按钮提交订单

#### 步骤 2: 等待撮合成功

如果订单匹配成功，会看到：

```
✅ 订单已撮合！

需要执行链上交易以完成资产转移。
点击"执行链上交易"按钮继续。
```

#### 步骤 3: 执行链上交易

1. 弹窗中会显示：
   ```
   ⚡ 订单已撮合，需要执行链上交易完成资产转移
   成交数量: X ，预计支付: Y USDC
   ```

2. 点击 **"🚀 执行链上交易"** 按钮

3. **如果需要 Maker 签名**：
   - 如果当前用户是 Maker（订单创建者），钱包会弹出签名请求
   - 点击"签名"确认

4. **等待交易确认**：
   - 钱包会弹出交易确认
   - 点击"确认"并等待区块确认（~2-5 秒）

5. **交易成功**：
   ```
   ✅ 链上交易成功！
   交易哈希: 0x1234...
   查看: [链接]
   ```

---

## 🔍 如何确认订单是否需要链上执行？

### 检查订单状态

在交易弹窗中：
- ✅ **撮合成功 + 有 `onChainExecution` 数据** → 需要链上执行
- ❌ **撮合成功但无 `onChainExecution`** → 市场未上链，无法执行
- ❌ **未撮合** → 订单挂单中，等待对手盘

### 检查市场状态

访问管理页面 `/admin/markets`：
- ✅ **`blockchain_status = 'created'`** → 市场已上链，可以执行
- ❌ **`blockchain_status = 'not_created'`** → 需要先激活上链

---

## ⚠️ 常见问题

### 问题 1: 看不到"执行链上交易"按钮

**原因**：
- 使用的是 `CompactTradeModal`（不支持链上执行）
- 市场未上链（无 `condition_id`）
- 订单未撮合成功

**解决**：
1. 确认使用的是 `QuickTradeModal`（不是 `CompactTradeModal`）
2. 检查市场是否已上链
3. 确认订单已撮合

### 问题 2: 点击"执行链上交易"后失败

**可能原因**：

#### A. Maker 签名失败
```
错误: 订单需要 Maker 签名。请联系订单创建者完成签名后再执行。
```

**解决**：
- 如果当前用户是 Maker，确保钱包已连接且账户匹配
- 如果当前用户是 Taker，需要等待 Maker 签名

#### B. Gas 费不足
```
错误: insufficient funds for gas
```

**解决**：
1. 访问 Polygon Faucet：https://faucet.polygon.technology/
2. 选择 Amoy 测试网
3. 输入钱包地址获取测试 MATIC

#### C. USDC 授权不足
```
错误: ERC20: transfer amount exceeds allowance
```

**解决**：
1. 需要先授权 USDC 给 CTF Exchange 合约
2. 授权地址：`0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40`

#### D. 网络错误
```
错误: could not detect network
```

**解决**：
1. 确认钱包网络是 Polygon Amoy
2. Chain ID: 80002
3. 如果不对，手动切换到正确网络

### 问题 3: 交易一直 pending

**原因**：
- 网络拥堵
- Gas 费设置过低

**解决**：
1. 等待一段时间（Polygon 确认时间 ~2 秒）
2. 如果长时间未确认，可以尝试：
   - 提高 Gas 费
   - 重新提交交易

---

## 📝 代码示例（开发者参考）

### 手动调用链上执行 API

```typescript
// 1. 获取链上执行数据（从 /api/orders/create 返回）
const { onChainExecution } = result;

// 2. 检查是否需要 Maker 签名
if (!onChainExecution.makerOrder?.signature) {
  // Maker 需要签名
  const signature = await signCTFOrder(ctfOrder, signer);
}

// 3. 执行链上交易
const result = await polymarket.fillOrder(
  ctfOrder,
  makerSignature,
  fillAmount
);

console.log('交易哈希:', result.transactionHash);
```

### 直接调用 API

```bash
curl -X POST http://localhost:3000/api/orders/fill-onchain \
  -H "Content-Type: application/json" \
  -d '{
    "ctfOrder": {
      "salt": "123456789",
      "maker": "0x...",
      "signer": "0x...",
      "taker": "0x0000000000000000000000000000000000000000",
      "tokenId": "12345",
      "makerAmount": "1000000000",
      "takerAmount": "500000000",
      "expiration": "1735689600",
      "nonce": "1",
      "feeRateBps": "0",
      "side": 0,
      "signatureType": 0
    },
    "makerSignature": "0x...",
    "fillAmount": "1000000000",
    "useFrontend": true
  }'
```

---

## 🚀 改进建议

### 1. 添加 CompactTradeModal 的链上执行支持

目前 `CompactTradeModal` 不支持链上执行，建议添加类似 `QuickTradeModal` 的功能。

### 2. 添加"我的订单"页面

显示所有待执行的链上交易，方便用户统一管理。

### 3. 添加自动执行选项

允许用户选择：
- **自动执行**：撮合成功后立即执行（需要授权）
- **手动执行**：当前方式

---

## 📞 需要帮助？

如果遇到问题：
1. 查看浏览器控制台的错误信息
2. 检查钱包网络是否正确
3. 确认市场是否已上链
4. 查看交易哈希在区块链浏览器上的状态


