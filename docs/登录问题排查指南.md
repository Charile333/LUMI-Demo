# 🔍 登录问题排查指南

## 🚨 常见问题

### 问题 1: 输入密码后进不去

#### 可能原因：

1. **环境变量未配置**
   - 没有在 `.env.local` 中配置 `ADMIN_PASSWORD`
   - 环境变量拼写错误

2. **密码不正确**
   - 密码区分大小写
   - 密码前后有空格
   - 配置的密码与输入的密码不一致

3. **本地访问限制**
   - 当前不在本地环境（localhost）
   - 需要设置 `ALLOW_ADMIN_IN_PRODUCTION=true`

4. **Cookie 设置问题**
   - 浏览器阻止了 Cookie
   - sameSite 设置过于严格

5. **开发服务器未重启**
   - 修改 `.env.local` 后没有重启服务器

## 🔍 调试步骤

### 步骤 1: 访问调试页面

打开浏览器，访问：

```
http://localhost:3000/api/admin/debug
```

这个页面会显示：
- 当前环境信息
- 环境变量配置状态
- 是否允许访问管理后台
- 详细的故障排查建议

### 步骤 2: 检查环境变量

#### 2.1 检查 `.env.local` 文件

在项目根目录创建或检查 `.env.local` 文件：

```env
# 管理员密码（必填）
ADMIN_PASSWORD=your_password_here

# 可选：认证 Secret
ADMIN_AUTH_SECRET=your_auth_secret_here

# 可选：允许生产环境访问（不推荐）
# ALLOW_ADMIN_IN_PRODUCTION=true
```

#### 2.2 确认密码

```bash
# 在项目根目录运行
cat .env.local | grep ADMIN_PASSWORD
```

或者在 Windows PowerShell：

```powershell
Get-Content .env.local | Select-String "ADMIN_PASSWORD"
```

### 步骤 3: 重启开发服务器

**重要**: 修改 `.env.local` 后必须重启开发服务器！

```bash
# 停止服务器（Ctrl+C）
# 然后重新启动
npm run dev
```

### 步骤 4: 清除浏览器缓存

1. 打开浏览器开发者工具（F12）
2. 进入 **Application** 或 **应用程序** 标签
3. 清除 Cookies
4. 刷新页面（Ctrl+Shift+R）

### 步骤 5: 检查控制台错误

1. 打开浏览器开发者工具（F12）
2. 进入 **Console** 标签
3. 查看是否有错误信息
4. 进入 **Network** 标签
5. 尝试登录
6. 查看登录请求的响应

## 📝 具体问题排查

### 问题 A: 提示"系统配置错误，请联系管理员"

**原因**: `ADMIN_PASSWORD` 环境变量未配置

**解决方案**:

1. 在项目根目录创建或编辑 `.env.local` 文件：

```env
ADMIN_PASSWORD=your_password_here
```

2. 重启开发服务器：

```bash
npm run dev
```

3. 重新访问登录页面

### 问题 B: 提示"密码错误"

**原因**: 输入的密码与配置的密码不一致

**解决方案**:

1. 检查 `.env.local` 中的密码：

```bash
cat .env.local | grep ADMIN_PASSWORD
```

2. 确认密码：
   - 区分大小写
   - 前后不要有空格
   - 不要有特殊字符（如引号）

3. 尝试使用配置的密码登录

### 问题 C: 提示"Not Found" 或 404

**原因**: 本地访问限制

**解决方案**:

1. 检查是否在本地环境访问：
   - 使用 `localhost`
   - 不要使用 IP 地址（除非是局域网 IP）

2. 如果需要在生产环境访问，设置环境变量：

```env
ALLOW_ADMIN_IN_PRODUCTION=true
```

3. 重启开发服务器

### 问题 D: 登录成功但立即退出

**原因**: Cookie 设置问题

**解决方案**:

1. 检查浏览器 Cookie 设置：
   - 允许设置 Cookie
   - 允许第三方 Cookie（如果需要）

2. 检查浏览器开发者工具：
   - F12 → Application → Cookies
   - 查看是否有 `admin_authenticated` Cookie

3. 如果 Cookie 未设置，可能是 `sameSite` 设置过于严格

### 问题 E: 提示"登录尝试过多，IP 已被锁定"

**原因**: 登录失败次数过多，IP 被锁定

**解决方案**:

1. 等待 15 分钟后重试

2. 或者重启开发服务器（清除内存中的锁定记录）：

```bash
npm run dev
```

## 🔧 手动测试登录 API

使用 curl 或 Postman 测试登录 API：

```bash
curl -X POST http://localhost:3000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"password":"your_password_here"}'
```

### 成功响应：

```json
{
  "success": true,
  "message": "登录成功"
}
```

### 失败响应：

```json
{
  "success": false,
  "error": "密码错误",
  "remainingAttempts": 4
}
```

## 📋 检查清单

- [ ] 已创建 `.env.local` 文件
- [ ] 已配置 `ADMIN_PASSWORD`
- [ ] 密码没有拼写错误
- [ ] 密码前后没有空格
- [ ] 已重启开发服务器
- [ ] 使用 `localhost` 访问
- [ ] 已清除浏览器缓存和 Cookie
- [ ] 浏览器允许设置 Cookie
- [ ] 控制台没有错误信息
- [ ] 登录请求返回 200 状态码

## 🛠️ 开发环境配置示例

### `.env.local` 示例

```env
# 管理员密码
ADMIN_PASSWORD=admin123

# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...

# 可选：认证 Secret
ADMIN_AUTH_SECRET=my-secret-key-123

# 可选：允许生产环境访问（不推荐）
# ALLOW_ADMIN_IN_PRODUCTION=true
```

## 🔗 相关文档

- [管理员访问指南](./ADMIN_ACCESS_GUIDE.md)
- [本地访问限制说明](./本地访问限制说明.md)
- [安全管理指南](./安全管理指南.md)

## 📞 仍然无法解决？

如果按照以上步骤仍然无法解决，请：

1. 访问调试页面：`http://localhost:3000/api/admin/debug`
2. 截图调试信息
3. 检查控制台错误信息
4. 检查 Network 标签中的登录请求响应
5. 提供以上信息以便进一步诊断

