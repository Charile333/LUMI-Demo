# 📝 话题创建和投票功能详细说明

## 📋 目录

1. [功能概述](#功能概述)
2. [数据库结构](#数据库结构)
3. [API 端点](#api-端点)
4. [前端组件](#前端组件)
5. [工作流程](#工作流程)
6. [安全机制](#安全机制)
7. [错误处理](#错误处理)
8. [使用示例](#使用示例)

---

## 🎯 功能概述

话题创建和投票功能允许用户：
- ✅ 创建新话题（标题 + 描述）
- ✅ 查看所有话题列表（按投票数排序）
- ✅ 为话题投票（每个用户每个话题只能投一次）
- ✅ 实时查看投票状态和投票数

### 核心特性

- 🔒 **钱包验证**：投票需要连接钱包
- 🚫 **防重复投票**：数据库级别 + 前端双重保护
- 📊 **实时更新**：投票后立即更新显示
- 🌐 **双语支持**：支持中英文界面
- ⚡ **性能优化**：索引优化、批量查询

---

## 🗄️ 数据库结构

### 1. `user_topics` 表（话题表）

```sql
CREATE TABLE IF NOT EXISTS user_topics (
  id SERIAL PRIMARY KEY,                    -- 话题ID（自增）
  title VARCHAR(100) NOT NULL UNIQUE,       -- 话题标题（唯一，最大100字符）
  description TEXT DEFAULT '',              -- 话题描述（可选）
  created_by VARCHAR(255) NOT NULL DEFAULT 'anonymous',  -- 创建者地址
  votes INTEGER NOT NULL DEFAULT 0,         -- 投票数（默认0）
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),     -- 创建时间
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()      -- 更新时间
);
```

**索引：**
- `idx_user_topics_votes`：按投票数降序（用于排序）
- `idx_user_topics_created_at`：按创建时间降序

**约束：**
- `title` 字段有 `UNIQUE` 约束，防止重复话题

### 2. `topic_votes` 表（投票记录表）

```sql
CREATE TABLE IF NOT EXISTS topic_votes (
  id SERIAL PRIMARY KEY,                    -- 投票记录ID
  topic_id INTEGER NOT NULL REFERENCES user_topics(id) ON DELETE CASCADE,  -- 话题ID（外键）
  user_address VARCHAR(255) NOT NULL,       -- 用户钱包地址
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),     -- 投票时间
  UNIQUE(topic_id, user_address)            -- 唯一约束：每个用户每个话题只能投一次
);
```

**索引：**
- `idx_topic_votes_topic_id`：按话题ID查询
- `idx_topic_votes_user_address`：按用户地址查询

**约束：**
- `UNIQUE(topic_id, user_address)`：确保每个用户每个话题只能投一次
- `ON DELETE CASCADE`：删除话题时自动删除相关投票记录

---

## 🔌 API 端点

### 1. 获取所有话题

**端点：** `GET /api/topics`

**功能：** 获取所有话题列表，按投票数降序排序

**响应示例：**
```json
{
  "success": true,
  "topics": [
    {
      "id": 1,
      "title": "话题标题",
      "description": "话题描述",
      "votes": 10,
      "createdBy": "0x1234...",
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**错误处理：**
- 表不存在：返回空列表 + 警告
- 查询失败：返回 200 状态码 + 错误信息（避免前端报错）

---

### 2. 创建新话题

**端点：** `POST /api/topics`

**请求体：**
```json
{
  "title": "话题标题",        // 必填，最大100字符
  "description": "话题描述"   // 可选，最大500字符
}
```

**响应示例：**
```json
{
  "success": true,
  "topic": {
    "id": 1,
    "title": "话题标题",
    "description": "话题描述",
    "votes": 0,
    "createdBy": "anonymous",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

**验证规则：**
- ✅ 标题不能为空
- ✅ 标题最大长度：100字符
- ✅ 描述最大长度：500字符
- ✅ 标题唯一性检查（数据库级别）

**错误处理：**

| 错误代码 | HTTP状态码 | 错误信息 | 解决方案 |
|---------|-----------|---------|---------|
| `42P01` / `PGRST205` | 503 | 话题表尚未创建 | 运行 `database/create-user-topics-table.sql` |
| `23505` | 409 | 该话题已存在 | 修改标题 |
| 其他 | 500 | 创建话题失败 | 查看错误详情 |

**请求头（可选）：**
- `x-user-address`: 用户钱包地址（用于记录创建者）

---

### 3. 为话题投票

**端点：** `POST /api/topics/[topicId]/vote`

**路径参数：**
- `topicId`: 话题ID（整数）

**请求头：**
```
x-user-address: 0x1234...  // 用户钱包地址（必填）
```

**请求体（可选，如果header中没有地址）：**
```json
{
  "userAddress": "0x1234..."  // 用户钱包地址
}
```

**响应示例：**
```json
{
  "success": true,
  "votes": 11  // 更新后的投票数
}
```

**验证规则：**
- ✅ 用户地址必填（401错误）
- ✅ 地址格式验证（以太坊地址格式：`0x` + 40个十六进制字符）
- ✅ 话题ID必须有效（400错误）
- ✅ 话题必须存在（404错误）
- ✅ 用户不能重复投票（400错误）

**防重复投票机制：**
1. **前端检查**：投票前检查 `hasVoted` 状态
2. **API检查**：查询 `topic_votes` 表检查是否已投票
3. **数据库约束**：`UNIQUE(topic_id, user_address)` 防止重复插入
4. **错误处理**：捕获 `23505` 错误（唯一约束冲突）

**工作流程：**
```
1. 验证用户地址格式
2. 检查话题是否存在
3. 查询是否已投票（topic_votes表）
4. 如果已投票 → 返回错误
5. 如果未投票 → 插入投票记录
6. 更新话题投票数（votes + 1）
7. 返回更新后的投票数
```

---

### 4. 检查投票状态

**端点：** `GET /api/topics/[topicId]/vote/check?userAddress=0x1234...`

**路径参数：**
- `topicId`: 话题ID（整数）

**查询参数：**
- `userAddress`: 用户钱包地址（必填）

**响应示例：**
```json
{
  "success": true,
  "hasVoted": true  // 是否已投票
}
```

**用途：**
- 前端加载话题列表时，批量检查每个话题的投票状态
- 实时显示"已投票"或"投票"按钮状态

---

## 🎨 前端组件

### `CreateTopicButton.tsx`

**位置：** `components/CreateTopicButton.tsx`

**功能：**
- 悬浮按钮（右下角固定位置）
- 创建话题表单
- 话题列表展示
- 投票功能

**状态管理：**
```typescript
const [isOpen, setIsOpen] = useState(false)           // 弹窗开关
const [topics, setTopics] = useState<Topic[]>([])     // 话题列表
const [newTopic, setNewTopic] = useState({            // 新话题表单
  title: '',
  description: ''
})
const [isSubmitting, setIsSubmitting] = useState(false) // 提交状态
```

**核心方法：**

#### 1. `loadTopics()`
- 获取所有话题列表
- 如果有用户地址，批量检查每个话题的投票状态
- 更新 `topics` 状态

#### 2. `checkUserVoted(topicId, address)`
- 调用 `/api/topics/[topicId]/vote/check` API
- 返回 `boolean` 表示是否已投票

#### 3. `handleSubmitTopic(e)`
- 验证表单（标题必填）
- 调用 `POST /api/topics` API
- 成功后清空表单并刷新列表
- 错误处理：显示详细错误信息

#### 4. `handleVote(topicId)`
- 检查钱包连接状态
- 如果未连接，提示用户连接钱包
- 检查是否已投票（前端状态）
- 调用 `POST /api/topics/[topicId]/vote` API
- 成功后更新本地状态（投票数 + 1，hasVoted = true）

**UI 组件：**

1. **悬浮按钮**
   - 位置：`fixed bottom-8 right-8`
   - 图标：`/image/LUMI-logo.png`
   - 动画：Hover 时放大旋转

2. **弹窗**
   - 位置：`fixed bottom-28 right-8`
   - 尺寸：`w-[420px] max-h-[calc(100vh-9rem)]`
   - 样式：深色主题（`bg-zinc-900`）

3. **创建表单**
   - 标题输入框（必填，最大100字符）
   - 描述文本区域（可选，最大200字符）
   - 提交按钮（禁用状态：提交中）

4. **话题列表**
   - 话题卡片（标题、描述、投票数、创建日期）
   - 投票按钮（已投票时禁用）
   - 刷新按钮

---

## 🔄 工作流程

### 创建话题流程

```
用户输入标题和描述
    ↓
前端验证（标题必填、长度限制）
    ↓
POST /api/topics
    ↓
后端验证（标题唯一性、长度限制）
    ↓
插入 user_topics 表
    ↓
返回创建的话题
    ↓
前端刷新话题列表
```

### 投票流程

```
用户点击投票按钮
    ↓
检查钱包连接状态
    ↓（未连接）
提示连接钱包
    ↓（已连接）
检查前端状态（hasVoted）
    ↓（已投票）
提示"已投过票"
    ↓（未投票）
POST /api/topics/[topicId]/vote
    ↓
后端验证（地址格式、话题存在、未投票）
    ↓
插入 topic_votes 表
    ↓
更新 user_topics.votes + 1
    ↓
返回更新后的投票数
    ↓
前端更新本地状态
```

### 加载话题列表流程

```
打开弹窗 / 用户地址变化
    ↓
GET /api/topics
    ↓
获取所有话题
    ↓
如果有用户地址
    ↓
批量调用 checkUserVoted API
    ↓
合并投票状态到话题列表
    ↓
更新前端状态
```

---

## 🔒 安全机制

### 1. 钱包地址验证

- ✅ 格式验证：`/^0x[a-fA-F0-9]{40}$/`
- ✅ 统一转小写：避免大小写不一致导致的重复投票

### 2. 防重复投票

**三层保护：**

1. **前端检查**
   ```typescript
   if (topic?.hasVoted) {
     alert('您已经投过票了')
     return
   }
   ```

2. **API 检查**
   ```typescript
   const { data: existingVote } = await supabase
     .from('topic_votes')
     .select('id')
     .eq('topic_id', topicId)
     .eq('user_address', userAddress)
     .single()
   
   if (existingVote) {
     return NextResponse.json({ error: '您已经投过票了' }, { status: 400 })
   }
   ```

3. **数据库约束**
   ```sql
   UNIQUE(topic_id, user_address)
   ```
   即使前两层检查失败，数据库也会拒绝重复插入

### 3. 输入验证

- ✅ 标题：必填、最大100字符
- ✅ 描述：可选、最大500字符（前端200字符，后端500字符）
- ✅ 话题ID：必须是有效整数
- ✅ 用户地址：必须是有效的以太坊地址格式

### 4. 错误处理

- ✅ 友好的错误提示
- ✅ 详细的错误日志（开发环境）
- ✅ 防止敏感信息泄露（生产环境）

---

## ⚠️ 错误处理

### 创建话题错误

| 错误场景 | HTTP状态码 | 错误信息 | 前端处理 |
|---------|-----------|---------|---------|
| 表不存在 | 503 | 话题表尚未创建 | 显示错误 + 解决方案 |
| 标题重复 | 409 | 该话题已存在 | 提示修改标题 |
| 标题为空 | 400 | 标题不能为空 | 表单验证 |
| 标题过长 | 400 | 标题不能超过100个字符 | 表单验证 |
| 其他错误 | 500 | 创建话题失败 | 显示错误详情 |

### 投票错误

| 错误场景 | HTTP状态码 | 错误信息 | 前端处理 |
|---------|-----------|---------|---------|
| 未连接钱包 | 401 | 请连接钱包后投票 | 提示连接钱包 |
| 地址格式错误 | 400 | 无效的钱包地址 | 提示检查地址 |
| 话题不存在 | 404 | 话题不存在 | 提示话题不存在 |
| 已投票 | 400 | 您已经投过票了 | 更新按钮状态为"已投票" |
| 其他错误 | 500 | 投票失败 | 显示错误信息 |

### 错误处理最佳实践

1. **前端：**
   - 表单验证（防止无效提交）
   - 友好的错误提示（Alert）
   - 控制台日志（开发调试）

2. **后端：**
   - 详细的错误日志
   - 明确的错误代码
   - 开发环境返回堆栈信息

---

## 📖 使用示例

### 1. 创建话题

```typescript
// 前端调用
const response = await fetch('/api/topics', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    title: '新话题标题',
    description: '话题描述（可选）'
  })
})

const data = await response.json()
if (data.success) {
  console.log('话题创建成功:', data.topic)
} else {
  console.error('创建失败:', data.error)
}
```

### 2. 获取话题列表

```typescript
// 前端调用
const response = await fetch('/api/topics')
const data = await response.json()

if (data.success) {
  console.log('话题列表:', data.topics)
  // topics 已按投票数降序排序
}
```

### 3. 投票

```typescript
// 前端调用
const response = await fetch(`/api/topics/${topicId}/vote`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-user-address': userAddress  // 用户钱包地址
  },
  body: JSON.stringify({
    userAddress: userAddress
  })
})

const data = await response.json()
if (data.success) {
  console.log('投票成功，当前投票数:', data.votes)
} else {
  console.error('投票失败:', data.error)
}
```

### 4. 检查投票状态

```typescript
// 前端调用
const response = await fetch(
  `/api/topics/${topicId}/vote/check?userAddress=${userAddress}`
)
const data = await response.json()

if (data.success) {
  console.log('是否已投票:', data.hasVoted)
}
```

---

## 🚀 部署前检查清单

- [ ] 数据库表已创建（运行 `database/create-user-topics-table.sql`）
- [ ] Supabase 环境变量已配置
- [ ] 前端组件已添加到布局（`app/client-layout.tsx`）
- [ ] 钱包连接功能正常
- [ ] 双语翻译文件已更新（`locales/en.json`, `locales/zh.json`）
- [ ] 错误处理已测试
- [ ] 防重复投票机制已验证

---

## 📝 相关文件

- **前端组件：** `components/CreateTopicButton.tsx`
- **API 路由：**
  - `app/api/topics/route.ts`（获取/创建话题）
  - `app/api/topics/[topicId]/vote/route.ts`（投票）
  - `app/api/topics/[topicId]/vote/check/route.ts`（检查投票状态）
- **数据库脚本：** `database/create-user-topics-table.sql`
- **使用指南：** `HOW_TO_USE_CREATE_TOPIC.md`

---

## 🔧 故障排查

### 问题1：表不存在错误

**错误信息：** `话题表尚未创建` 或 `PGRST205`

**解决方案：**
1. 登录 Supabase Dashboard
2. 打开 SQL Editor
3. 运行 `database/create-user-topics-table.sql` 脚本

### 问题2：只能看到 MetaMask

**原因：** WalletConnect Project ID 未配置

**解决方案：**
1. 访问 https://cloud.walletconnect.com/
2. 创建项目并获取 Project ID
3. 在 `.env.local` 中添加：`NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=your_project_id`
4. 重启开发服务器

### 问题3：投票后按钮状态不更新

**原因：** 前端状态未同步

**解决方案：**
1. 检查 `handleVote` 方法是否正确更新 `topics` 状态
2. 检查 `hasVoted` 字段是否正确设置
3. 刷新页面重新加载数据

---

**文档版本：** 1.0  
**最后更新：** 2024-01-01

