# 🚀 激活市场指南

## 📋 概述

激活市场是将市场部署到区块链上的过程。激活后，市场会获得 `condition_id`，可以进行链上交易。

## ✅ 前置条件

1. **市场必须有 `question_id`** ✅
   - 你的市场已经有 `question_id`，可以继续

2. **平台钱包配置**：
   - `PLATFORM_WALLET_PRIVATE_KEY`: 平台钱包私钥
   - 钱包需要有足够的 USDC 余额
   - 钱包需要有足够的 Gas 费

3. **智能合约配置**：
   - `NEXT_PUBLIC_RPC_URL`: RPC URL（Polygon Amoy）
   - `NEXT_PUBLIC_MOCK_USDC`: USDC 合约地址
   - `NEXT_PUBLIC_ADAPTER`: Adapter 合约地址

4. **网络连接**：
   - 确保可以连接到 Polygon Amoy 网络

## 🚀 激活方法

### 方法1：使用 API 激活（推荐）

#### 步骤1：检查市场状态

```bash
node scripts/check-market-question-id.js
```

#### 步骤2：激活市场

```bash
# 激活市场 ID 24
curl -X POST http://localhost:3000/api/admin/markets/24/activate

# 激活市场 ID 25
curl -X POST http://localhost:3000/api/admin/markets/25/activate
```

#### 步骤3：检查激活结果

```bash
node scripts/check-market-question-id.js
```

或者使用 Supabase Dashboard：

```sql
SELECT 
  id,
  title,
  question_id,
  condition_id,
  blockchain_status
FROM markets
WHERE id IN (24, 25);
```

### 方法2：使用 Supabase Dashboard

#### 步骤1：打开 Supabase Dashboard

1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 运行以下 SQL：

```sql
-- 检查市场状态
SELECT 
  id,
  title,
  question_id,
  condition_id,
  blockchain_status
FROM markets
WHERE id IN (24, 25);
```

#### 步骤2：检查激活条件

```sql
-- 检查市场是否有 question_id
SELECT 
  id,
  title,
  question_id,
  CASE 
    WHEN question_id IS NULL THEN '❌ 缺少 question_id'
    WHEN condition_id IS NOT NULL THEN '✅ 已上链'
    WHEN blockchain_status = 'failed' THEN '⚠️ 上链失败'
    ELSE '⏳ 等待上链'
  END as status
FROM markets
WHERE id IN (24, 25);
```

### 方法3：手动上链（使用智能合约）

#### 步骤1：连接钱包

1. 使用 MetaMask 或其他钱包
2. 连接到 Polygon Amoy 网络（Chain ID: 80002）

#### 步骤2：调用智能合约

1. 使用 UMA Adapter 合约
2. 调用 `initialize()` 方法
3. 传入市场信息：
   - `questionId`: 市场的 `question_id`
   - `title`: 市场标题
   - `description`: 市场描述
   - `outcomeSlotCount`: 2（YES/NO）
   - `rewardToken`: USDC 合约地址
   - `reward`: 奖励金额

#### 步骤3：获取 condition_id

1. 从交易事件中获取 `condition_id`
2. 或计算 `condition_id`：
   ```javascript
   const conditionId = ethers.utils.keccak256(
     ethers.utils.defaultAbiCoder.encode(
       ['address', 'bytes32', 'uint256'],
       [adapterAddress, questionId, 2]
     )
   );
   ```

#### 步骤4：更新数据库

```sql
UPDATE markets
SET blockchain_status = 'created',
    condition_id = '0x...',
    activated_at = NOW()
WHERE id = 24;
```

## ⚠️ 注意事项

### 1. 上链失败的处理

如果市场状态为 `failed`，需要：

1. **检查失败原因**：
   - 查看服务器日志
   - 检查钱包余额
   - 检查 Gas 费
   - 检查网络连接

2. **重试激活**：
   ```bash
   curl -X POST http://localhost:3000/api/admin/markets/24/activate
   ```

3. **手动修复**：
   - 如果 API 激活失败，可以手动上链
   - 或联系管理员

### 2. 平台钱包配置

确保 `.env.local` 文件中有以下配置：

```env
PLATFORM_WALLET_PRIVATE_KEY=0x...
NEXT_PUBLIC_RPC_URL=https://polygon-amoy-bor-rpc.publicnode.com
NEXT_PUBLIC_MOCK_USDC=0x...
NEXT_PUBLIC_ADAPTER=0x...
```

### 3. USDC 余额

激活市场需要 USDC 作为奖励，确保：

1. **平台钱包有足够的 USDC**：
   - 检查钱包余额
   - 如果不足，需要充值

2. **USDC 授权**：
   - 确保 USDC 已授权给 Adapter 合约
   - 如果没有，需要先授权

### 4. Gas 费

激活市场需要 Gas 费，确保：

1. **平台钱包有足够的 Gas 费**：
   - 检查钱包余额
   - 如果不足，需要充值

2. **Gas 价格**：
   - 检查 Gas 价格是否合理
   - 如果 Gas 价格过高，可以等待

## 📝 测试清单

- [ ] 检查市场是否有 `question_id`
- [ ] 检查平台钱包配置
- [ ] 检查 USDC 余额
- [ ] 检查 Gas 费
- [ ] 运行激活 API
- [ ] 检查激活结果
- [ ] 检查 `condition_id` 是否已设置
- [ ] 测试链上交易

## 🔗 相关文档

- [链上交易测试指南](./链上交易测试指南.md)
- [测试步骤](./测试步骤.md)
- [链上交易方案对比](./链上交易方案对比.md)

## 📞 支持

如果遇到问题，请：

1. 检查服务器日志
2. 检查钱包余额
3. 检查网络连接
4. 查看相关文档
5. 联系管理员

