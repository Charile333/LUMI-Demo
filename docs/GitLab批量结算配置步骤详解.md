# ğŸ”· GitLab æ‰¹é‡ç»“ç®—é…ç½®æ­¥éª¤è¯¦è§£

## ğŸ“‹ é…ç½®å‰å‡†å¤‡

### âœ… éœ€è¦å‡†å¤‡çš„ä¿¡æ¯

1. **Vercel åº”ç”¨ URL**
   - ä¾‹å¦‚ï¼š`https://your-app.vercel.app`
   - åœ¨ Vercel Dashboard ä¸­æŸ¥çœ‹

2. **CRON_SECRET**
   - åœ¨ Vercel Dashboard > Settings > Environment Variables ä¸­æŸ¥çœ‹
   - å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²

---

## ğŸš€ æ­¥éª¤ 1ï¼šé…ç½® GitLab CI/CD å˜é‡

### 1.1 æ‰“å¼€ GitLab é¡¹ç›®

1. ç™»å½• GitLab
2. æ‰“å¼€ä½ çš„é¡¹ç›®ï¼š`novatamoffat-group/LUMI-Demo`

### 1.2 è¿›å…¥å˜é‡è®¾ç½®

1. ç‚¹å‡»å·¦ä¾§èœå•çš„ **`Settings`**ï¼ˆè®¾ç½®ï¼‰
2. å±•å¼€ **`CI/CD`** éƒ¨åˆ†
3. æ‰¾åˆ° **`Variables`** éƒ¨åˆ†
4. ç‚¹å‡» **`Expand`**ï¼ˆå±•å¼€ï¼‰æˆ–ç›´æ¥æ»šåŠ¨åˆ°å˜é‡åˆ—è¡¨

### 1.3 æ·»åŠ ç¬¬ä¸€ä¸ªå˜é‡ï¼šCRON_SECRET

1. ç‚¹å‡» **`Add variable`**ï¼ˆæ·»åŠ å˜é‡ï¼‰æŒ‰é’®
2. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

   **Keyï¼ˆå˜é‡åï¼‰ï¼š**
   ```
   CRON_SECRET
   ```

   **Valueï¼ˆå˜é‡å€¼ï¼‰ï¼š**
   ```
   ä» Vercel ç¯å¢ƒå˜é‡ä¸­å¤åˆ¶ CRON_SECRET çš„å€¼
   æˆ–è€…ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼ˆæ¨è 32 ä½ä»¥ä¸Šï¼‰
   ```

   **Typeï¼ˆç±»å‹ï¼‰ï¼š**
   ```
   Variableï¼ˆé»˜è®¤ï¼‰
   ```

   **Environment scopeï¼ˆç¯å¢ƒèŒƒå›´ï¼‰ï¼š**
   ```
   All environmentsï¼ˆé»˜è®¤ï¼‰
   ```

   **Protect variableï¼ˆä¿æŠ¤å˜é‡ï¼‰ï¼š**
   ```
   âœ… å‹¾é€‰ï¼ˆå¦‚æœä½¿ç”¨ä¿æŠ¤åˆ†æ”¯ï¼‰
   ```

   **Mask variableï¼ˆéšè—å˜é‡ï¼‰ï¼š**
   ```
   âœ… å‹¾é€‰ï¼ˆé‡è¦ï¼šéšè—æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼‰
   ```

3. ç‚¹å‡» **`Add variable`**ï¼ˆæ·»åŠ å˜é‡ï¼‰æŒ‰é’®ä¿å­˜

### 1.4 æ·»åŠ ç¬¬äºŒä¸ªå˜é‡ï¼šVERCEL_APP_URL

1. å†æ¬¡ç‚¹å‡» **`Add variable`**ï¼ˆæ·»åŠ å˜é‡ï¼‰æŒ‰é’®
2. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

   **Keyï¼ˆå˜é‡åï¼‰ï¼š**
   ```
   VERCEL_APP_URL
   ```

   **Valueï¼ˆå˜é‡å€¼ï¼‰ï¼š**
   ```
   https://your-app.vercel.app
   ```
   âš ï¸ **é‡è¦**ï¼šå°† `your-app` æ›¿æ¢ä¸ºä½ çš„å®é™… Vercel åº”ç”¨åç§°

   **Typeï¼ˆç±»å‹ï¼‰ï¼š**
   ```
   Variableï¼ˆé»˜è®¤ï¼‰
   ```

   **Environment scopeï¼ˆç¯å¢ƒèŒƒå›´ï¼‰ï¼š**
   ```
   All environmentsï¼ˆé»˜è®¤ï¼‰
   ```

   **Protect variableï¼ˆä¿æŠ¤å˜é‡ï¼‰ï¼š**
   ```
   âœ… å‹¾é€‰ï¼ˆå¦‚æœä½¿ç”¨ä¿æŠ¤åˆ†æ”¯ï¼‰
   ```

   **Mask variableï¼ˆéšè—å˜é‡ï¼‰ï¼š**
   ```
   âŒ ä¸å‹¾é€‰ï¼ˆURL å¯ä»¥æ˜¾ç¤ºï¼‰
   ```

3. ç‚¹å‡» **`Add variable`**ï¼ˆæ·»åŠ å˜é‡ï¼‰æŒ‰é’®ä¿å­˜

### 1.5 éªŒè¯å˜é‡é…ç½®

ç¡®è®¤ä¸¤ä¸ªå˜é‡éƒ½å·²æ·»åŠ ï¼š
- âœ… `CRON_SECRET`ï¼ˆMaskedï¼šâ—â—â—â—ï¼‰
- âœ… `VERCEL_APP_URL`ï¼ˆæ˜¾ç¤ºå®Œæ•´ URLï¼‰

---

## ğŸš€ æ­¥éª¤ 2ï¼šåˆ›å»º Pipeline Scheduleï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

### 2.1 è¿›å…¥ Pipeline Schedules

1. åœ¨ GitLab é¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§èœå•çš„ **`CI/CD`**
2. ç‚¹å‡» **`Schedules`**ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
3. å¦‚æœè¿˜æ²¡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œä¼šçœ‹åˆ° "No pipeline schedules" æˆ–ç©ºåˆ—è¡¨

### 2.2 åˆ›å»ºæ–°å®šæ—¶ä»»åŠ¡

1. ç‚¹å‡»å³ä¸Šè§’çš„ **`New schedule`**ï¼ˆæ–°å»ºå®šæ—¶ä»»åŠ¡ï¼‰æŒ‰é’®

### 2.3 é…ç½®å®šæ—¶ä»»åŠ¡

#### æè¿°ï¼ˆDescriptionï¼‰

```
æ‰¹é‡ç»“ç®—äº¤æ˜“ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
```

**è¯´æ˜**ï¼šè¿™æ˜¯å®šæ—¶ä»»åŠ¡çš„åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰

---

#### Interval Patternï¼ˆCron è¡¨è¾¾å¼ï¼‰

```
*/5 * * * *
```

**è¯´æ˜**ï¼š
- `*/5 * * * *` = æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- `*/10 * * * *` = æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- `0 * * * *` = æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œ
- `0 0 * * *` = æ¯å¤©å‡Œæ™¨æ‰§è¡Œ

**Cron è¡¨è¾¾å¼æ ¼å¼ï¼š**
```
åˆ† æ—¶ æ—¥ æœˆ å‘¨
* * * * *
```

---

#### Timezoneï¼ˆæ—¶åŒºï¼‰

```
Asia/Shanghai
```

**è¯´æ˜**ï¼š
- é€‰æ‹©ä½ æ‰€åœ¨çš„æ—¶åŒº
- ä¸­å›½ç”¨æˆ·é€‰æ‹©ï¼š`Asia/Shanghai`
- ç¾å›½ä¸œæµ·å²¸ï¼š`America/New_York`
- ç¾å›½è¥¿æµ·å²¸ï¼š`America/Los_Angeles`

---

#### Target Branchï¼ˆç›®æ ‡åˆ†æ”¯ï¼‰

```
master
```

**è¯´æ˜**ï¼š
- é€‰æ‹©ä½ çš„ä¸»åˆ†æ”¯åç§°
- é€šå¸¸æ˜¯ `master` æˆ– `main`
- ç¡®ä¿è¿™ä¸ªåˆ†æ”¯æœ‰ `.gitlab-ci.yml` æ–‡ä»¶

---

#### Activatedï¼ˆæ¿€æ´»çŠ¶æ€ï¼‰

```
âœ… å‹¾é€‰
```

**è¯´æ˜**ï¼š
- å‹¾é€‰åï¼Œå®šæ—¶ä»»åŠ¡ä¼šç«‹å³ç”Ÿæ•ˆ
- å¦‚æœä¸å‹¾é€‰ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨

---

### 2.4 ä¿å­˜å®šæ—¶ä»»åŠ¡

1. æ£€æŸ¥æ‰€æœ‰é…ç½®æ˜¯å¦æ­£ç¡®
2. ç‚¹å‡» **`Save pipeline schedule`**ï¼ˆä¿å­˜å®šæ—¶ä»»åŠ¡ï¼‰æŒ‰é’®

---

## ğŸš€ æ­¥éª¤ 3ï¼šæµ‹è¯•æ‰§è¡Œ

### 3.1 æ‰‹åŠ¨è§¦å‘ Pipelineï¼ˆæ¨èï¼‰

#### æ–¹æ³• 1ï¼šé€šè¿‡ Pipelines é¡µé¢

1. è¿›å…¥ **`CI/CD`** > **`Pipelines`**
2. ç‚¹å‡»å³ä¸Šè§’çš„ **`Run pipeline`**ï¼ˆè¿è¡Œ Pipelineï¼‰æŒ‰é’®
3. é€‰æ‹©åˆ†æ”¯ï¼š
   - **Branch/Tag**: é€‰æ‹© `master`ï¼ˆæˆ–ä½ çš„ä¸»åˆ†æ”¯ï¼‰
4. ç‚¹å‡» **`Run pipeline`**ï¼ˆè¿è¡Œ Pipelineï¼‰æŒ‰é’®
5. ç­‰å¾… Pipeline æ‰§è¡Œ

#### æ–¹æ³• 2ï¼šé€šè¿‡ Schedules é¡µé¢

1. è¿›å…¥ **`CI/CD`** > **`Schedules`**
2. æ‰¾åˆ°åˆšåˆ›å»ºçš„å®šæ—¶ä»»åŠ¡
3. ç‚¹å‡»å³ä¾§çš„ **`â–¶ï¸ Play`**ï¼ˆæ’­æ”¾ï¼‰æŒ‰é’®
4. é€‰æ‹©åˆ†æ”¯å¹¶ç‚¹å‡»ç¡®è®¤

### 3.2 æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

1. è¿›å…¥ **`CI/CD`** > **`Pipelines`**
2. ç‚¹å‡»æœ€æ–°çš„ Pipelineï¼ˆåº”è¯¥æ˜¾ç¤ºä¸º "running" æˆ– "passed"ï¼‰
3. ç‚¹å‡» **`batch-settle-trades`** job
4. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

#### æˆåŠŸæ—¥å¿—ç¤ºä¾‹ï¼š

```
ğŸ”„ è§¦å‘æ‰¹é‡ç»“ç®— API...
æ—¶é—´: Sat Nov 16 18:50:00 UTC 2024
åˆ†æ”¯: master
è§¦å‘æº: web
è°ƒç”¨ API: https://your-app.vercel.app/api/cron/settle-trades
HTTP çŠ¶æ€ç : 200
å“åº”å†…å®¹:
{
  "success": true,
  "message": "å½“å‰æ²¡æœ‰å¾…ç»“ç®—çš„äº¤æ˜“",
  "tradesProcessed": 0,
  "timestamp": "2024-11-16T18:50:00.000Z"
}
âœ… æ‰¹é‡ç»“ç®—è§¦å‘æˆåŠŸ
```

#### é”™è¯¯æ—¥å¿—ç¤ºä¾‹ï¼š

å¦‚æœçœ‹åˆ°é”™è¯¯ï¼Œæ£€æŸ¥ï¼š
- âŒ `CRON_SECRET` æ˜¯å¦é…ç½®æ­£ç¡®
- âŒ `VERCEL_APP_URL` æ˜¯å¦æ­£ç¡®
- âŒ Vercel API æ˜¯å¦æ­£å¸¸

---

## âœ… æ­¥éª¤ 4ï¼šéªŒè¯é…ç½®æˆåŠŸ

### 4.1 ç­‰å¾…è‡ªåŠ¨æ‰§è¡Œ

1. å®šæ—¶ä»»åŠ¡ä¼šåœ¨é…ç½®çš„æ—¶é—´è‡ªåŠ¨æ‰§è¡Œï¼ˆä¾‹å¦‚ï¼šæ¯ 5 åˆ†é’Ÿï¼‰
2. å¯ä»¥åœ¨ **`CI/CD`** > **`Pipelines`** ä¸­çœ‹åˆ°è‡ªåŠ¨è§¦å‘çš„ Pipeline

### 4.2 æŸ¥çœ‹æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„ç»“ç®—è®°å½•
SELECT 
  batch_id,
  trade_count,
  status,
  created_at,
  completed_at
FROM settlements 
ORDER BY created_at DESC 
LIMIT 10;

-- æŸ¥çœ‹å¾…ç»“ç®—äº¤æ˜“æ•°é‡
SELECT COUNT(*) as pending_trades
FROM trades 
WHERE settled = false 
  AND settlement_batch_id IS NULL;
```

### 4.3 éªŒè¯ Vercel API

è®¿é—®ä½ çš„ Vercel APIï¼ˆéœ€è¦ Authorization headerï¼‰ï¼š

```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_CRON_SECRET" \
  -H "Content-Type: application/json" \
  https://your-app.vercel.app/api/cron/settle-trades
```

---

## ğŸ“Š é…ç½®æ£€æŸ¥æ¸…å•

åœ¨å®Œæˆé…ç½®å‰ï¼Œç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

### âœ… GitLab CI/CD å˜é‡

- [ ] `CRON_SECRET` å·²é…ç½®ï¼ˆMaskedï¼‰
- [ ] `VERCEL_APP_URL` å·²é…ç½®ï¼ˆæ­£ç¡®å¡«å†™äº† Vercel åŸŸåï¼‰
- [ ] å˜é‡ç±»å‹ä¸º `Variable`
- [ ] å¦‚æœä½¿ç”¨ä¿æŠ¤åˆ†æ”¯ï¼Œå·²å‹¾é€‰ `Protected`

### âœ… Pipeline Schedule

- [ ] Description å·²å¡«å†™
- [ ] Interval Pattern æ­£ç¡®ï¼ˆ`*/5 * * * *`ï¼‰
- [ ] Timezone é€‰æ‹©æ­£ç¡®
- [ ] Target Branch é€‰æ‹©æ­£ç¡®
- [ ] Activated å·²å‹¾é€‰

### âœ… ä»£ç æ–‡ä»¶

- [ ] `.gitlab-ci.yml` æ–‡ä»¶å·²æäº¤åˆ°ä»“åº“
- [ ] æ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•
- [ ] `master` åˆ†æ”¯åŒ…å« `.gitlab-ci.yml`

### âœ… Vercel é…ç½®

- [ ] Vercel åº”ç”¨å·²éƒ¨ç½²
- [ ] `app/api/cron/settle-trades/route.ts` å·²éƒ¨ç½²
- [ ] Vercel ç¯å¢ƒå˜é‡å·²é…ç½®ï¼š
  - [ ] `PLATFORM_WALLET_PRIVATE_KEY`
  - [ ] `CRON_SECRET`ï¼ˆä¸ GitLab ä¸­çš„ä¸€è‡´ï¼‰
  - [ ] `DATABASE_URL`
  - [ ] `NEXT_PUBLIC_RPC_URL`

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šPipeline æœªæ‰§è¡Œ

**å¯èƒ½åŸå› ï¼š**
- âŒ Pipeline Schedule æœªæ¿€æ´»
- âŒ Cron è¡¨è¾¾å¼é”™è¯¯
- âŒ ç›®æ ‡åˆ†æ”¯é”™è¯¯
- âŒ `.gitlab-ci.yml` æ–‡ä»¶ä¸åœ¨ç›®æ ‡åˆ†æ”¯

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ Pipeline Schedule çš„ `Activated` æ˜¯å¦å‹¾é€‰
2. æ£€æŸ¥ Cron è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç›®æ ‡åˆ†æ”¯æœ‰ `.gitlab-ci.yml` æ–‡ä»¶
4. æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ Pipeline æµ‹è¯•

---

### é—®é¢˜ 2ï¼šAPI è°ƒç”¨å¤±è´¥ï¼ˆ401 Unauthorizedï¼‰

**å¯èƒ½åŸå› ï¼š**
- âŒ `CRON_SECRET` é…ç½®é”™è¯¯
- âŒ Vercel ç¯å¢ƒå˜é‡ä¸­çš„ `CRON_SECRET` ä¸ä¸€è‡´

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ GitLab å˜é‡ `CRON_SECRET` çš„å€¼
2. æ£€æŸ¥ Vercel ç¯å¢ƒå˜é‡ `CRON_SECRET` çš„å€¼
3. ç¡®ä¿ä¸¤ä¸ªå€¼å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€å¤§å°å†™ï¼‰
4. é‡æ–°éƒ¨ç½² Vercel åº”ç”¨ï¼ˆè®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆï¼‰

---

### é—®é¢˜ 3ï¼šAPI è°ƒç”¨å¤±è´¥ï¼ˆ404 Not Foundï¼‰

**å¯èƒ½åŸå› ï¼š**
- âŒ `VERCEL_APP_URL` é…ç½®é”™è¯¯
- âŒ Vercel åº”ç”¨æœªéƒ¨ç½²
- âŒ API è·¯ç”±ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ `VERCEL_APP_URL` æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ Vercel åº”ç”¨å·²éƒ¨ç½²
3. è®¿é—® `https://your-app.vercel.app/api/cron/settle-trades` æµ‹è¯•
4. ç¡®è®¤ `app/api/cron/settle-trades/route.ts` æ–‡ä»¶å­˜åœ¨

---

### é—®é¢˜ 4ï¼šPipeline æ‰§è¡Œè¶…æ—¶

**å¯èƒ½åŸå› ï¼š**
- âŒ API å“åº”æ—¶é—´è¿‡é•¿
- âŒ ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ Vercel API å“åº”æ—¶é—´
2. æŸ¥çœ‹ Pipeline æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. å°è¯•æ‰‹åŠ¨è°ƒç”¨ API æµ‹è¯•

---

## ğŸ“ ä¸‹ä¸€æ­¥

é…ç½®å®Œæˆåï¼š

1. âœ… **ç›‘æ§æ‰§è¡Œæ—¥å¿—** - å®šæœŸæŸ¥çœ‹ Pipeline æ‰§è¡Œæƒ…å†µ
2. âœ… **æ£€æŸ¥æ•°æ®åº“** - ç¡®è®¤è®¢å•æ˜¯å¦æ­£ç¡®ç»“ç®—
3. âœ… **ä¼˜åŒ–é¢‘ç‡** - æ ¹æ®è®¢å•é‡è°ƒæ•´æ‰§è¡Œé¢‘ç‡
4. âœ… **è®¾ç½®é€šçŸ¥** - å¯ä»¥é…ç½® Pipeline å¤±è´¥æ—¶çš„é€šçŸ¥

---

## ğŸ‰ å®Œæˆï¼

é…ç½®å®Œæˆåï¼ŒGitLab ä¼šæ¯ 5 åˆ†é’Ÿè‡ªåŠ¨è°ƒç”¨ Vercel API æ‰§è¡Œæ‰¹é‡ç»“ç®—ï¼Œç”¨æˆ·è®¢å•å°†è‡ªåŠ¨ä¸Šé“¾å®Œæˆï¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´é…ç½®æŒ‡å—](./GitLabæ‰¹é‡ç»“ç®—é…ç½®æŒ‡å—.md)
- [å¿«é€Ÿé…ç½®æŒ‡å—](../README_GITLAB_BATCH_SETTLE.md)
- [Vercel API è·¯ç”±](../app/api/cron/settle-trades/route.ts)

