# 🚀 启动平台批量自动结算指南

## 📋 前置条件

### 1. 环境变量配置

需要在 `.env.local` 文件中配置以下环境变量：

```env
# 平台钱包私钥（用于批量结算）
# ⚠️ 重要：这是敏感信息，请妥善保管
PLATFORM_WALLET_PRIVATE_KEY=your_private_key_here

# RPC 节点 URL（可选，有默认值）
NEXT_PUBLIC_RPC_URL=https://polygon-amoy-bor-rpc.publicnode.com

# 数据库连接（必需）
DATABASE_URL=postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres
```

### 2. 数据库表结构

确保以下表已创建：
- ✅ `trades` - 成交记录表
- ✅ `settlements` - 结算批次表
- ✅ `orders` - 订单表

如果未创建，请运行：
```sql
-- 参考 scripts/setup-database-clean.sql
```

---

## 🚀 启动步骤

### 步骤 1：配置环境变量

1. 打开 `.env.local` 文件（如果不存在，从 `.env.example` 复制）
2. 添加 `PLATFORM_WALLET_PRIVATE_KEY`

```bash
# 生成私钥（如果没有）
# 可以使用 MetaMask 创建新账户并导出私钥
# 或使用 scripts/generate-wallet.js
node scripts/generate-wallet.js
```

3. 将生成的私钥添加到 `.env.local`：
```env
PLATFORM_WALLET_PRIVATE_KEY=0x...
```

### 步骤 2：确保钱包有足够的余额

⚠️ **重要**：平台钱包需要有足够的 ETH（或 MATIC）用于支付 Gas 费

- 测试网（Polygon Amoy）：可以从水龙头获取
- 主网（Polygon）：需要充值

### 步骤 3：启动 Cron 调度器

#### 方法 1：使用 PM2（推荐 - 生产环境）

```bash
# 启动 PM2 服务
npm run cron:start

# 检查状态
npm run cron:status

# 查看日志
npm run cron:logs

# 停止服务
npm run cron:stop

# 重启服务
npm run cron:restart
```

#### 方法 2：直接运行（开发测试）

```bash
# 直接运行 Cron 调度器
npm run cron

# 或使用 ts-node
npx ts-node scripts/cron-scheduler.ts
```

---

## 📊 任务配置

### 批量结算任务

- **执行频率**：每 5 分钟
- **Cron 表达式**：`*/5 * * * *`
- **最大批量数**：20 个订单
- **执行条件**：`settled = false AND settlement_batch_id IS NULL`

### 其他任务

1. **市场激活** - 每小时运行一次
2. **清理过期订单** - 每 30 分钟运行一次
3. **价格历史记录** - 每分钟运行一次

---

## 🔍 验证和监控

### 1. 检查任务是否运行

```bash
# 检查 PM2 状态
npm run cron:status

# 应该看到类似输出：
# ┌────┬───────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
# │ id │ name      │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
# ├────┼───────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
# │ 0  │ lumi-cron │ default     │ N/A     │ fork    │ 12345    │ 5m     │ 0    │ online    │ 0%       │ 200mb    │ user     │ disabled │
# └────┴───────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
```

### 2. 查看日志

```bash
# 查看实时日志
npm run cron:logs

# 或查看日志文件
tail -f logs/pm2-out.log
tail -f logs/pm2-error.log
```

### 3. 检查数据库

```sql
-- 查看待结算交易
SELECT COUNT(*) FROM trades 
WHERE settled = false 
  AND settlement_batch_id IS NULL;

-- 查看结算批次
SELECT * FROM settlements 
ORDER BY created_at DESC 
LIMIT 10;

-- 查看最近的结算记录
SELECT 
  batch_id,
  trade_count,
  status,
  tx_hash,
  created_at,
  completed_at
FROM settlements 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## ⚠️ 注意事项

### 1. 链上结算代码状态

**当前状态**：链上结算代码已被注释（模拟模式）

在 `scripts/settle-trades-cron.ts` 中，实际的链上调用代码被注释了：

```typescript
// TODO: 取消注释以下代码以启用实际的链上结算
/*
const exchange = new ethers.Contract(...);
const tx = await exchange.fillOrders(...);
*/
```

**原因**：
- CTF Exchange 合约需要先部署和配置
- 订单数据格式需要与合约匹配
- 需要充分测试

**当前行为**：
- 会创建结算批次
- 会标记交易为已结算
- 但不会实际调用链上合约

### 2. 启用实际链上结算

要启用实际的链上结算，需要：

1. 确保 CTF Exchange 合约已部署
2. 检查合约地址是否正确（`CTF_EXCHANGE_ADDRESS`）
3. 确保订单数据格式正确
4. 取消注释链上调用代码（第 117-159 行）
5. 测试并监控

### 3. Gas 费用

- 平台钱包需要有足够的 Gas 费
- 批量结算可以节省 Gas（多笔订单合并）
- 建议监控钱包余额

### 4. 错误处理

- 如果批量结算失败，订单会保持待结算状态
- 下次运行时会重试
- 错误会记录在日志中

---

## 🐛 故障排查

### 问题 1：PM2 服务未启动

```bash
# 检查 PM2 是否安装
npm list -g pm2

# 如果未安装
npm install -g pm2

# 重新启动
npm run cron:start
```

### 问题 2：环境变量未配置

```bash
# 检查环境变量
echo $PLATFORM_WALLET_PRIVATE_KEY

# 或在 Node.js 中检查
node -e "console.log(process.env.PLATFORM_WALLET_PRIVATE_KEY ? 'OK' : 'MISSING')"
```

### 问题 3：数据库连接失败

```bash
# 检查 DATABASE_URL 是否正确
# 检查网络连接
# 检查 Supabase 项目是否运行
```

### 问题 4：任务未执行

```bash
# 检查日志
npm run cron:logs

# 检查是否有错误
tail -f logs/pm2-error.log

# 手动运行一次
npx ts-node scripts/settle-trades-cron.ts
```

---

## 📝 测试

### 手动测试批量结算

```bash
# 直接运行批量结算脚本
npx ts-node scripts/settle-trades-cron.ts

# 查看输出
# 应该看到类似：
# 💰 开始批量结算交易...
# 📊 找到 X 笔待结算交易
# 📦 创建结算批次: batch-...
# ✅ 批量结算完成（模拟）
```

---

## 🎯 总结

1. ✅ 配置 `PLATFORM_WALLET_PRIVATE_KEY` 环境变量
2. ✅ 确保平台钱包有足够的 Gas 费
3. ✅ 启动 PM2 服务：`npm run cron:start`
4. ✅ 监控任务运行：`npm run cron:status` 和 `npm run cron:logs`
5. ⚠️ 注意：当前链上结算代码被注释（模拟模式）

批量结算任务会每 5 分钟自动运行一次，扫描待结算的订单并批量处理。

