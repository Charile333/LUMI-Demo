# 🚀 启用平台自动结算指南

## 🎯 目标

**启用平台批量自动结算，实现用户订单的自动化结算。**

---

## 📋 启用步骤

### 步骤 1：配置环境变量

#### 1.1 检查环境变量

确认 `.env.local` 文件中有 `PLATFORM_WALLET_PRIVATE_KEY`：

```env
# 平台钱包私钥（用于批量结算）
PLATFORM_WALLET_PRIVATE_KEY=your_private_key_here
```

#### 1.2 如果没有，添加环境变量

在项目根目录的 `.env.local` 文件中添加：

```env
# 平台钱包私钥（用于批量结算）
# 注意：不要包含 0x 前缀
PLATFORM_WALLET_PRIVATE_KEY=your_private_key_here

# RPC URL（如果还没有）
NEXT_PUBLIC_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/your_key

# CTF Exchange 合约地址（如果还没有）
NEXT_PUBLIC_CTF_EXCHANGE_ADDRESS=0xdFE02Eb6733538f8Ea35D585af8DE5958AD99E40
```

#### 1.3 验证环境变量

确保私钥格式正确：
- ✅ 64 个十六进制字符（不包含 `0x` 前缀）
- ✅ 或 66 个字符（包含 `0x` 前缀）

---

### 步骤 2：确保平台钱包有足够的资金

#### 2.1 检查钱包余额

平台钱包需要：
- ✅ **MATIC**：用于支付 Gas 费（建议至少 1 MATIC）
- ✅ **USDC**：如果批量结算需要 USDC（根据实际情况）

#### 2.2 检查 USDC 授权

如果批量结算需要 USDC，确保平台钱包已授权 CTF Exchange 合约：

```bash
# 使用脚本检查授权
node scripts/check-usdc-approve.js
```

---

### 步骤 3：启用 Cron 调度器

#### 3.1 使用 Node.js 直接运行

```bash
# 进入项目目录
cd /path/to/LUMI

# 启动 Cron 调度器
node scripts/cron-scheduler.ts
```

#### 3.2 使用 PM2 后台运行（推荐）

```bash
# 安装 PM2（如果还没有）
npm install -g pm2

# 启动 Cron 调度器
pm2 start scripts/cron-scheduler.ts --name "lumi-cron" --interpreter ts-node

# 或者如果使用 ts-node
pm2 start "ts-node scripts/cron-scheduler.ts" --name "lumi-cron"
```

#### 3.3 使用 PM2 配置文件（推荐）

创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [
    {
      name: 'lumi-cron',
      script: 'scripts/cron-scheduler.ts',
      interpreter: 'ts-node',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production'
      },
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z'
    }
  ]
};
```

然后运行：

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

---

### 步骤 4：测试批量结算

#### 4.1 手动测试批量结算脚本

```bash
# 直接运行批量结算脚本（测试模式）
node scripts/settle-trades-cron.ts
```

#### 4.2 检查输出

应该看到类似输出：

```
============================================================
💰 开始批量结算交易...
时间: 2025-01-13 10:00:00
============================================================

📊 找到 5 笔待结算交易

📦 创建结算批次: batch-1234567890
   交易数量: 5
   批次 ID: 1

💰 平台账户: 0x1234...5678

📝 发送批量结算交易...
✅ 批量结算完成
   批次 ID: batch-1234567890
   成交数: 5
============================================================
```

---

### 步骤 5：监控批量结算任务

#### 5.1 查看 PM2 日志

```bash
# 查看实时日志
pm2 logs lumi-cron

# 查看最近 100 行日志
pm2 logs lumi-cron --lines 100

# 查看错误日志
pm2 logs lumi-cron --err
```

#### 5.2 查看 PM2 状态

```bash
# 查看所有进程状态
pm2 status

# 查看详细信息
pm2 describe lumi-cron

# 查看进程监控
pm2 monit
```

#### 5.3 手动运行测试

定期运行测试脚本，确保批量结算正常工作：

```bash
# 每周测试一次
node scripts/settle-trades-cron.ts
```

---

## 🔧 配置说明

### 定时任务配置

`scripts/cron-scheduler.ts` 中的定时任务：

```typescript
// 批量结算任务 - 每 5 分钟运行一次
cron.schedule('*/5 * * * *', () => {
  // 执行批量结算
}, {
  timezone: 'Asia/Shanghai'
});
```

**可以调整的时间间隔**：
- `*/5 * * * *` - 每 5 分钟（默认）
- `*/10 * * * *` - 每 10 分钟
- `*/15 * * * *` - 每 15 分钟
- `0 * * * *` - 每小时

---

### 批量结算数量配置

`scripts/settle-trades-cron.ts` 中的批量数量：

```typescript
// 每次批量结算最多 20 个订单
LIMIT 20
```

**可以调整的数量**：
- `LIMIT 10` - 每次 10 个订单
- `LIMIT 20` - 每次 20 个订单（默认）
- `LIMIT 50` - 每次 50 个订单

**注意**：
- 数量越多，单次 Gas 成本越高
- 数量越少，结算更频繁
- 建议根据实际交易量调整

---

## 📊 验证自动结算是否工作

### 1. 检查数据库

查询待结算的订单：

```sql
-- 查看待结算的交易
SELECT COUNT(*) as pending_count
FROM trades
WHERE settled = false
  AND settlement_batch_id IS NULL;
```

### 2. 检查结算批次

查询结算批次：

```sql
-- 查看结算批次
SELECT 
  batch_id,
  trade_count,
  status,
  created_at,
  completed_at,
  tx_hash
FROM settlements
ORDER BY created_at DESC
LIMIT 10;
```

### 3. 检查链上交易

查询链上交易哈希：

```sql
-- 查看已结算的交易
SELECT 
  t.trade_id,
  t.settlement_tx_hash,
  t.settlement_block_number,
  t.settled_at
FROM trades t
WHERE t.settled = true
  AND t.settlement_tx_hash IS NOT NULL
ORDER BY t.settled_at DESC
LIMIT 10;
```

---

## ⚠️ 常见问题

### 问题 1：环境变量未加载

**错误**：
```
⚠️ 未配置 PLATFORM_WALLET_PRIVATE_KEY
⚠️ 跳过链上结算，保持待结算状态
```

**解决方案**：
1. 确认 `.env.local` 文件存在
2. 确认环境变量名称正确
3. 重启 Cron 调度器

---

### 问题 2：钱包余额不足

**错误**：
```
❌ 交易失败: insufficient funds
```

**解决方案**：
1. 检查平台钱包 MATIC 余额
2. 为钱包充值 MATIC（建议至少 1 MATIC）
3. 检查 USDC 余额和授权（如果需要）

---

### 问题 3：Cron 调度器未运行

**错误**：
```
批量结算任务未执行
```

**解决方案**：
1. 检查 PM2 状态：`pm2 status`
2. 检查日志：`pm2 logs lumi-cron`
3. 重启 Cron 调度器：`pm2 restart lumi-cron`

---

### 问题 4：批量结算脚本报错

**错误**：
```
❌ 结算失败: ...
```

**解决方案**：
1. 查看详细错误日志：`pm2 logs lumi-cron --err`
2. 手动运行测试：`node scripts/settle-trades-cron.ts`
3. 检查 RPC 连接：确保 RPC URL 正确
4. 检查合约地址：确保 CTF Exchange 地址正确

---

## 🚀 启动脚本

### 快速启动脚本

创建 `scripts/start-cron.sh`：

```bash
#!/bin/bash

# 检查环境变量
if [ -z "$PLATFORM_WALLET_PRIVATE_KEY" ]; then
  echo "❌ 错误: PLATFORM_WALLET_PRIVATE_KEY 未配置"
  echo "请在 .env.local 中配置 PLATFORM_WALLET_PRIVATE_KEY"
  exit 1
fi

# 启动 Cron 调度器
echo "🚀 启动批量结算 Cron 调度器..."
pm2 start scripts/cron-scheduler.ts --name "lumi-cron" --interpreter ts-node

# 查看状态
pm2 status

echo "✅ Cron 调度器已启动"
echo "查看日志: pm2 logs lumi-cron"
```

使用：

```bash
chmod +x scripts/start-cron.sh
./scripts/start-cron.sh
```

---

## 📝 监控建议

### 每日检查

1. ✅ 检查 PM2 状态：`pm2 status`
2. ✅ 查看日志：`pm2 logs lumi-cron --lines 50`
3. ✅ 检查待结算订单数量

### 每周检查

1. ✅ 检查平台钱包余额
2. ✅ 检查结算批次统计
3. ✅ 检查链上交易成功率

### 每月检查

1. ✅ 检查 Gas 费用统计
2. ✅ 优化批量结算配置
3. ✅ 检查系统性能

---

## ✅ 启用完成检查清单

- [ ] 环境变量已配置（`PLATFORM_WALLET_PRIVATE_KEY`）
- [ ] 平台钱包有足够的 MATIC（至少 1 MATIC）
- [ ] USDC 授权已配置（如果需要）
- [ ] Cron 调度器已启动（PM2 或直接运行）
- [ ] 批量结算脚本测试通过
- [ ] 监控日志已配置
- [ ] 数据库查询验证正常

---

## 🎯 启用后的效果

启用平台自动结算后：

1. ✅ **自动批量结算**：每 5 分钟自动结算待处理的订单
2. ✅ **平台代付 Gas**：用户无需支付 Gas 费
3. ✅ **无需用户操作**：完全自动化
4. ✅ **批量优化**：一次结算多个订单，节省 Gas

**用户体验**：
- ✅ 用户下单后，订单会在 5-10 分钟内自动结算
- ✅ 用户无需手动点击"执行链上交易"按钮
- ✅ 用户无需支付 Gas 费
- ✅ 交易完全自动化

---

## 🎉 完成！

**平台自动结算已启用！**

现在用户的订单会自动批量结算，无需手动操作。

**后续维护**：
- 定期检查 PM2 状态
- 监控批量结算日志
- 确保平台钱包有足够的资金

---

## 📚 相关文档

- `docs/结算方式说明.md` - 结算方式详细说明
- `docs/主流平台结算方式对比.md` - 主流平台对比
- `scripts/settle-trades-cron.ts` - 批量结算脚本
- `scripts/cron-scheduler.ts` - Cron 调度器

