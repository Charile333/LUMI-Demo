# 📊 LUMI 当前交易流程详解

## 🎯 一句话总结

**当前是混合模式：链下撮合（快速）+ 可选链上结算（安全）**

---

## 📋 完整交易流程（分步骤说明）

### 场景 1：用户点击市场卡片交易（CompactTradeModal）

```
👤 用户操作
   ↓
1️⃣ 点击市场卡片的 YES/NO 按钮
   ↓
2️⃣ 弹出交易弹窗（CompactTradeModal）
   ↓
3️⃣ 选择买入/卖出、YES/NO、输入数量（如 $10）
   ↓
4️⃣ 点击"买入/卖出"按钮
   ↓
5️⃣ 钱包签名订单（EIP-712，无需 Gas 费）
   ↓
6️⃣ 提交订单到 API：POST /api/orders/create
   ↓
7️⃣ 后端处理：
   ├─ 保存订单到数据库（Supabase）
   ├─ 查找对手盘（匹配订单）
   ├─ 如果匹配成功：
   │   ├─ 更新双方订单状态（filled/partial）
   │   └─ 准备链上执行数据（可选）
   └─ 返回结果
   ↓
8️⃣ 前端收到结果
   ↓
9️⃣ ✅ 显示"订单成功"提示
   ↓
🔟 订单完成（链下撮合成功，但资金未上链）
```

**特点**：
- ✅ 快速（毫秒级）
- ✅ 零 Gas 费
- ❌ 资金未上链（只存在数据库中）

---

### 场景 2：用户使用 QuickTradeModal（支持链上执行）

```
👤 用户操作
   ↓
1️⃣ 点击市场卡片的 YES/NO 按钮（某些市场使用 QuickTradeModal）
   ↓
2️⃣ 弹出交易弹窗（QuickTradeModal）
   ↓
3️⃣ 选择买入/卖出、YES/NO、输入数量
   ↓
4️⃣ 点击"买入/卖出"按钮
   ↓
5️⃣ 钱包签名订单（EIP-712，无需 Gas 费）
   ↓
6️⃣ 提交订单到 API：POST /api/orders/create
   ↓
7️⃣ 后端处理（同场景1）
   ↓
8️⃣ 前端收到结果：
   
   【情况 A：撮合成功 + 市场已上链】
   ├─ 显示"订单已撮合"提示
   ├─ 显示"需要执行链上交易"提示
   ├─ 显示"🚀 执行链上交易"按钮
   └─ 弹窗不关闭，等待用户操作
   
   【情况 B：撮合成功 + 市场未上链】
   ├─ 显示"订单成功"提示
   └─ 订单完成（链下撮合，无法链上执行）
   
   【情况 C：未撮合】
   ├─ 显示"订单已提交"提示
   └─ 订单挂单中，等待对手盘
   ↓
9️⃣ 【如果情况 A】用户点击"🚀 执行链上交易"按钮
   ↓
🔟 链上执行流程：
   ├─ 检查钱包连接
   ├─ 检查是否需要 Maker 签名
   │   ├─ 如果是 Maker，钱包弹出签名请求
   │   └─ 用户签名确认
   ├─ 调用 CTF Exchange 合约
   ├─ 钱包弹出交易确认
   ├─ 用户确认并支付 Gas 费
   └─ 等待区块确认（~2-5 秒）
   ↓
1️⃣1️⃣ ✅ 链上交易成功
   ├─ Conditional Tokens 转移（上链）
   ├─ USDC 转移（上链）
   ├─ 交易记录上链（可查看）
   └─ 订单完成
```

**特点**：
- ✅ 链下撮合（快速）
- ✅ 可选链上结算（安全）
- ✅ 资金上链（如果是情况 A）

---

## 🔍 两种弹窗的区别

### CompactTradeModal（大多数市场使用）

```
用户下单 → 链下撮合 → ✅ 完成（资金未上链）
```

**流程**：
1. 用户下单
2. 链下撮合（数据库）
3. 显示"订单成功"
4. **没有链上执行功能**

### QuickTradeModal（部分市场使用）

```
用户下单 → 链下撮合 → [可选]链上执行 → ✅ 完成（资金上链）
```

**流程**：
1. 用户下单
2. 链下撮合（数据库）
3. 如果撮合成功 + 市场已上链：
   - 显示"执行链上交易"按钮
   - 用户可选择是否执行链上交易
4. **有链上执行功能**

---

## 🎯 实际例子

### 例子 1：用户 A 买入 $10 YES

**步骤 1：下单**
```
用户 A 点击 YES 按钮
  → 选择"买入"，输入 $10
  → 点击"买入 YES"
  → 钱包签名（免费）
  → 订单提交到数据库
```

**步骤 2：撮合**
```
后端查找对手盘：
  → 找到用户 B 的卖单（价格匹配）
  → 撮合成功：$10 YES @ $0.60
  → 更新数据库：双方订单状态 = filled
```

**步骤 3：完成（CompactTradeModal）**
```
✅ 显示"订单成功"
✅ 订单完成（资金在数据库中，未上链）
```

**步骤 3（可选）：链上执行（QuickTradeModal）**
```
✅ 显示"订单已撮合，需要执行链上交易"
✅ 用户点击"执行链上交易"
✅ 钱包确认交易（支付 Gas 费）
✅ 链上交易成功：
   - 用户 A 获得 10 个 YES tokens（上链）
   - 用户 B 获得 6 个 USDC（上链）
   - 用户 A 支付 6 个 USDC（上链）
✅ 订单完成（资金上链）
```

---

## 📊 数据流向图

```
用户下单
   ↓
[前端] CompactTradeModal / QuickTradeModal
   ↓
钱包签名（EIP-712，免费）
   ↓
POST /api/orders/create
   ↓
[后端] 订单处理
   ├─ 保存订单到数据库
   ├─ 查找对手盘（撮合）
   ├─ 如果撮合成功：
   │   ├─ 更新订单状态（数据库）
   │   └─ 准备链上执行数据（可选）
   └─ 返回结果
   ↓
[前端] 收到结果
   ├─ CompactTradeModal：显示"订单成功" ✅ 完成
   └─ QuickTradeModal：
       ├─ 如果撮合成功 + 市场已上链：显示"执行链上交易"按钮
       │   ↓
       │   用户点击按钮
       │   ↓
       │   POST /api/orders/fill-onchain
       │   ↓
       │   [后端] 调用 CTF Exchange 合约
       │   ├─ 转移 Conditional Tokens（区块链）
       │   ├─ 转移 USDC（区块链）
       │   └─ 等待区块确认
       │   ↓
       │   ✅ 链上交易成功（资金上链）
       └─ 其他情况：显示"订单成功" ✅ 完成
```

---

## 🔑 关键概念

### 1. 链下撮合（Off-chain Matching）

**什么意思**：
- 订单和撮合都在数据库中完成
- 不需要区块链交互
- 快速、免费

**好处**：
- ✅ 毫秒级响应
- ✅ 零 Gas 费
- ✅ 支持高频交易

**坏处**：
- ❌ 资金未上链（只存在数据库）
- ❌ 不透明（无法在区块链上查看）

### 2. 链上执行（On-chain Execution）

**什么意思**：
- 将撮合结果提交到区块链
- 转移 Conditional Tokens 和 USDC
- 支付 Gas 费

**好处**：
- ✅ 资金上链（安全）
- ✅ 透明（可查看交易记录）
- ✅ 去中心化

**坏处**：
- ❌ 需要 Gas 费
- ❌ 速度较慢（需等待区块确认）
- ❌ 依赖区块链网络

---

## 🎯 当前架构总结

### 混合模式（Hybrid Mode）

```
链下：快速撮合（数据库）
   ↓
可选链上：安全结算（区块链）
```

**优势**：
- ✅ 用户体验好（快速）
- ✅ 成本低（可选 Gas 费）
- ✅ 安全性好（可选链上结算）

**当前状态**：
- ✅ 链下撮合：所有订单都支持
- ✅ 链上执行：只有 QuickTradeModal 支持（且市场需已上链）
- ⚠️ CompactTradeModal：不支持链上执行

---

## 💡 常见问题

### Q1: 我的订单资金在哪？

**答案**：
- 如果使用 CompactTradeModal：资金只在数据库中（未上链）
- 如果使用 QuickTradeModal 且执行了链上交易：资金在区块链上（上链）

### Q2: 为什么有些订单没有"执行链上交易"按钮？

**答案**：
1. 使用的是 CompactTradeModal（不支持）
2. 市场未上链（无 condition_id）
3. 订单未撮合成功

### Q3: 链下撮合和链上执行有什么区别？

**答案**：
- **链下撮合**：订单匹配（数据库），快速、免费
- **链上执行**：资金转移（区块链），安全、需要 Gas 费

### Q4: 我的订单完成了吗？

**答案**：
- **链下撮合成功**：订单已撮合，但资金未上链
- **链上执行成功**：订单完全完成，资金已上链

---

## 📝 总结

### 当前交易流程（简化版）

```
1. 用户下单（签名）
   ↓
2. 链下撮合（数据库，快速）
   ↓
3. 撮合成功
   ├─ CompactTradeModal：✅ 完成（资金未上链）
   └─ QuickTradeModal：
       ├─ 市场未上链：✅ 完成（资金未上链）
       └─ 市场已上链：显示"执行链上交易"按钮
           ↓
           用户点击按钮
           ↓
           链上执行（区块链，需要 Gas 费）
           ↓
           ✅ 完成（资金上链）
```

### 核心特点

- ✅ **默认链下撮合**：所有订单都快速撮合（免费）
- ✅ **可选链上结算**：部分订单可以执行链上交易（安全）
- ⚠️ **两种弹窗**：CompactTradeModal 不支持链上执行，QuickTradeModal 支持


