# 🧪 测试步骤

## 📋 快速测试指南

### 步骤1：检查市场上链状态

#### 方法1：使用脚本（推荐）

```bash
node scripts/check-market-blockchain-status.js
```

#### 方法2：使用 Supabase Dashboard

1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 运行以下 SQL：

```sql
-- 检查市场链上状态
SELECT 
  id,
  title,
  condition_id,
  blockchain_status,
  question_id,
  main_category,
  status
FROM markets
ORDER BY id;
```

#### 方法3：使用 API

```bash
# 检查所有市场
curl http://localhost:3000/api/admin/markets

# 检查特定市场
curl http://localhost:3000/api/markets/1
```

### 步骤2：检查数据库迁移

#### 检查 orders 表字段

```sql
-- 检查 orders 表是否有链上交易字段
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'orders'
  AND column_name IN ('condition_id', 'ctf_signature', 'ctf_order_data');
```

#### 如果字段不存在，运行迁移

```sql
-- 在 Supabase SQL Editor 中运行
ALTER TABLE orders ADD COLUMN IF NOT EXISTS condition_id TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS ctf_signature TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS ctf_order_data JSONB;
```

### 步骤3：检查市场是否已上链

#### 检查条件

市场已上链的条件：
- ✅ `condition_id` 不为空
- ✅ `blockchain_status = 'created'`
- ✅ `question_id` 不为空

#### 查询已上链的市场

```sql
SELECT 
  id,
  title,
  condition_id,
  blockchain_status,
  question_id
FROM markets
WHERE blockchain_status = 'created'
  AND condition_id IS NOT NULL
  AND question_id IS NOT NULL;
```

### 步骤4：如果市场未上链，激活市场

#### 方法1：使用 API（推荐）

```bash
# 激活市场
curl -X POST http://localhost:3000/api/admin/markets/1/activate
```

#### 方法2：手动上链

1. **连接钱包**：
   - 使用 MetaMask 或其他钱包
   - 连接到 Polygon Amoy 网络（Chain ID: 80002）

2. **调用智能合约**：
   - 使用 UMA Adapter 合约
   - 调用 `initialize()` 方法
   - 传入市场信息

3. **获取 condition_id**：
   - 从交易事件中获取
   - 或计算 condition_id

4. **更新数据库**：
   ```sql
   UPDATE markets
   SET blockchain_status = 'created',
       condition_id = '0x...',
       activated_at = NOW()
   WHERE id = 1;
   ```

### 步骤5：测试订单创建

#### 前端测试

1. **访问市场页面**：
   ```
   http://localhost:3000/markets/hot
   ```

2. **找到已上链的市场**：
   - 市场卡片上会显示"🟢 交易中"状态
   - 检查市场是否有 `condition_id`

3. **创建订单**：
   - 点击"快速交易"按钮
   - 连接钱包
   - 选择"YES"或"NO"
   - 输入金额和价格
   - 点击"提交订单"

#### API测试

```bash
# 创建订单
curl -X POST http://localhost:3000/api/orders/create \
  -H "Content-Type: application/json" \
  -d '{
    "marketId": 1,
    "maker": "0x...",
    "side": "buy",
    "outcome": 1,
    "price": "0.5",
    "amount": "100",
    "orderId": "order-123",
    "signature": "0x...",
    "salt": "0x...",
    "nonce": 1234567890,
    "expiration": 1234567890
  }'
```

### 步骤6：测试订单撮合

#### 检查订单撮合

1. **创建两个订单**：
   - 用户A创建买单（YES，价格0.5）
   - 用户B创建卖单（YES，价格0.5）

2. **检查撮合结果**：
   - 检查订单状态是否更新为 `filled` 或 `partial`
   - 检查是否有匹配的订单

3. **检查链上执行数据**：
   - 检查 API 响应是否包含 `onChainExecution`
   - 检查前端是否显示"执行链上交易"按钮

### 步骤7：测试链上执行

#### 前端测试

1. **检查链上执行按钮**：
   - 如果订单撮合成功，应该显示"执行链上交易"按钮
   - 如果没有显示，检查：
     - 市场是否有 `condition_id`
     - 订单是否有 CTF 签名
     - API 是否返回链上执行数据

2. **执行链上交易**：
   - 点击"执行链上交易"按钮
   - 确认交易详情
   - 支付Gas费
   - 等待链上确认

#### API测试

```bash
# 获取订单签名
curl http://localhost:3000/api/orders/1/signature

# 执行链上交易
curl -X POST http://localhost:3000/api/orders/execute-onchain \
  -H "Content-Type: application/json" \
  -d '{
    "ctfOrder": {...},
    "makerSignature": "0x...",
    "fillAmount": "100"
  }'
```

### 步骤8：检查交易结果

#### 检查数据库

```sql
-- 检查订单状态
SELECT 
  id,
  market_id,
  user_address,
  side,
  outcome,
  price,
  quantity,
  status,
  signature,
  condition_id,
  ctf_signature
FROM orders
WHERE market_id = 1
ORDER BY created_at DESC;
```

#### 检查链上交易

1. **查看交易哈希**：
   - 从 API 响应中获取 `transactionHash`
   - 在区块链浏览器中查看交易

2. **检查交易状态**：
   - 访问 Polygon Amoy Explorer
   - 输入交易哈希
   - 检查交易是否成功

---

## ❓ 常见问题

### Q1: 市场未上链怎么办？

**A:** 需要先激活市场上链：

1. **检查市场是否有 question_id**：
   ```sql
   SELECT id, title, question_id
   FROM markets
   WHERE id = 1;
   ```

2. **如果没有 question_id，创建 question_id**：
   ```sql
   UPDATE markets
   SET question_id = 'market-' || id::text
   WHERE question_id IS NULL;
   ```

3. **激活市场**：
   ```bash
   curl -X POST http://localhost:3000/api/admin/markets/1/activate
   ```

### Q2: 订单撮合成功但没有链上执行按钮？

**A:** 检查以下内容：

1. **市场是否有 condition_id**：
   ```sql
   SELECT condition_id
   FROM markets
   WHERE id = 1;
   ```

2. **订单是否有 CTF 签名**：
   ```sql
   SELECT ctf_signature
   FROM orders
   WHERE id = 1;
   ```

3. **API 是否返回链上执行数据**：
   - 检查浏览器控制台
   - 检查服务器日志

### Q3: 链上执行失败怎么办？

**A:** 检查以下内容：

1. **钱包连接**：
   - 确保钱包已连接
   - 确保钱包连接到正确的网络（Polygon Amoy）

2. **Gas费**：
   - 确保钱包有足够的Gas费
   - 检查Gas价格是否合理

3. **订单签名**：
   - 检查订单的 `ctf_signature` 是否正确
   - 检查 Maker 是否已签名

4. **智能合约**：
   - 检查 CTF Exchange 合约地址是否正确
   - 检查合约是否已部署

### Q4: 如何测试两个用户之间的交易？

**A:** 测试步骤：

1. **用户A创建买单**：
   - 使用钱包A连接
   - 创建买单（YES，价格0.5）

2. **用户B创建卖单**：
   - 使用钱包B连接
   - 创建卖单（YES，价格0.5）

3. **检查撮合**：
   - 检查订单是否撮合成功
   - 检查是否需要链上执行

4. **执行链上交易**：
   - 用户A或用户B执行链上交易
   - 检查资产是否转移

---

## 📝 测试清单

- [ ] 检查市场链上状态
- [ ] 检查数据库迁移
- [ ] 检查市场是否已上链
- [ ] 如果市场未上链，激活市场
- [ ] 测试订单创建
- [ ] 测试订单撮合
- [ ] 测试链上执行
- [ ] 检查交易结果
- [ ] 测试两个用户之间的交易
- [ ] 检查数据库订单数据
- [ ] 检查链上交易记录

---

## 🔗 相关文档

- [链上交易测试指南](./链上交易测试指南.md)
- [链上交易方案对比](./链上交易方案对比.md)
- [订单系统文档](./ORDER_SYSTEM.md)

