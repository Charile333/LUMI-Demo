# 🚀 直接激活市场指南

## 问题背景

由于 Next.js 中 ethers.js 使用 web 版本导致网络检测问题，自动激活可能会失败。这个脚本使用独立的 Node.js 环境，完全绕过 Next.js 的问题。

## 使用方法

### 1. 基本用法

```bash
node scripts/activate-market-direct.js <marketId>
```

### 2. 示例

激活市场 ID 24：

```bash
node scripts/activate-market-direct.js 24
```

## 脚本功能

1. ✅ **检查配置**：验证所有必需的环境变量
2. ✅ **获取市场数据**：从 Supabase 获取市场信息
3. ✅ **连接区块链**：使用 Node.js 原生 ethers.js（不受 Next.js 影响）
4. ✅ **检查余额**：验证 MATIC 和 USDC 余额
5. ✅ **自动 Approve**：如果 approve 不足，自动执行 approve
6. ✅ **激活市场**：调用 Adapter 合约的 initialize 函数
7. ✅ **更新数据库**：自动更新市场状态和 condition_id

## 环境变量要求

确保 `.env.local` 中配置了：

```env
NEXT_PUBLIC_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/YOUR_API_KEY
PLATFORM_WALLET_PRIVATE_KEY=0x你的私钥
NEXT_PUBLIC_SUPABASE_URL=你的Supabase URL
SUPABASE_SERVICE_ROLE_KEY=你的Service Role Key
```

## 优势

- ✅ **不受 Next.js 影响**：完全独立的 Node.js 脚本
- ✅ **使用原生 ethers.js**：没有 web 版本的问题
- ✅ **更详细的日志**：每一步都有清晰的输出
- ✅ **自动处理**：自动检查余额、approve 等
- ✅ **错误处理**：详细的错误信息和回滚

## 输出示例

```
============================================================
🚀 直接激活市场 24
============================================================

📊 市场信息:
   标题: 上链测试
   状态: not_created
   Question ID: 你的question_id

🌐 连接区块链...
💰 平台钱包: 0xaa22D02aA0C31cF4140d54284B249cDb651107aB
   MATIC 余额: 0.123 MATIC

💵 USDC 余额: 1000.0 USDC
💵 所需奖励: 10.0 USDC

🔐 当前 Approve: 10.0 USDC
✅ Approve 额度充足

📝 创建市场...
   Question ID: 0x...
⏳ 交易已发送: 0x...
🔗 查看交易: https://amoy.polygonscan.com/tx/0x...

✅ 交易已确认，区块: 28983850
📊 Condition ID: 0x...

✅ 市场激活成功！

============================================================
📋 激活结果:
   市场 ID: 24
   交易哈希: 0x...
   Condition ID: 0x...
   查看交易: https://amoy.polygonscan.com/tx/0x...
============================================================
```

## 故障排除

### 问题 1: 配置缺失

**错误**: `❌ 配置缺失！`

**解决**: 检查 `.env.local` 文件，确保所有必需的变量都已配置。

### 问题 2: 市场不存在

**错误**: `❌ 市场不存在`

**解决**: 检查市场 ID 是否正确，市场是否在数据库中。

### 问题 3: 余额不足

**错误**: `❌ MATIC 余额不足` 或 `❌ USDC 余额不足`

**解决**: 
- MATIC: 从 faucet 获取测试 MATIC
- USDC: 确保平台钱包有足够的 USDC

### 问题 4: 交易失败

**错误**: `❌ 激活失败`

**解决**: 
1. 查看错误信息中的具体原因
2. 检查交易哈希，在 Polygonscan 上查看详细信息
3. 检查合约地址是否正确
4. 检查 question_id 是否已存在

## 注意事项

1. ⚠️ **确保网络正确**：脚本使用 Polygon Amoy 测试网
2. ⚠️ **确保合约已部署**：Adapter 和 USDC 合约必须在测试网上
3. ⚠️ **确保私钥安全**：不要将私钥提交到代码仓库
4. ⚠️ **测试环境**：建议先在测试环境验证

## 与自动激活的区别

| 特性 | 自动激活（API） | 直接激活（脚本） |
|------|----------------|-----------------|
| 环境 | Next.js API 路由 | 独立 Node.js 脚本 |
| ethers.js 版本 | Web 版本（有问题） | Node.js 版本（正常） |
| 网络检测 | 可能失败 | 正常工作 |
| 使用场景 | 生产环境 | 开发/测试环境 |
| 调试 | 较困难 | 更容易 |

## 推荐工作流

1. **开发阶段**：使用脚本直接激活
2. **测试阶段**：验证脚本激活的市场是否正常
3. **生产阶段**：修复自动激活 API 后使用 API

