# 🔍 市场激活失败排查指南

## 🚨 常见失败原因

根据您的错误信息，激活失败的原因是：**RPC 端点连接失败**

### 错误信息

```
❌ 激活失败: Error: 所有 RPC 端点连接失败。
missing response (requestBody="{\"method\":\"eth_blockNumber\", ...}")
```

## 📋 完整检查清单

### 1. 检查环境变量配置

在 `.env.local` 中确认有以下配置：

```env
# RPC URL（Alchemy 私有 RPC）
NEXT_PUBLIC_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/YOUR_API_KEY

# 平台钱包私钥
PLATFORM_WALLET_PRIVATE_KEY=0x...

# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```

### 2. 测试 RPC 连接

运行测试脚本：

```bash
node scripts/test-rpc-connection.js
```

这会测试所有 RPC 端点并告诉您哪些可用。

### 3. 检查平台钱包余额

平台钱包需要：

- ✅ MATIC（用于 Gas 费）- 至少 0.1 MATIC
- ✅ Mock USDC（用于市场奖励）- 至少 10 USDC

### 4. 重启开发服务器

**重要**：修改 `.env.local` 后必须重启！

```bash
# Ctrl+C 停止
npm run dev
```

## 🛠️ 解决方案

### 方案 1: 确认 Alchemy RPC 配置正确

1. **检查 API Key 是否正确**：
   ```env
   NEXT_PUBLIC_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/YOUR_ACTUAL_API_KEY
   ```

2. **测试连接**：
   ```bash
   node scripts/test-rpc-connection.js
   ```

   应该看到：
   ```
   ✅ 成功 (XXXms, 区块: XXXXXX)
   ```

3. **如果测试成功，重启服务器并重试激活**

### 方案 2: 手动设置 condition_id（仅用于测试 UI）

如果 RPC 仍然无法连接，可以先手动设置 condition_id 来测试 UI：

```bash
node scripts/manual-set-condition-id.js
```

**注意**：这只是测试用，不是真正的链上激活。

### 方案 3: 检查平台钱包配置

确认平台钱包：

1. **有私钥配置**：
   ```env
   PLATFORM_WALLET_PRIVATE_KEY=0x...
   ```

2. **有足够余额**：
   - 访问 https://amoy.polygonscan.com/address/YOUR_WALLET_ADDRESS
   - 检查 MATIC 和 USDC 余额

3. **获取测试代币**：
   - MATIC: https://faucet.polygon.technology/
   - Mock USDC: 需要调用合约 mint 函数

## 🔍 详细诊断

### 步骤 1: 测试 RPC

```bash
node scripts/test-rpc-connection.js
```

**预期输出（成功）**：
```
✅ 成功: X 个
💡 推荐配置（最快）：
   NEXT_PUBLIC_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/...
```

### 步骤 2: 检查配置

访问调试页面：
```
http://localhost:3000/api/admin/debug
```

确认：
- NEXT_PUBLIC_RPC_URL 已配置
- PLATFORM_WALLET_PRIVATE_KEY 已配置

### 步骤 3: 查看详细错误

重试激活时，查看服务器控制台（Terminal），应该显示：

```
🚀 开始激活市场 24...
🌐 尝试连接 RPC: https://...
[详细的错误信息]
```

## 💡 快速测试方案

如果您只是想测试交易功能，可以：

1. **运行手动设置脚本**：
   ```bash
   node scripts/manual-set-condition-id.js
   ```

2. **刷新管理页面**，市场应该显示为"已上链"

3. **测试交易 UI 流程**（实际链上交易会失败，但可以看到 UI）

## ❓ 下一步

请告诉我：

1. **您的 Alchemy RPC URL 配置了吗**？（检查 `.env.local`）
2. **运行 `node scripts/test-rpc-connection.js` 的结果如何**？
3. **您想先用手动设置测试 UI，还是继续排查 RPC 问题**？

我可以根据您的情况提供针对性的帮助！
