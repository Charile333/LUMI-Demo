# GitLab CI/CD é…ç½®æ–‡ä»¶
# ç”¨äºå®šæ—¶ä»»åŠ¡ï¼šæ‰¹é‡ç»“ç®—å’Œä»·æ ¼å†å²è®°å½•
# 
# é…ç½®è¯´æ˜ï¼š
# - ä»·æ ¼å†å²è®°å½•ä»»åŠ¡ï¼šç”¨äºæ¦‚ç‡æ›²çº¿ï¼Œå»ºè®®æ¯ 5-10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
# - æ‰¹é‡ç»“ç®—ä»»åŠ¡ï¼šç”¨äºæ‰¹é‡ç»“ç®—äº¤æ˜“ï¼Œå»ºè®®æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
# 
# åœ¨ GitLab ä¸­åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„ Scheduleï¼š
# 1. Schedule 1: ä»·æ ¼å†å²è®°å½•ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
#    - åœ¨ Schedule çš„ Variables ä¸­æ·»åŠ ï¼šRUN_PRICE_HISTORY=true
# 2. Schedule 2: æ‰¹é‡ç»“ç®—ï¼ˆæ¯å°æ—¶ï¼‰
#    - åœ¨ Schedule çš„ Variables ä¸­æ·»åŠ ï¼šRUN_SETTLE_TRADES=true

stages:
  - price-history
  - settle-trades

# ä»·æ ¼å†å²è®°å½•ä»»åŠ¡ï¼ˆç”¨äºæ¦‚ç‡æ›²çº¿ï¼‰
record-price-history:
  stage: price-history
  image: node:20-alpine
  variables:
    GIT_DEPTH: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œç¡®ä¿è·å–æœ€æ–°æäº¤
  script: |
    echo "ğŸ“Š å¼€å§‹è®°å½•ä»·æ ¼å†å²..."
    echo "æ—¶é—´: $(date)"
    echo "åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    echo "è§¦å‘æº: $CI_PIPELINE_SOURCE"
    echo "å½“å‰æäº¤: $(git rev-parse HEAD)"
    echo "æäº¤ä¿¡æ¯: $(git log -1 --oneline)"
    
    npm ci
    npm run record-prices
    
    echo "âœ… ä»·æ ¼å†å²è®°å½•å®Œæˆ"
  rules:
    # å…è®¸å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
    - if: $CI_PIPELINE_SOURCE == "schedule" && $RUN_PRICE_HISTORY == "true"
    # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ä¸»åˆ†æ”¯ï¼‰
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: manual

# æ‰¹é‡ç»“ç®—ä»»åŠ¡
batch-settle-trades:
  stage: settle-trades
  image: curlimages/curl:latest
  script: |
    set -e
    echo "ğŸ”„ è§¦å‘æ‰¹é‡ç»“ç®— API..."
    echo "æ—¶é—´: $(date)"
    echo "åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    echo "è§¦å‘æº: $CI_PIPELINE_SOURCE"

    if [ -z "$CRON_SECRET" ]; then
      echo "âŒ é”™è¯¯: CRON_SECRET æœªé…ç½®"
      echo "è¯·åˆ° GitLab Settings > CI/CD > Variables ä¸­æ·»åŠ  CRON_SECRET"
      exit 1
    fi

    if [ -z "$VERCEL_APP_URL" ]; then
      echo "âŒ é”™è¯¯: VERCEL_APP_URL æœªé…ç½®"
      echo "è¯·åˆ° GitLab Settings > CI/CD > Variables ä¸­æ·»åŠ  VERCEL_APP_URL"
      exit 1
    fi

    echo "è°ƒç”¨ API: $VERCEL_APP_URL/api/cron/settle-trades"
    response=$(curl -s -w "\n%{http_code}" -X POST \
      -H "Authorization: Bearer $CRON_SECRET" \
      -H "Content-Type: application/json" \
      $VERCEL_APP_URL/api/cron/settle-trades)

    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')

    echo "HTTP çŠ¶æ€ç : $http_code"
    echo "å“åº”å†…å®¹:"
    echo "$body"

    if [ "$http_code" -eq 200 ]; then
      echo "âœ… æ‰¹é‡ç»“ç®—è§¦å‘æˆåŠŸ"
    else
      echo "âŒ æ‰¹é‡ç»“ç®—è§¦å‘å¤±è´¥ (HTTP $http_code)"
      exit 1
    fi
  rules:
    # å…è®¸å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
    - if: $CI_PIPELINE_SOURCE == "schedule" && $RUN_SETTLE_TRADES == "true"
    # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ä¸»åˆ†æ”¯ï¼‰
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: manual

