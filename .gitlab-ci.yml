# GitLab CI/CD é…ç½®æ–‡ä»¶
# ç”¨äºæ‰¹é‡ç»“ç®—å®šæ—¶ä»»åŠ¡

stages:
  - settle-trades

# æ‰¹é‡ç»“ç®—ä»»åŠ¡
batch-settle-trades:
  stage: settle-trades
  image: curlimages/curl:latest
  script: |
    set -e
    echo "ğŸ”„ è§¦å‘æ‰¹é‡ç»“ç®— API..."
    echo "æ—¶é—´: $(date)"
    echo "åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    echo "è§¦å‘æº: $CI_PIPELINE_SOURCE"

    if [ -z "$CRON_SECRET" ]; then
      echo "âŒ é”™è¯¯: CRON_SECRET æœªé…ç½®"
      echo "è¯·åˆ° GitLab Settings > CI/CD > Variables ä¸­æ·»åŠ  CRON_SECRET"
      exit 1
    fi

    if [ -z "$VERCEL_APP_URL" ]; then
      echo "âŒ é”™è¯¯: VERCEL_APP_URL æœªé…ç½®"
      echo "è¯·åˆ° GitLab Settings > CI/CD > Variables ä¸­æ·»åŠ  VERCEL_APP_URL"
      exit 1
    fi

    echo "è°ƒç”¨ API: $VERCEL_APP_URL/api/cron/settle-trades"
    response=$(curl -s -w "\n%{http_code}" -X POST \
      -H "Authorization: Bearer $CRON_SECRET" \
      -H "Content-Type: application/json" \
      $VERCEL_APP_URL/api/cron/settle-trades)

    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')

    echo "HTTP çŠ¶æ€ç : $http_code"
    echo "å“åº”å†…å®¹:"
    echo "$body"

    if [ "$http_code" -eq 200 ]; then
      echo "âœ… æ‰¹é‡ç»“ç®—è§¦å‘æˆåŠŸ"
    else
      echo "âŒ æ‰¹é‡ç»“ç®—è§¦å‘å¤±è´¥ (HTTP $http_code)"
      exit 1
    fi
  rules:
    # å…è®¸å®šæ—¶ä»»åŠ¡è§¦å‘
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ä¸»åˆ†æ”¯ï¼‰
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: manual

