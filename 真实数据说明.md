# 📊 黑天鹅系统 - 真实数据说明

## ✅ 所有数据来源

### 1. 实时警报流
**数据来源**: WebSocket实时推送  
**端点**: `ws://localhost:3000/ws/alerts`  
**更新频率**: 实时（每2秒检查数据库）  
**数据库**: `duolume-master/utils/database/app.db`

```typescript
// 数据流向
Binance API → main.py (检测) → SQLite → server.js (监控) → WebSocket → 前端界面
```

**包含字段**:
- `symbol` - 交易对 (如: BTCUSDT, ETHUSDT)
- `message` - 警报消息
- `timestamp` - 时间戳
- `severity` - 严重程度 (critical/high/medium)
- `details.price_change` - 价格变化百分比
- `details.current_price` - 当前价格
- `details.previous_price` - 之前价格

---

### 2. 历史闪崩事件
**数据来源**: REST API  
**端点**: `GET /api/alerts/crash-events`  
**查询逻辑**: 从数据库查询 `severity='critical'` 的警报，按日期分组

**SQL 查询**:
```sql
SELECT 
  symbol,
  timestamp,
  message,
  details,
  severity,
  DATE(timestamp) as event_date
FROM alerts 
WHERE severity = 'critical'
ORDER BY timestamp DESC 
LIMIT 50
```

**处理逻辑**:
1. 查找所有严重警报
2. 按 `symbol + date` 去重
3. 计算持续时间（基于同一天的警报数量）
4. 提取价格变化数据
5. 返回前10个最严重的事件

**返回字段**:
- `id` - 事件ID (symbol_date)
- `date` - 事件日期
- `asset` - 资产名称 (BTC/USDT)
- `crashPercentage` - 崩盘百分比
- `duration` - 持续时间
- `description` - 事件描述
- `details` - 详细价格数据

---

### 3. 系统统计数据
**数据来源**: REST API  
**端点**: `GET /api/alerts/stats`  

**SQL 查询**:
```sql
-- 按严重程度统计
SELECT severity, COUNT(*) as count 
FROM alerts 
GROUP BY severity

-- 监控的资产数量
SELECT DISTINCT symbol 
FROM alerts
```

**返回字段**:
- `total_alerts` - 总警报数
- `critical_alerts` - 严重警报数
- `high_alerts` - 高级警报数
- `medium_alerts` - 中级警报数
- `monitored_assets` - 监控的资产数量
- `severity_breakdown` - 严重程度详细分布

---

### 4. 事件详细数据
**数据来源**: 选中事件的 `details` 字段

**从数据库解析**:
```javascript
details = JSON.parse(row.details)
{
  price_change: -0.152,      // 价格变化（-15.2%）
  current_price: 57000,      // 当前价格
  previous_price: 68000,     // 之前价格
  alert_type: "Price Jump",  // 警报类型
  volume_change: 2.4         // 交易量变化
}
```

**显示位置**:
- Peak Price (崩盘前最高价) - `details.previous_price`
- Bottom Price (崩盘时最低价) - `details.current_price`
- Price Change (价格变化) - `crashPercentage` (从 `details.price_change` 计算)
- Duration (持续时间) - 基于同一天警报数量估算

---

## 📍 数据显示位置

### black-swan 页面

#### 左侧面板
- **闪崩事件列表** ← `/api/alerts/crash-events`
  - 事件数量
  - 资产名称
  - 崩盘百分比
  - 日期
  - 持续时间

#### 中间面板
- **事件概览** ← 选中事件的数据
  - 资产名称 (`asset`)
  - 崩盘百分比 (`crashPercentage`)
  - 持续时间 (`duration`)
  - 描述 (`description`)
  
- **数据指标** ← 选中事件的 `details`
  - Peak Price (`details.previous_price`)
  - Bottom Price (`details.current_price`)
  - Price Change (`crashPercentage`)
  - Duration (`duration`)

#### 右侧面板（实时监控）
- **警报流** ← WebSocket 实时推送
  - 每条警报的详细信息
  
- **统计数据** ← `/api/alerts/stats`
  - Recent: 最近20条（显示在屏幕上的）
  - Critical: 严重警报数（最近20条中的）
  - Total: 总警报数（数据库中所有的）
  
- **系统状态** ← `/api/alerts/stats`
  - WS: WebSocket连接状态
  - Monitor: 监控状态（固定显示 ACTIVE）
  - Assets: 监控的资产数量（数据库中不同symbol的数量）

---

### black-swan-terminal 页面

#### 警报流
- **所有警报** ← `/api/alerts` + WebSocket
  - 启动时加载最近100条历史警报
  - 实时接收新警报

#### 统计面板
- **STATISTICS** ← 实时计算
  - Total Alerts: 当前显示的警报数
  - Critical/High/Medium: 按严重程度分组统计
  - Assets: 不同资产数量

- **SYSTEM STATUS** ← 实时监控
  - WebSocket: 连接状态
  - Monitoring: 监控状态
  - Uptime: 运行时间（前端计时）
  - CPU/Memory: 模拟数据（可以后续对接真实系统资源）

---

## 🔄 数据更新机制

### 实时数据
- **WebSocket推送**: 每2秒检查数据库新警报
- **自动重连**: 断线后5秒自动重连
- **无需刷新**: 新警报自动出现在界面

### 历史数据
- **页面加载时**: 自动获取一次
- **手动刷新**: 刷新浏览器页面重新加载

---

## 📊 数据真实性验证

### 如何验证数据是真实的？

#### 方法1：查看数据库
```bash
cd duolume-master
python check_btc_eth_alerts.py
```

#### 方法2：查看服务器日志
```bash
cd LUMI
npm run dev
# 观察启动日志
🦢 预警监控已启动，最后预警 ID: 123
```

#### 方法3：对比终端和数据库
```bash
# 在终端查询数据库
cd duolume-master
sqlite3 utils/database/app.db "SELECT COUNT(*) FROM alerts;"

# 对比页面显示的 Total 数字
# 应该一致
```

#### 方法4：实时生成测试
```bash
# 启动预警服务
cd duolume-master
python main.py

# 观察页面实时更新
# 新警报会立即显示
```

---

## 🎯 无模拟数据

### 已移除的模拟数据
- ❌ ~~硬编码的闪崩事件列表~~
- ❌ ~~固定的监控资产数量 (156)~~
- ❌ ~~固定的价格数据 ($68,000, $57,000)~~
- ❌ ~~固定的交易量增幅 (+340%)~~
- ❌ ~~固定的波动率 (89.2%)~~

### 现在使用的真实数据
- ✅ 从数据库查询的闪崩事件
- ✅ 实时计算的资产数量
- ✅ 事件详情中的真实价格
- ✅ 真实的价格变化百分比
- ✅ 基于警报数量估算的持续时间

---

## 💾 数据库结构

### alerts 表
```sql
CREATE TABLE alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  timestamp TEXT NOT NULL,
  symbol TEXT NOT NULL,
  message TEXT NOT NULL,
  severity TEXT NOT NULL,
  details TEXT,  -- JSON 格式
  type TEXT
);
```

### details 字段 (JSON)
```json
{
  "price_change": -0.0523,
  "current_price": 57000,
  "previous_price": 68000,
  "alert_type": "Price Jump",
  "volume_change": 3.4
}
```

---

## 🔧 自定义查询

### 扩展API端点

如果需要更多数据，可以在 `LUMI/server.js` 中添加新的端点：

```javascript
else if (req.url === '/api/alerts/custom') {
  // 添加自定义查询逻辑
  const db = new sqlite3.Database(dbFile);
  db.all('YOUR SQL QUERY', (err, rows) => {
    // 处理数据
    res.end(JSON.stringify({ success: true, data: rows }));
  });
}
```

---

## 📈 数据流程图

```
┌─────────────────────┐
│   Binance API       │  实时市场数据
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   main.py           │  检测器分析
│  - price_jump       │  - 价格波动
│  - whale_transfer   │  - 大额转账
│  - funding_spike    │  - 资金费率
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   SQLite DB         │  存储警报
│   alerts 表         │  - timestamp
│                     │  - symbol
│                     │  - severity
│                     │  - details
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   server.js         │  监控 + 推送
│  - 每2秒检查        │
│  - WebSocket推送    │
│  - REST API查询     │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   前端界面          │  显示数据
│  - black-swan       │  - 历史事件
│  - terminal         │  - 实时监控
└─────────────────────┘
```

---

## ✅ 总结

所有数据现在都是：
- ✅ **真实的** - 来自数据库和实时检测
- ✅ **动态的** - 自动更新，无需刷新
- ✅ **准确的** - 直接查询数据库
- ✅ **可验证的** - 可以对比数据库和界面

没有任何硬编码的模拟数据！

---

## 🚀 开始使用真实数据

```bash
# 1. 启动预警服务（生成真实数据）
cd duolume-master
python main.py

# 2. 启动LUMI（显示真实数据）
cd LUMI
npm run dev

# 3. 访问页面
http://localhost:3000/black-swan
http://localhost:3000/black-swan-terminal
```

所有显示的数据都是从 `duolume-master/utils/database/app.db` 读取的真实预警数据！




