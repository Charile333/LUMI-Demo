# WebSocket æ•…éšœæ’é™¤æŒ‡å—

## ğŸ” é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶ 1: `WebSocket é”™è¯¯: Event {isTrusted: true...}`

**å¯èƒ½åŸå› **ï¼š
1. æœåŠ¡å™¨æœªå¯åŠ¨
2. æœåŠ¡å™¨åˆšé‡å¯ï¼Œæµè§ˆå™¨é¡µé¢æœªåˆ·æ–°
3. æ•°æ®åº“è·¯å¾„é…ç½®é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### âœ… æ­¥éª¤ 1: ç¡®è®¤æœåŠ¡å™¨è¿è¡Œ
```powershell
# æ£€æŸ¥ç«¯å£ 3000 æ˜¯å¦åœ¨ç›‘å¬
Get-NetTCPConnection -LocalPort 3000 -State Listen
```

å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼š
```bash
cd LUMI
npm run dev
```

#### âœ… æ­¥éª¤ 2: ç¡¬åˆ·æ–°æµè§ˆå™¨
- Windows: `Ctrl + Shift + R` æˆ– `Ctrl + F5`
- Mac: `Cmd + Shift + R`

#### âœ… æ­¥éª¤ 3: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
1. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

---

### ç—‡çŠ¶ 2: `WebSocket connection to 'ws://localhost:3000/_next/webpack-hmr' failed`

**è¯´æ˜**: è¿™æ˜¯ Next.js çš„çƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰WebSocket é”™è¯¯ã€‚

**å½±å“**: ä¸å½±å“åº”ç”¨åŠŸèƒ½ï¼Œåªå½±å“å¼€å‘æ—¶çš„çƒ­æ›´æ–°ã€‚

**è§£å†³æ–¹æ¡ˆ**:

#### æ–¹æ³• A: å¿½ç•¥ï¼ˆæ¨èï¼‰
è¿™ä¸ªé”™è¯¯ä¸å½±å“å®æ—¶é¢„è­¦ç³»ç»Ÿï¼Œå¯ä»¥å®‰å…¨å¿½ç•¥ã€‚

#### æ–¹æ³• B: é‡å¯æœåŠ¡å™¨
```bash
# åœæ­¢æœåŠ¡å™¨ (Ctrl+C)
# ç„¶åé‡æ–°å¯åŠ¨
npm run dev
```

#### æ–¹æ³• C: ä¿®æ”¹ Next.js é…ç½®
åœ¨ `next.config.js` ä¸­æ·»åŠ ï¼š
```javascript
module.exports = {
  // ... å…¶ä»–é…ç½®
  webpack: (config, { dev }) => {
    if (dev) {
      config.watchOptions = {
        poll: 1000,
        aggregateTimeout: 300,
      }
    }
    return config
  }
}
```

---

## ğŸ§ª æµ‹è¯• WebSocket è¿æ¥

### æ–¹æ³• 1: æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•

åœ¨ http://localhost:3000/black-swan é¡µé¢æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œè¿è¡Œï¼š

```javascript
// æ£€æŸ¥ WebSocket çŠ¶æ€
console.log('WebSocket çŠ¶æ€:', window.ws ? window.ws.readyState : 'æœªåˆå§‹åŒ–');

// çŠ¶æ€å€¼è¯´æ˜ï¼š
// 0 = CONNECTING (è¿æ¥ä¸­)
// 1 = OPEN (å·²è¿æ¥)
// 2 = CLOSING (å…³é—­ä¸­)
// 3 = CLOSED (å·²å…³é—­)

// å¦‚æœæ˜¯ 1ï¼Œè¯´æ˜è¿æ¥æ­£å¸¸
if (window.ws && window.ws.readyState === 1) {
  console.log('âœ… WebSocket è¿æ¥æ­£å¸¸ï¼');
} else {
  console.log('âŒ WebSocket æœªè¿æ¥');
}
```

### æ–¹æ³• 2: ä½¿ç”¨åœ¨çº¿å·¥å…·æµ‹è¯•

è®¿é—®ï¼šhttps://www.websocket.org/echo.html

è¾“å…¥ï¼š`ws://localhost:3000/ws/alerts`

ç‚¹å‡» "Connect"ï¼Œåº”è¯¥çœ‹åˆ°è¿æ¥æˆåŠŸçš„æ¶ˆæ¯ã€‚

### æ–¹æ³• 3: ä½¿ç”¨ Node.js è„šæœ¬æµ‹è¯•

åˆ›å»º `test-websocket.js`ï¼š
```javascript
const WebSocket = require('ws');

const ws = new WebSocket('ws://localhost:3000/ws/alerts');

ws.on('open', () => {
  console.log('âœ… WebSocket è¿æ¥æˆåŠŸï¼');
});

ws.on('message', (data) => {
  console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', data.toString());
});

ws.on('error', (error) => {
  console.error('âŒ WebSocket é”™è¯¯:', error.message);
});

ws.on('close', () => {
  console.log('ğŸ”Œ WebSocket å·²æ–­å¼€');
});

// 10ç§’åå…³é—­è¿æ¥
setTimeout(() => {
  ws.close();
  process.exit(0);
}, 10000);
```

è¿è¡Œï¼š
```bash
node test-websocket.js
```

---

## ğŸ”§ å®Œæ•´é‡ç½®æ­¥éª¤

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸è¡Œï¼Œæ‰§è¡Œå®Œæ•´é‡ç½®ï¼š

### 1. åœæ­¢æ‰€æœ‰ Node è¿›ç¨‹
```powershell
Get-Process -Name node | Stop-Process -Force
```

### 2. æ¸…ç†ä¾èµ–
```bash
cd LUMI
rm -rf node_modules
rm package-lock.json
```

### 3. é‡æ–°å®‰è£…
```bash
npm install
```

### 4. é‡å¯æœåŠ¡å™¨
```bash
npm run dev
```

### 5. æ¸…é™¤æµè§ˆå™¨
- æ¸…ç©ºæ‰€æœ‰æµè§ˆå™¨ç¼“å­˜
- å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ
- é‡æ–°æ‰“å¼€æµè§ˆå™¨
- è®¿é—® http://localhost:3000/black-swan

---

## ğŸ“Š æ­£å¸¸è¿è¡Œçš„æ ‡å¿—

### æœåŠ¡å™¨æ—¥å¿—åº”æ˜¾ç¤ºï¼š
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ æœåŠ¡å™¨å·²å¯åŠ¨
ğŸ“ åœ°å€: http://localhost:3000
ğŸ”Œ Socket.IO: ws://localhost:3000
ğŸ¦¢ Alert WebSocket: ws://localhost:3000/ws/alerts
ğŸŒ ç¯å¢ƒ: development
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¦¢ åˆå§‹åŒ–è­¦æŠ¥ç›‘è§†å™¨ã€‚æœ€æ–°è­¦æŠ¥ID: XXX
```

### æµè§ˆå™¨æ§åˆ¶å°åº”æ˜¾ç¤ºï¼š
```
âœ… å·²è¿æ¥åˆ°é¢„è­¦ç³»ç»Ÿ
```

### æ’å…¥æµ‹è¯•é¢„è­¦åï¼š
```
ğŸ¦¢ å¹¿æ’­è­¦æŠ¥åˆ° X ä¸ªå®¢æˆ·ç«¯
```

---

## ğŸ› å¸¸è§é”™è¯¯ä»£ç 

| é”™è¯¯ä»£ç  | å«ä¹‰ | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `ECONNREFUSED` | è¿æ¥è¢«æ‹’ç» | æœåŠ¡å™¨æœªå¯åŠ¨ |
| `ETIMEDOUT` | è¿æ¥è¶…æ—¶ | é˜²ç«å¢™é˜»æ­¢æˆ–ç½‘ç»œé—®é¢˜ |
| `EADDRINUSE` | ç«¯å£å·²è¢«å ç”¨ | æ›´æ”¹ç«¯å£æˆ–å…³é—­å ç”¨è¿›ç¨‹ |
| `ERR_BLOCKED_BY_CLIENT` | è¢«æµè§ˆå™¨æ‰©å±•é˜»æ­¢ | ç¦ç”¨å¹¿å‘Šæ‹¦æˆªå™¨ |

---

## ğŸ“± ç§»åŠ¨è®¾å¤‡æµ‹è¯•

å¦‚æœè¦åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæµ‹è¯•ï¼š

1. è·å–æœ¬æœº IPï¼š
```powershell
ipconfig | findstr IPv4
```

2. ä¿®æ”¹ WebSocket URLï¼š
```javascript
// åœ¨ black-swan/page.tsx ä¸­
const wsUrl = `ws://192.168.x.x:3000/ws/alerts`;
```

3. ç¡®ä¿é˜²ç«å¢™å…è®¸ç«¯å£ 3000

---

## ğŸ†˜ ç»ˆæè§£å†³æ–¹æ¡ˆ

å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š

### 1. ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨
```bash
# ä½¿ç”¨ server.js è€Œä¸æ˜¯ server-with-websocket.js
npm run dev:old
```

### 2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
```powershell
# Windows äº‹ä»¶æŸ¥çœ‹å™¨
eventvwr.msc
```

### 3. æ£€æŸ¥ Node.js ç‰ˆæœ¬
```bash
node --version
# æ¨è: v18.x æˆ– v20.x
```

### 4. é‡å¯è®¡ç®—æœº
æœ‰æ—¶å€™ç³»ç»Ÿèµ„æºæ²¡æœ‰æ­£ç¡®é‡Šæ”¾ï¼Œé‡å¯å¯ä»¥è§£å†³é—®é¢˜ã€‚

---

## âœ… éªŒè¯æ¸…å•

- [ ] æœåŠ¡å™¨åœ¨ç«¯å£ 3000 ä¸Šè¿è¡Œ
- [ ] æµè§ˆå™¨æ˜¾ç¤º"å·²è¿æ¥åˆ°é¢„è­¦ç³»ç»Ÿ"
- [ ] è¿è¡Œ `test-alert.js` åèƒ½çœ‹åˆ°æ–°é¢„è­¦
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ²¡æœ‰ WebSocket é”™è¯¯ï¼ˆé™¤äº† HMRï¼‰
- [ ] æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ï¼š`database/alerts.db`
- [ ] Node ç‰ˆæœ¬ >= 16.x

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼š

1. **å¤åˆ¶å®Œæ•´é”™è¯¯ä¿¡æ¯**
   - æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Console æ ‡ç­¾ï¼‰
   - æœåŠ¡å™¨ç»ˆç«¯è¾“å‡º
   - é”™è¯¯æˆªå›¾

2. **æä¾›ç³»ç»Ÿä¿¡æ¯**
   ```bash
   node --version
   npm --version
   ```

3. **æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§**
   ```bash
   # ç¡®è®¤å…³é”®æ–‡ä»¶å­˜åœ¨
   ls server-with-websocket.js
   ls database/alerts.db
   ls test-alert.js
   ```

---

**æœ€åæ›´æ–°**: 2025-10-26
**çŠ¶æ€**: âœ… WebSocket ç³»ç»Ÿå·²ä¿®å¤å¹¶æ­£å¸¸å·¥ä½œ


