# ⚡ 快速参考：三大组件何时使用

---

## 📋 简单回答

### ❌ 不需要在市场列表页面调用区块链！

**原因**:
- 数据库查询 < 100ms ⚡
- 区块链查询 > 1000ms 🐌
- 100个市场 = 100秒 vs 0.1秒

---

## 🎯 何时使用三大组件

### 1️⃣ Conditional Tokens（条件代币）

```
✅ 创建市场时 (1次)
   └─ adapter.initialize()

✅ 结算市场时 (1次)
   └─ adapter.resolve()

❌ 不在列表页
❌ 不在浏览时
❌ 不在交易时
```

**使用频率**: 每个市场生命周期 **2次**

---

### 2️⃣ CTF Exchange（交易所）

```
✅ 后台批量结算订单时
   └─ exchange.fillOrders()
   └─ 每5分钟执行一次

❌ 不在下单时
❌ 不在列表页
❌ 不在浏览时
```

**使用频率**: 后台自动，**用户不感知**

---

### 3️⃣ UMA Oracle（预言机）

```
✅ 市场到期后结算时 (2-3次)
   └─ 1. 请求价格
   └─ 2. 提案答案
   └─ 3. 争议/投票（可选）

❌ 不在列表页
❌ 不在浏览时
❌ 不在交易时
```

**使用频率**: 每个市场生命周期 **2-3次**

---

## 🔄 实际数据流程

### 场景 1: 用户浏览100个市场

```
┌──────────────────┐
│ 用户打开市场页面 │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 读取 Supabase    │  ⚡ 100ms
│ SELECT * FROM    │
│ markets LIMIT 100│
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 显示市场列表     │
└──────────────────┘

❌ 不调用任何区块链组件
✅ 速度快，用户体验好
```

---

### 场景 2: 管理员创建市场

```
┌──────────────────┐
│ 管理员填写表单   │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 1. 保存到        │
│    Supabase      │  ⚡ 50ms
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 2. 调用适配器    │
│ ✅ Conditional   │  🐌 5秒
│    Tokens        │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 3. 更新状态      │
│    已激活        │  ⚡ 50ms
└──────────────────┘

总耗时：~5秒
调用次数：1次 Conditional Tokens
```

---

### 场景 3: 用户下单买入

```
┌──────────────────┐
│ 用户点击"买入"   │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 1. 本地签名      │
│ EIP-712          │  ⚡ 1秒
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 2. 保存订单到    │
│    Supabase      │  ⚡ 50ms
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 3. 显示"待结算"  │
└────────┬─────────┘
         │
         ↓ (5分钟后)
┌──────────────────┐
│ 4. 后台批量结算  │
│ ✅ CTF Exchange  │  🐌 5秒/批
└──────────────────┘

用户感知：~1秒 ✅
实际结算：后台自动
调用次数：0次（用户），批量调用（后台）
```

---

### 场景 4: 市场结算

```
┌──────────────────┐
│ 市场到期         │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 1. 请求UMA预言机 │
│ ✅ UMA Oracle    │  🐌 5秒
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 2. 等待2小时     │
│ (挑战期)         │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 3. 获取结果      │
│ ✅ UMA Oracle    │  🐌 5秒
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 4. 报告结果      │
│ ✅ Conditional   │  🐌 5秒
│    Tokens        │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│ 5. 更新数据库    │
│    已结算        │  ⚡ 50ms
└──────────────────┘

总耗时：~2小时15秒
调用次数：2次 UMA + 1次 Conditional Tokens
```

---

## 📊 数据来源决策树

```
需要显示什么数据？
│
├─ 市场列表？
│  └─ ✅ Supabase (markets表)
│     不调用区块链
│
├─ 市场详情？
│  └─ ✅ Supabase (markets表)
│     可选：缓存的区块链数据
│
├─ 实时价格？
│  └─ ✅ Supabase (orders表 + WebSocket)
│     不直接调用区块链
│
├─ 用户下单？
│  └─ ✅ 本地签名 + Supabase
│     不调用区块链
│
├─ 创建市场？
│  └─ ✅ Supabase + Conditional Tokens
│     调用1次区块链
│
└─ 市场结算？
   └─ ✅ UMA Oracle + Conditional Tokens
      调用2-3次区块链
```

---

## 🎯 关键原则

### 1. 数据库优先
```typescript
// ✅ 正确
const markets = await supabase.from('markets').select('*');

// ❌ 错误（在列表页）
const markets = await adapter.getMarketList();
```

### 2. 异步后台
```typescript
// ✅ 正确：后台同步
setInterval(async () => {
  const onChainData = await adapter.getMarkets();
  await supabase.from('markets').upsert(onChainData);
}, 5 * 60 * 1000); // 每5分钟

// ❌ 错误：每次浏览都同步
useEffect(() => {
  const onChainData = await adapter.getMarkets(); // 慢！
}, []);
```

### 3. 批量操作
```typescript
// ✅ 正确：批量结算20笔
await exchange.fillOrders(orders, signatures, amounts);

// ❌ 错误：逐个结算
for (const order of orders) {
  await exchange.fillOrder(order); // 很慢！
}
```

---

## ✅ 总结

### 一句话回答

**不需要在每个市场列表页面都调用区块链！**

只在以下情况调用：
1. 创建市场（1次 Conditional Tokens）
2. 结算订单（后台批量 CTF Exchange）
3. 市场到期（2-3次 UMA Oracle + Conditional Tokens）

其他时候都从 Supabase 读取！

---

## 📚 详细文档

- `LUMI_组件使用架构图.md` - 完整架构说明
- `LUMI_实际优化建议.md` - 具体优化方案
- `三大官方组件使用指南.md` - 组件使用指南

---

**记住**: 数据库快 ⚡，区块链慢 🐌，优先用数据库！



